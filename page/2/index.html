<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
        
      <meta name="description" content="Hello,here is kengkeng&#39;s blog." />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title> kengkeng&#39;s life</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dajiangdahe.github.io/dist/main.css">

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css"
      />
      
<link rel="stylesheet" href="/dajiangdahe.github.io/css/custom.css">
 
      <script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    </head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      
<section class="cover">
    
      
      <a class="forkMe" href="https://github.com/Shen-Yu/hexo-theme-ayer"
        target="_blank"><img width="149" height="149" src="/dajiangdahe.github.io/images/forkme.png"
          class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1"></a>
    
  <div class="cover-frame">
    <div class="bg-box">
      <img src="/images/cover1.jpg" alt="image frame" />
    </div>
    <div class="cover-inner text-center text-white">
      <h1><a href="/dajiangdahe.github.io/">kengkeng&#39;s life</a></h1>
      <div id="subtitle-box">
        
        <span id="subtitle"></span>
        
      </div>
      <div>
        
      </div>
    </div>
  </div>
  <div class="cover-learn-more">
    <a href="javascript:void(0)" class="anchor"><i class="ri-arrow-down-line"></i></a>
  </div>
</section>



<script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js"></script>


<!-- Subtitle -->

  <script>
    try {
      var typed = new Typed("#subtitle", {
        strings: ['面朝大海，春暖花开', '愿你一生努力，一生被爱', '想要的都拥有，得不到的都释怀'],
        startDelay: 0,
        typeSpeed: 200,
        loop: true,
        backSpeed: 100,
        showCursor: true
      });
    } catch (err) {
      console.log(err)
    }
  </script>
  
<div id="main">
  <section class="outer">
  
  <ul class="ads">
    
        <li>
            <a target="_blank" rel="noopener" href="https://curl.qcloud.com/kvO7hb43">
                <img src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/ten_1.jpg" width="300" alt="云服务器限时秒杀">
            </a>
        </li>
    
        <li>
            <a target="_blank" rel="noopener" href="https://www.vultr.com/?ref=8630075">
                <img src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/vultr.png" width="300" alt="vultr优惠vps">
            </a>
        </li>
    
</ul>
  
  
  

<div class="notice" style="margin-top:50px">
    <i class="ri-heart-fill"></i>
    <div class="notice-content" id="broad"></div>
</div>
<script type="text/javascript">
    fetch('https://v1.hitokoto.cn')
        .then(response => response.json())
        .then(data => {
            document.getElementById("broad").innerHTML = data.hitokoto;
        })
        .catch(console.error)
</script>

<style>
    .notice {
        padding: 20px;
        border: 1px dashed #e6e6e6;
        color: #969696;
        position: relative;
        display: inline-block;
        width: 100%;
        background: #fbfbfb50;
        border-radius: 10px;
    }

    .notice i {
        float: left;
        color: #999;
        font-size: 16px;
        padding-right: 10px;
        vertical-align: middle;
        margin-top: -2px;
    }

    .notice-content {
        display: initial;
        vertical-align: middle;
    }
</style>
  
  <article class="articles">
    
    
    
    
    <article
  id="post-zookeeper从入门到放弃"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/"
    >Zookeeper从入门到放弃</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/" class="article-date">
  <time datetime="2021-10-23T13:55:41.146Z" itemprop="datePublished">2021-10-23</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/dajiangdahe.github.io/categories/Zookeeper/">Zookeeper</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <hr>
<h1>1. zookeeper入门</h1>
<h2 id="1-1-概述">1.1 概述</h2>
<p>zookeeper是一个开源的分布式的，为分布式框架提<strong>供协调服务</strong>的Apache项目</p>
<h2 id="1-2-工作机制">1.2 工作机制</h2>
<p>Zookeeper从设计模式角度来理解：是一个<strong>基于观察者模式</strong>设计的分布式服务管理框架，它<strong>负责存储和管理</strong>大家都关心的数据，然后<strong>接受观察者的注册</strong>， 一旦这些数据的状态发生变化，Zookeeper 就将<strong>负责通知已经在Zookeeper上注册的那些观察者</strong>做出相应的反应。</p>
<ol>
<li>基于观察者模式设计的框架</li>
<li>负责存储和管理的数据</li>
<li>接受观察者（服务）的注册</li>
<li>负责通知已经在zookeeper上注册的观察者（服务）</li>
</ol>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211023222918327.png" class="" title="image-20211023222918327">
<ol>
<li>服务端启动时去注册信息（创建都是临时节点）</li>
<li>客户端从zookeeper获取当前在线服务器列表，并且注册监听</li>
<li>if 服务器节点下线</li>
<li>zookeeper通知客户端服务器节点上下线</li>
<li>客户端再次获取在线服务器列表，并注册监听</li>
</ol>
<h2 id="1-3-zookeeper特点">1.3 zookeeper特点</h2>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211023223955588.png" class="" title="image-20211023223955588">
<ol>
<li>Zookeeper：<strong>一个领导者</strong>（Leader），<strong>多个跟随者</strong>（Follower）组成的集群。</li>
<li>集群中只要有<strong>半数以上节点存活</strong>，Zookeeper集群就能正常服务。所以Zookeeper适合<strong>安装奇数台服务器</strong>。</li>
<li>全局数据一致：每个<strong>Server保存一份相同的数据副本</strong>，Client无论连接到哪个Server，数据都是一致的。</li>
<li><strong>更新请求顺序执行</strong>，来自同一个Client的更新请求按其发送顺序依次执行。</li>
<li>单一Client 数<strong>据更新原子性</strong>，一次数据更新要么成功，要么失败。</li>
<li><strong>实时性</strong>，在一定时间范围内，Client能读到最新数据。</li>
</ol>
<h2 id="1-4-数据结构">1.4 数据结构</h2>
<p>ZooKeeper 数据模型的结构与 Unix 文件系统很类似，整体上可以看作是<strong>一棵树</strong>，每个 节点称做一个 <strong>ZNode</strong>。每一个 ZNode 默认能够<strong>存储 1MB</strong> 的数据，每个 ZNode 都可以通<strong>过其路径唯一标识</strong>。</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211023224426987.png" class="" title="image-20211023224426987">
<h2 id="1-5-应用场景">1.5 应用场景</h2>
<ol>
<li>
<p><strong>统一命名服务</strong></p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211023224814675.png" class="" title="image-20211023224814675">
</li>
<li>
<p><strong>统一配置管理</strong></p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211023225045932.png" class="" title="image-20211023225045932">
</li>
<li>
<p><strong>统一集群管理</strong></p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211023225313620.png" class="" title="image-20211023225313620">
</li>
<li>
<p><strong>服务器节点动态上下线</strong></p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211023225524570.png" class="" title="image-20211023225524570">
</li>
<li>
<p><strong>软负载均衡</strong></p>
</li>
</ol>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211023225737241.png" class="" title="image-20211023225737241">
<h1>2. zookeeper安装</h1>
<h2 id="2-1-本地安装以及目录解读">2.1 本地安装以及目录解读</h2>
<p><strong>zookeeper目录</strong></p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211023232208355.png" class="" title="image-20211023232208355">
<p><strong>zookeeper/bin 目录结构</strong></p>
<p>其中<strong><a target="_blank" rel="noopener" href="http://zkCli.sh">zkCli.sh</a></strong> 是作为客户端启动</p>
<p>其中<strong><a target="_blank" rel="noopener" href="http://zkServer.sh">zkServer.sh</a></strong> 是作为服务端启动</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211023232835716.png" class="" title="image-20211023232835716">
<p><strong>zookeeper/conf 目录结构</strong></p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211023233200810.png" class="" title="image-20211023233200810">
<p>其中 <strong>zoo_sample.cfg</strong> 是zookeeper配置文件，是示例配置文件，本套课程中修改为zoo.cfg。</p>
<p>由于/tmp为Linux临时储存地址（会被清理清理），所以将其默认dataDir地址改成自己新建的zkData文件夹下。</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211025095457555.png" class="" title="image-20211025095457555">
<p>一般我们将zookeeper的数据文件放到<strong>zookeeper/zkData</strong>下</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211025095409917.png" class="" title="image-20211025095409917">
<p>启动时</p>
<ul>
<li>先启动zkServer</li>
<li>在启动zkclient</li>
</ul>
<h2 id="2-2-参数配置解析">2.2 参数配置解析</h2>
<p>1）<strong>tickTime = 2000</strong>：通信心跳时间，Zookeeper服务器与客户端心跳时间，单位毫秒</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211023235631976.png" class="" title="image-20211023235631976">
<p>2）<strong>initLimit = 10</strong>：LF初始通信时限</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211023235701539.png" class="" title="image-20211023235701539">
<p>3）<strong>syncLimit = 5</strong>：LF同步通信时限</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211023235734230.png" class="" title="image-20211023235734230">
<p>4）<strong>dataDir</strong>：保存Zookeeper中的数据 注意：<strong>默认的tmp目录，容易被Linux系统定期删除</strong>，所以一般不用默认的tmp目录。</p>
<p>5）<strong>clientPort = 2181</strong>：客户端连接端口，通常不做修改。</p>
<h1>3. zookeeper集群操作</h1>
<h2 id="3-1-服务器集群配置">3.1 服务器集群配置</h2>
<ol>
<li>
<p>在/opt/module/zookeeper-3.5.7/zkData 目录下创建一个 myid 的文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">vi myid<br></code></pre></td></tr></table></figure>
</li>
<li>
<p>在文件中添加与 server 对应的编号（注意：上下不要有空行，左右不要有空格）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">2<br></code></pre></td></tr></table></figure>
</li>
<li>
<p>拷贝配置好的 zookeeper 到其他机器上</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">xsync zookeeper-3.5.7<br></code></pre></td></tr></table></figure>
<p>分别在其他服务器上，进行server编号更改（3，4）</p>
</li>
<li>
<p>在zoo.cfg配置文件下进行集群配置</p>
<figure class="highlight plaintext"><figcaption><span>l</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs she">#######################cluster##########################<br>server.2=hadoop102:2888:3888<br>server.3=hadoop103:2888:3888<br>server.4=hadoop104:2888:3888<br></code></pre></td></tr></table></figure>
<p>配置解读 <strong>server.A=B:C:D</strong></p>
<ul>
<li>其中A数字表示第几台服务器。<strong>集群模式下配置一个文件 myid，这个文件在 dataDir目录下，这个文件里面有一个数据就是 A 的值，Zookeeper 启动时读取此文件，拿到里面的数据与 zoo.cfg 里面的配置信息比较从而判断到底是哪个 server。</strong></li>
<li>B是这个服务器的地址</li>
<li>C是这个服务器Follower与集群中Leader 服务器交换信息的端口</li>
<li>D是万一这个集群中的Leader挂了，需要一个端口进行重新选举，这个端口就是用来执行选举时，实现服务器之间消息互通的端口</li>
</ul>
</li>
<li>
<p>分发配置完成后（xsync命令），启动服务器，<strong>bin/zkServer.sh start</strong></p>
<ul>
<li>
<p><strong>注意1：客户端命令行末尾没有start</strong></p>
</li>
<li>
<p><strong>注意2：如果在启动服务器集群时，并没有start数量超过半数，则会报error错误，不符合集群工作的原理（有半数以上节点启动 ，集群才开始工作）</strong></p>
</li>
</ul>
</li>
</ol>
<h2 id="3-2-选举机制">3.2 选举机制</h2>
<h3 id="3-2-1-zookeeper集群第一次启动时">3.2.1 zookeeper集群第一次启动时</h3>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211025102232854.png" class="" title="image-20211025102232854">
<ul>
<li>总结：一般来说，第一次启动时，leader为server编号（start+end）/2。</li>
</ul>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211025103218805.png" class="" title="image-20211025103218805">
<ul>
<li>客户端对于集群的写操作，主要通过是三个ID号来标志访问的节点，分别是SID、ZXID、Epoch。</li>
</ul>
<h3 id="3-2-2-zookeeper集群非第一次启动时">3.2.2 zookeeper集群非第一次启动时</h3>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211025104410548.png" class="" title="image-20211025104410548">
<h2 id="3-3-客户端命令行操作">3.3 客户端命令行操作</h2>
<h3 id="3-3-1-启动客户端和znode参数信息">3.3.1 启动客户端和znode参数信息</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">bin/zkCli.sh --server name:xxxx //此方式可以指定服务器等名字<br></code></pre></td></tr></table></figure>

<ol>
<li>czxid：**创建节点的事务  zxid每次修改 ZooKeeper 状态都会产生一个 ZooKeeper 事务 ID。**事务 ID 是 ZooKeeper 中所 有修改总的次序。每次修改都有唯一的 zxid，如果 zxid1 小于 zxid2，那么 zxid1 在 zxid2 之 前发生。</li>
<li>ctime：znode 被<strong>创建</strong>的毫秒数（从 1970 年开始）</li>
<li>mzxid：znode 最后<strong>更新</strong>的事务 zxid</li>
<li>mtime：znode 最后<strong>修改</strong>的毫秒数（从 1970 年开始）</li>
<li>pZxid：znode 最后<strong>更新的子节点</strong> zxid</li>
<li>cversion：znode 子节点变化号，znode 子节点<strong>修改次数</strong></li>
<li>dataversion：znode <strong>数据变化号</strong></li>
<li>aclVersion：znode 访问<strong>控制列表的变化号</strong></li>
<li>ephemeralOwner：如果是<strong>临时节点</strong>，这个是  znode 拥有者的 session id。如果不是临时节点则是 0。</li>
<li>dataLength：znode 的<strong>数据长度</strong></li>
<li>numChildren：znode <strong>子节点数量</strong></li>
</ol>
<h3 id="3-3-2-znode节点类型">3.3.2 znode节点类型</h3>
<ol>
<li>
<p>持久节点：当客户端与服务器断开链接时，创建的节点不会被删除</p>
<ol>
<li>持久节点不带顺序编号</li>
<li>持久节点带顺序编号，只是zookeeper会给该节点进行编号而已，顺序号由父节点维护</li>
</ol>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211026214405461.png" class="" title="image-20211026214405461">
</li>
<li>
<p>短暂节点：当客户端与服务器断开连接时，创建的节点会自己删除</p>
<ol>
<li>临时节点不带顺序编号</li>
<li>临时节点带顺序编号，只是zookeeper会给该节点进行编号而已</li>
</ol>
</li>
<li>
<p>带序号节点 vs 不带序号节点</p>
<ol>
<li>不带序号节点只可以创建一个，带序号节点可以创建多个+序列号</li>
</ol>
</li>
</ol>
<h4 id="3-3-2-1-创建永久节点">3.3.2.1 创建永久节点</h4>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211026214711434.png" class="" title="image-20211026214711434">
<h4 id="3-3-2-2-获取节点值与其属性">3.3.2.2 获取节点值与其属性</h4>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211026214817531.png" class="" title="image-20211026214817531">
<h4 id="3-3-2-3-创建持久带序号的节点">3.3.2.3 创建持久带序号的节点</h4>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211026215051736.png" class="" title="image-20211026215051736">
<h4 id="3-3-2-4-创建短暂节点">3.3.2.4 创建短暂节点</h4>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211026215720659.png" class="" title="image-20211026215720659">
<h4 id="3-3-2-5-创建短暂带序号节点">3.3.2.5 创建短暂带序号节点</h4>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211026215806271.png" class="" title="image-20211026215806271">
<h4 id="3-3-2-6-修改节点">3.3.2.6 修改节点</h4>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211026215848192.png" class="" title="image-20211026215848192">
<h3 id="3-3-4-监听器原理">3.3.4 监听器原理</h3>
<p>客户端注册监听它关心的目录节点，当目录节点发生变化（数据改变、节点删除、子目 录节点增加删除）时，ZooKeeper 会通知客户端。监听机制保证 ZooKeeper 保存的任何的数 据的任何改变都能快速的响应到监听了该节点的应用程序。</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211026220152902.png" class="" title="image-20211026220152902">
<h4 id="3-3-4-1-节点的值变化监听">3.3.4.1 节点的值变化监听</h4>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211026220610359.png" class="" title="image-20211026220610359">
<h4 id="3-3-4-2-节点的子节点变化监听">3.3.4.2 节点的子节点变化监听</h4>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211026220849104.png" class="" title="image-20211026220849104">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211026220910133.png" class="" title="image-20211026220910133">
<h4 id="3-3-4-3-节点的删除与查看">3.3.4.3 节点的删除与查看</h4>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211026221008642.png" class="" title="image-20211026221008642">
<h3 id="3-3-5-客户端API操作">3.3.5 客户端API操作</h3>
<h4 id="3-3-5-1-初始化zookeeper">3.3.5.1 初始化zookeeper</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 初始化</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@throws</span> IOException ioexception</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@Before</span><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>       <span class="hljs-comment">//string多台服务器地址之间不允许有空格</span><br>       String coonectString = <span class="hljs-string">&quot;hadoop102:2181,hadoop103:2181,hadoop104:2181&quot;</span>;<br>       <span class="hljs-keyword">int</span> sessionTimeout = <span class="hljs-number">2000</span>;<br>       zkClient = <span class="hljs-keyword">new</span> ZooKeeper(coonectString, sessionTimeout, <span class="hljs-keyword">new</span> Watcher() &#123;<br>           <span class="hljs-comment">/**</span><br><span class="hljs-comment">            * 这是监听线程，观察服务器集群中是否有新的节点变化</span><br><span class="hljs-comment">            *</span><br><span class="hljs-comment">            * <span class="hljs-doctag">@param</span> watchedEvent 关注的事件</span><br><span class="hljs-comment">            */</span><br>           <span class="hljs-meta">@Override</span><br>           <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">process</span><span class="hljs-params">(WatchedEvent watchedEvent)</span> </span>&#123;<br>               List&lt;String&gt; children = <span class="hljs-keyword">null</span>;<br>               <span class="hljs-keyword">try</span> &#123;<br>                   children = zkClient.getChildren(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-keyword">true</span>);<br>               &#125; <span class="hljs-keyword">catch</span> (KeeperException e) &#123;<br>                   e.printStackTrace();<br>               &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                   e.printStackTrace();<br>               &#125;<br>               <span class="hljs-keyword">for</span> (String child : children) &#123;<br>                   System.out.println(<span class="hljs-string">&quot;子节点：&quot;</span> + child);<br>               &#125;<br>           &#125;<br>       &#125;);<br>   &#125;<br></code></pre></td></tr></table></figure>
<h4 id="3-3-5-2-创建节点">3.3.5.2 创建节点</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建节点</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">create</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, KeeperException </span>&#123;<br>        String nodeCreated = zkClient.create(<span class="hljs-string">&quot;/atguigu&quot;</span>, <span class="hljs-string">&quot;ss.avi&quot;</span>.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);<br>    &#125;<br></code></pre></td></tr></table></figure>
<h4 id="3-3-5-3-查询子节点">3.3.5.3 查询子节点</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 监听子节点</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@Test</span><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getChildNode</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, KeeperException </span>&#123;<br>       List&lt;String&gt; children = zkClient.getChildren(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-keyword">true</span>);<br>       <span class="hljs-keyword">for</span> (String child : children) &#123;<br>           System.out.println(<span class="hljs-string">&quot;子节点：&quot;</span> + child);<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure>
<h4 id="3-3-5-4-判断节点是否存在">3.3.5.4 判断节点是否存在</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 判断节点是否存在</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@Test</span><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exist</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, KeeperException </span>&#123;<br>       Stat stat = zkClient.exists(<span class="hljs-string">&quot;/atguigu&quot;</span>, <span class="hljs-keyword">false</span>);<br>       System.out.println(stat == <span class="hljs-keyword">null</span> ? <span class="hljs-string">&quot;not exist&quot;</span> : <span class="hljs-string">&quot;exist&quot;</span>);<br>   &#125;<br></code></pre></td></tr></table></figure>
<h2 id="3-4-客户端向服务器端写数据流程">3.4 客户端向服务器端写数据流程</h2>
<ol>
<li>
<p><strong>向leader节点写数据流程</strong></p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211026225528071.png" class="" title="image-20211026225528071">
<p>实际上当服务器集群中<strong>超过半数的节点</strong>完成write操作，就由leader返回ack通知</p>
</li>
<li>
<p><strong>向follower节点写数据流程</strong></p>
</li>
</ol>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211026225541675.png" class="" title="image-20211026225541675">
<p>​	当数据流向follower时，<strong>follower不会先进行write操作，而是先进行write请求转发到leader</strong>，再由leader进行write请求分发，可谓等级森严。<strong>当流向follower完成write操作时，返回ack给client，而不是由leader返回。</strong></p>
<h1>4. 服务器动态上下线监听案例</h1>
<h2 id="4-1-需求">4.1 需求</h2>
<p>在分布式系统中，主节点可以用多台，可以动态上下线，任意一台客户端都能实时感受到主节点服务器的上下线</p>
<h2 id="4-2-需求分析">4.2 需求分析</h2>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211027094852005.png" class="" title="image-20211027094852005">
<p>zookeeper集群中 主要分两大类，一类是服务器，一类是客户端，服务器主要用作create节点，客户端主要用作get节点。</p>
<h2 id="4-3-具体代码">4.3 具体代码</h2>
<ol>
<li>
<p>在服务器集群中 create /server “servers”</p>
</li>
<li>
<p>服务器端向zookeeper注册代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> bjut.kengkeng.test;<br><br><span class="hljs-keyword">import</span> org.apache.zookeeper.*;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 分发服务器</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> guolonghang</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2021-10-27</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DistributeServer</span> </span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * zk服务器</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> ZooKeeper zkServer;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 会话超时</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> sessionTimeout;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 连接地址</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String connString;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 主方法</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> args arg游戏</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException          ioexception</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> InterruptedException 中断异常</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> KeeperException      门将例外</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, InterruptedException, KeeperException </span>&#123;<br><br>        DistributeServer server = <span class="hljs-keyword">new</span> DistributeServer();<br>        <span class="hljs-comment">//1.获取zk集群</span><br>        server.getConnect();<br>        <span class="hljs-comment">//2.注册服务器到集群中</span><br>        server.registry(args[<span class="hljs-number">0</span>]);<br>        <span class="hljs-comment">//3.启动业务</span><br>        server.business();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 业务</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> InterruptedException 中断异常</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">business</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        Thread.sleep(<span class="hljs-number">1000</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 注册</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> hostname 主机名</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> InterruptedException 中断异常</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> KeeperException      门将例外</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registry</span><span class="hljs-params">(String hostname)</span> <span class="hljs-keyword">throws</span> InterruptedException, KeeperException </span>&#123;<br>			String path = <span class="hljs-string">&quot;/servers/&quot;</span>+hostname;<br>      String status = zkServer.create(path, hostname.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);<br>        System.out.println(status);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获得连接</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException ioexception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getConnect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        connString = <span class="hljs-string">&quot;&quot;</span>;<br>        sessionTimeout = <span class="hljs-number">0</span>;<br>        zkServer = <span class="hljs-keyword">new</span> ZooKeeper(connString, sessionTimeout, <span class="hljs-keyword">new</span> Watcher() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">process</span><span class="hljs-params">(WatchedEvent watchedEvent)</span> </span>&#123;<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>
</li>
<li>
<p>客户端代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> bjut.kengkeng.test;<br><br><span class="hljs-keyword">import</span> org.apache.zookeeper.KeeperException;<br><span class="hljs-keyword">import</span> org.apache.zookeeper.WatchedEvent;<br><span class="hljs-keyword">import</span> org.apache.zookeeper.Watcher;<br><span class="hljs-keyword">import</span> org.apache.zookeeper.ZooKeeper;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 分配客户</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> guolonghang</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2021-10-27</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DistributeClient</span> </span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 康涅狄格州的字符串</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String connString;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 会话超时</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> sessionTimeout;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * zk的客户</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> ZooKeeper zkClient;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 主要</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> args arg游戏</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException          ioexception</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> InterruptedException 中断异常</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> KeeperException      门将例外</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, InterruptedException, KeeperException </span>&#123;<br><br>        DistributeClient client = <span class="hljs-keyword">new</span> DistributeClient();<br>        <span class="hljs-comment">//1.获取zk连接</span><br>        client.getConnect();<br>        <span class="hljs-comment">//2.监听/servers节点路径的变化(监听器的编写)</span><br>        client.getServerList(args[<span class="hljs-number">0</span>]);<br>        <span class="hljs-comment">//3.业务逻辑</span><br>        client.business();<br><br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 业务</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> InterruptedException 中断异常</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">business</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        Thread.sleep(<span class="hljs-number">1000</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取服务器列表</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> path 路径</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> InterruptedException 中断异常</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> KeeperException      门将例外</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getServerList</span><span class="hljs-params">(String path)</span> <span class="hljs-keyword">throws</span> InterruptedException, KeeperException </span>&#123;<br>        List&lt;String&gt; children = zkClient.getChildren(path, <span class="hljs-keyword">true</span>);<br>        ArrayList&lt;String&gt; serverChildren = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (String child : children) &#123;<br>            <span class="hljs-keyword">byte</span>[] data = zkClient.getData(path + child, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<br>            serverChildren.add(data.toString());<br>        &#125;<br>        System.out.println(serverChildren);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获得连接</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException ioexception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getConnect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        connString = <span class="hljs-string">&quot;hadoop102:2181,hadoop103:2181,hadoop104:2181&quot;</span>;<br>        sessionTimeout = <span class="hljs-number">0</span>;<br>        zkClient = <span class="hljs-keyword">new</span> ZooKeeper(connString, sessionTimeout, <span class="hljs-keyword">new</span> Watcher() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">process</span><span class="hljs-params">(WatchedEvent watchedEvent)</span> </span>&#123;<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="4-4-测试">4.4 测试</h2>
<p>//todo</p>
<h1>5. zookeeper分布式锁案例</h1>
<p><strong>什么叫做分布式锁呢？</strong><br>
比如说&quot;进程   1&quot;在使用该资源的时候，会先去获得锁，&quot;进程   1&quot;获得锁以后会对该资源保持独占，这样其他进程就无法访问资源，&quot;进程 1&quot;用完该资源以后就将锁释放掉，让其他进程来获得锁，那么通过这个锁机制，我们就能保证了分布式系统中多个进程能够有序的访问该临界资源。那么我们把这个分布式环境下的这个锁叫作分布式锁。</p>
<h2 id="5-1-原生zookeeper分布式锁案例">5.1 原生zookeeper分布式锁案例</h2>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211027104946833.png" class="" title="image-20211027104946833">
<ol>
<li>当多台客户端同时访问zookeeper集群时，zookeeper集群会将所有的client都创建一个临时顺序节点，其目录为/locks</li>
<li>在locks中的节点按照其编号顺序进行取锁访问，处理业务。</li>
<li>处理完毕后，delete释放锁，进行下一个节点的业务处理。</li>
<li>有点像AQS中悲观锁的思想，先进先出。</li>
</ol>
<h3 id="5-1-1-zookeeper分布式锁实现">5.1.1 zookeeper分布式锁实现</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//全局变量</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * zookeeper集群连接地址</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String connString;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 会话超时</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> sessionTimeout;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * zk服务器</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ZooKeeper zkServer;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 看路</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String watchPath;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 倒计时门闩</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> CountDownLatch countDownLatch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 观察等待</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> CountDownLatch watchAwait = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//构造器</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 分布式锁 构造器</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException          ioexception</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> InterruptedException 中断异常</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> KeeperException      门将例外</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DistributeLock</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, InterruptedException, KeeperException </span>&#123;<br>        <span class="hljs-comment">//1.获取连接</span><br>        zkServer = <span class="hljs-keyword">new</span> ZooKeeper(connString, sessionTimeout, <span class="hljs-keyword">new</span> Watcher() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">process</span><span class="hljs-params">(WatchedEvent watchedEvent)</span> </span>&#123;<br>                <span class="hljs-comment">//如果连接上zookeeper需要释放countDownLatch</span><br>                <span class="hljs-keyword">if</span> (watchedEvent.getState()== Event.KeeperState.SyncConnected)&#123;<br>                    countDownLatch.countDown();<br>                &#125;<br>                <span class="hljs-comment">//节点路径变化需要释放watchAwait</span><br>                <span class="hljs-keyword">if</span> (watchedEvent.getType()==Event.EventType.NodeDeleted&amp;&amp;watchedEvent.getPath().equals(watchAwait))&#123;<br>                    watchAwait.countDown();<br>                &#125;<br>            &#125;<br>        &#125;);<br>        <span class="hljs-comment">//等待zk创建成功</span><br>        countDownLatch.await();<br>        <span class="hljs-comment">//2.判断根节点/locks是否存在</span><br>        Stat stat = zkServer.exists(<span class="hljs-string">&quot;/locks&quot;</span>, <span class="hljs-keyword">true</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> == stat) &#123;<br>            <span class="hljs-comment">//服务器创建带序列号带临时节点</span><br>            zkServer.create(<span class="hljs-string">&quot;/locks&quot;</span>, <span class="hljs-string">&quot;locks&quot;</span>.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//加锁</span><br> <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * zk锁</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">zkLock</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">//客户端创建临时带序号节点</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            String currNode = zkServer.create(<span class="hljs-string">&quot;/locks/&quot;</span> + <span class="hljs-string">&quot;seq-&quot;</span>, <span class="hljs-keyword">null</span>, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);<br><br>            <span class="hljs-comment">//查看/locks目录下的节点</span><br>            List&lt;String&gt; children = zkServer.getChildren(<span class="hljs-string">&quot;/locks&quot;</span>, <span class="hljs-keyword">false</span>);<br>            <span class="hljs-comment">//判断当前节点是否为当前目录下最小序号节点，是：获取到锁，否：监听前一个节点</span><br>            <span class="hljs-keyword">if</span> (children.size() == <span class="hljs-number">1</span>) &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//排序</span><br>                Collections.sort(children);<br>                <span class="hljs-comment">//获取当前节点名</span><br>                String currNodeName = currNode.substring(<span class="hljs-string">&quot;/locks/&quot;</span>.length());<br>                <span class="hljs-comment">//找到当前集合位置</span><br>                <span class="hljs-keyword">int</span> currNodeIndex = children.indexOf(currNodeName);<br>                <span class="hljs-keyword">if</span> (-<span class="hljs-number">1</span> == currNodeIndex) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;数据异常&quot;</span>);<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">1</span> == currNodeIndex) &#123;<br>                    <span class="hljs-comment">//只有一个节点，就直接获取锁</span><br>                    <span class="hljs-keyword">return</span>;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-comment">//监听前一个节点</span><br>                    watchPath = <span class="hljs-string">&quot;/locks/&quot;</span> + children.get(currNodeIndex - <span class="hljs-number">1</span>);<br>                    zkServer.getData(watchPath, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">null</span>);<br>                    <span class="hljs-comment">//确保监听</span><br>                    watchAwait.await();<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>            &#125;<br><br>        &#125; <span class="hljs-keyword">catch</span> (KeeperException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>        &#125;<br><br>    &#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//解锁</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * zk解锁</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">zkUnlock</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">//删除节点</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            zkServer.delete(<span class="hljs-string">&quot;/locks/&quot;</span>,-<span class="hljs-number">1</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (KeeperException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>总结：zookeeper原生分布式锁实现主要是依托<strong>创建一个子节点目录群</strong>实现</p>
<ol>
<li>当多个client访问zookeeper集群时，服务器端会在/locks/文件下为每个client创建一个带序号的临时节点，这就是zkLock加锁</li>
<li>每个client按照节点顺序去执行。当业务逻辑执行完成后，删除自己的临时节点。</li>
<li>其中<strong>countDownLatch</strong>的作用是为了保证代码的健壮性，既确保可以连接到zookeeper集群以及可以监听到“当前节点”</li>
</ol>
<h3 id="5-1-2-zookeeper分布式锁测试">5.1.2 zookeeper分布式锁测试</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> bjut.kengkeng.test;<br><br><span class="hljs-keyword">import</span> org.apache.zookeeper.KeeperException;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DistributedLockTest</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException, IOException, KeeperException </span>&#123;<br>        <span class="hljs-keyword">final</span> DistributeLock lock1 = <span class="hljs-keyword">new</span> DistributeLock();<br>        <span class="hljs-keyword">final</span> DistributeLock lock2 = <span class="hljs-keyword">new</span> DistributeLock();<br>        <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-comment">// 获取锁对象 </span><br>                <span class="hljs-keyword">try</span> &#123;<br>                    lock1.zkLock();<br>                    System.out.println(<span class="hljs-string">&quot;线程 1获取锁&quot;</span>);<br>                    Thread.sleep(<span class="hljs-number">5</span> * <span class="hljs-number">1000</span>);<br>                    lock1.zkUnlock();<br>                    System.out.println(<span class="hljs-string">&quot;线程 1释放锁&quot;</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br><br><br>            &#125;<br>        &#125;).start();<br><br>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                lock2.zkLock();<br>                System.out.println(<span class="hljs-string">&quot;线程 1获取锁&quot;</span>);<br>                Thread.sleep(<span class="hljs-number">5</span> * <span class="hljs-number">1000</span>);<br>                lock2.zkUnlock();<br>                System.out.println(<span class="hljs-string">&quot;线程 1释放锁&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br><br><br>        &#125;).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="5-2-Curator-框架实现分布式锁案例">5.2 Curator 框架实现分布式锁案例</h2>
<h3 id="5-2-1-原生API存在的问题">5.2.1 原生API存在的问题</h3>
<ol>
<li>会话连接是异步的，需要自己去处理。比如使用  CountDownLatch</li>
<li>Watch 需要重复注册，不然就不能生效</li>
<li>开发的复杂性还是比较高的</li>
<li>不支持多节点删除和创建。需要自己去递归</li>
</ol>
<h3 id="5-2-2-代码示例">5.2.2 代码示例</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> bjut.kengkeng.test;<br><br><span class="hljs-keyword">import</span> org.apache.curator.framework.CuratorFramework;<br><span class="hljs-keyword">import</span> org.apache.curator.framework.CuratorFrameworkFactory;<br><span class="hljs-keyword">import</span> org.apache.curator.framework.recipes.locks.InterProcessMutex;<br><span class="hljs-keyword">import</span> org.apache.curator.retry.ExponentialBackoffRetry;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 馆长锁</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> guolonghang</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2021-10-27</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CuratorLock</span> </span>&#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 主要</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> args arg游戏</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-comment">//创建分布式锁1</span><br>        InterProcessMutex lock1 = <span class="hljs-keyword">new</span> InterProcessMutex(getCuratorFramework(), <span class="hljs-string">&quot;/locks&quot;</span>);<br>        <span class="hljs-comment">//创建分布式锁2</span><br>        InterProcessMutex lock2 = <span class="hljs-keyword">new</span> InterProcessMutex(getCuratorFramework(), <span class="hljs-string">&quot;/locks&quot;</span>);<br><br>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                lock1.acquire();<br>                System.out.println(<span class="hljs-string">&quot;线程1获取锁&quot;</span>);<br>                lock1.release();<br>                System.out.println(<span class="hljs-string">&quot;释放锁&quot;</span>);<br>                lock1.acquire();<br>                System.out.println(<span class="hljs-string">&quot;线程1再次获取锁&quot;</span>);<br>                lock1.release();<br>                System.out.println(<span class="hljs-string">&quot;再次释放锁&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>            &#125;<br>        &#125;).start();<br><br>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                lock2.acquire();<br>                System.out.println(<span class="hljs-string">&quot;线程2获取锁&quot;</span>);<br>                lock2.release();<br>                System.out.println(<span class="hljs-string">&quot;释放锁&quot;</span>);<br>                lock2.acquire();<br>                System.out.println(<span class="hljs-string">&quot;线程2再次获取锁&quot;</span>);<br>                lock2.release();<br>                System.out.println(<span class="hljs-string">&quot;再次释放锁&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>            &#125;<br>        &#125;).start();<br><br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 得到馆长框架</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-doctag">@code</span> CuratorFramework&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> CuratorFramework <span class="hljs-title">getCuratorFramework</span><span class="hljs-params">()</span> </span>&#123;<br>        ExponentialBackoffRetry retry = <span class="hljs-keyword">new</span> ExponentialBackoffRetry(<span class="hljs-number">3000</span>, <span class="hljs-number">3</span>);<br>        CuratorFramework curatorFramework = CuratorFrameworkFactory.builder().connectString(<span class="hljs-string">&quot;hadoop102:2181&quot;</span>)<br>                .sessionTimeoutMs(<span class="hljs-number">2000</span>)<br>                .connectionTimeoutMs(<span class="hljs-number">2000</span>)<br>                .retryPolicy(retry).build();<br><br>        <span class="hljs-comment">//启动客户端</span><br>        curatorFramework.start();<br>        <span class="hljs-keyword">return</span> curatorFramework;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<h1>6. 企业面试真题</h1>
<h2 id="6-1-选举机制">6.1 选举机制</h2>
<p>半数机制，超过半数的投票通过，即通过。</p>
<ol>
<li>
<p>第一次启动选举规则：<br>
投票过半数时，服务器  id 大的胜出</p>
</li>
<li>
<p>第二次启动选举规则：<br>
①EPOCH 大的直接胜出<br>
②EPOCH 相同，事务 id 大的胜出 ③事务 id 相同，服务器 id 大的胜出</p>
</li>
</ol>
<h2 id="6-2-生产集群安装多少zk合适">6.2 生产集群安装多少zk合适</h2>
<p>安装奇数台。<br>
生产经验：<br>
⚫         10 台服务器：3 台 zk；<br>
⚫         20 台服务器：5 台 zk；<br>
⚫         100 台服务器：11 台 zk；<br>
⚫         200 台服务器：11 台 zk<br>
服务器台数多：好处，提高可靠性；坏处：提高通信延时</p>
<h2 id="6-3-常用命令">6.3 常用命令</h2>
<p>ls、get、create、delete</p>
<h1>7.算法基础</h1>
<h2 id="7-1-拜占庭将军问题">7.1 拜占庭将军问题</h2>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211027162834105.png" class="" title="image-20211027162834105">
<h2 id="7-2-Paxos算法">7.2 Paxos算法</h2>
<p><strong>Paxos算法</strong>：一种基于消息传递且具有高度容错特性的一致性算法。</p>
<p><strong>Paxos算法解决的问题</strong>：如何快速正确的在一个分布<code>式系统中实现数据的一致性，并且保证</code>不论发生什么异常，都不会破坏整个系统的一致性</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211028100509787.png" class="">
<h3 id="7-2-1-算法描述">7.2.1 算法描述</h3>
<p>在一个Paxos系统中，将所有的节点划分成了Proposer（提议者）、Acceptor（接受者）、learner（学习者）。每个节点都可以身兼数职。</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211028102420149.png" class="" title="image-20211028102420149">
<p>一个完整的Paxos算法流程分为三个阶段：</p>
<ol>
<li>prepare准备阶段
<ol>
<li>Proposer向多个Acceptor发出propose请求promise（承诺）。</li>
<li>Acceptor对收到的propose进行promise（承诺）</li>
</ol>
</li>
<li>Accept接收阶段
<ol>
<li>Proposer收到多数Acceptor的promise后，向Acceptor发出propose请求</li>
<li>Acceptor针对收到的promise进行accept处理</li>
</ol>
</li>
<li>Learn学习阶段：Proposer将形成的决议发给全部Learner</li>
</ol>
<h3 id="7-2-2-算法流程">7.2.2 算法流程</h3>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211028104555482.png" class="" title="image-20211028104555482">
<ol>
<li><strong>Prepare</strong>: Proposer生成全局唯一旦递增的Proposal 1D，向所有Acceptor发送Propose请求，这里无需携带提案内容，只携<br>
带Proposal ID即可</li>
<li><strong>Promise</strong>: Acceptor收到Propose请求后，做出“两个承诺，一个应答”
<ol>
<li>不再接收Proposal ID小于等于（注意：这里是＜二）当前请求的Propose请求。</li>
<li>不再接收Proposal ID小于（注意：这里是＜）当前请求的Accept请求。</li>
<li>不违背以前做出的承诺下，回复己经Accept过的提案中Proposal ID最大的那个提案的Value 和Proposal DD，没有则<br>
返回空值</li>
</ol>
</li>
<li><strong>Propose</strong>：Proposer收到多数Acceptor的Promnise应答后，从应答中选择Proposal ID最大的提案的Value，作为本次要发起的<br>
提案。如果所有应答的提案Value均为空值，则可以自己随意决定提案Value。然后携带当前Proposal ID，向所有Acceptor发送<br>
Propose请求。</li>
<li><strong>Accept</strong>: Acceptor收到Propose请求后，在不违背自己之前做出的承诺下，接受并持久化当 前ProposalID和提家Value。</li>
<li><strong>Learn</strong>: Proposer收到多数Acceptor的Accept后，决议形成，将形成的决议发送给所有Learner。</li>
</ol>
<h3 id="7-2-3-举例">7.2.3 举例</h3>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211028105528384.png" class="" title="image-20211028105528384">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211028105601544.png" class="" title="image-20211028105601544">
<p>Paxos 算法缺陷：在网络复杂的情况下，一个应用  Paxos 算法的分布式系统，可能很久 无法收敛，甚至陷入活锁的情况。</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211028145240380.png" class="" title="image-20211028145240380">
<p>造成这种情况的原因是系统中有一个以上的 Proposer，多 个 Proposers 相互争夺 Acceptor， 造成迟迟无法达成一致的情况。**针对这种情况，一种改进的 Paxos 算法被提出：从系统中选 出一个节点作为 Leader，只有 Leader 能够发起提案。**这样，一次 Paxos 流程中只有一个 Proposer，不会出现活锁的情况，此时只会出现例子中第一种情况。</p>
<h2 id="7-3-ZAB算法">7.3 ZAB算法</h2>
<h3 id="7-3-1-什么是ZAB算法">7.3.1 什么是ZAB算法</h3>
<p>Zab 借鉴了 Paxos 算法，是特别为 Zookeeper 设计的<strong>支持崩溃恢复的原子广播协议</strong>。基 于该协议，Zookeeper 设计为**只有一台客户端（Leader）**负责处理外部的写事务请求，然后 Leader 客户端将数据同步到其他 Follower 节点。<strong>即 Zookeeper 只有一个 Leader 可以发起提 案。</strong></p>
<h3 id="7-3-2-ZAB协议内容">7.3.2 ZAB协议内容</h3>
<p>Zab 协议包括两种基本的模式：消息广播、崩溃恢复。</p>
<h4 id="7-3-2-1-消息广播模式">7.3.2.1 消息广播模式</h4>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211028151529925.png" class="" title="image-20211028151529925">
<ol>
<li>客户端发起一个写操作请求。</li>
<li>Leader服务器<strong>将客户端的请求转化为事务Proposal 提案</strong>，同时<strong>为每个Proposal 分配一个全局的1D，即zxid.</strong></li>
<li>Leader服务器<strong>为每个Follower服务器分配一个单独的队列</strong>，然后将需要广播的 Proposal依次放到队列中去，<strong>并且根据FIFO策略进行消息发送。</strong></li>
<li>Follower接收到Proposal后，会首先<strong>将其以事务日志的方式写入本地磁盘</strong>中，写入成功后<strong>向Leader反馈一个Ack响应消息</strong></li>
<li>Ieader接收到<strong>超过半数以上Follower的Ack响应消息</strong>后，即认为消息发送成功，可以发送commit消息。</li>
<li>Leader向所有Follower广播commit消息，同时自身也会完成事务提交。Follower 接收到commit消息后，会将上一条事务提交。</li>
<li>zookeeper采用Zab协议的核心，就是只要有一台服务器提交了Proposal，就要确保所有的服务器最终都能正确提交Proposal。</li>
</ol>
<p><strong>【问题】</strong></p>
<p>ZAB协议针对于事务请求的操作类似于一个两段式提交操作。</p>
<p>（1）广播事务阶段</p>
<p>（2）广播提交阶段</p>
<p>（1）但是当Leader提交一个proposal后，就接着宕机了，Follower都没有办法完成proposal</p>
<p>（2）Leader收到半数的ACK后，还没有来的及commit，就宕机了，Follower也没有办法完成proposal</p>
<h4 id="7-3-2-2-崩溃恢复">7.3.2.2 崩溃恢复</h4>
<p>一旦Leader出现了崩溃现象或者因为网络问题与过半的follower失去了连接，Leader就会进入崩溃恢复模式。</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211028152824245.png" class="" title="image-20211028152824245">
<ol>
<li>假设两种服务器异常情况：
<ol>
<li>假设一个事务 在Ieader提出之后，Leader挂了。</li>
<li>一个事务在Ieader上提交了，并且过半的Follower都响应Ack了，但是Leader在Commit消息发出之前挂了。</li>
</ol>
</li>
<li>zab协议崩溃恢复要求满足以下两个要求：
<ol>
<li>确保已经被Ieader提交的提案Proposal，必须最终被所有的Follower服务器提交。</li>
<li>确保丢弃已经被Icader提出的，但是没有被提交的Proposal。（丢弃胎死腹中的提案）<br>
（己经产生的提案，Follower必须执行)</li>
</ol>
</li>
</ol>
<p>崩溃恢复主要包括两个阶段即：<strong>【Leader选举】和【数据恢复】</strong></p>
<p><strong>【Leader选举】</strong></p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211028153512643.png" class="" title="image-20211028153512643">
<p>Leader选举:根据上述要求，Zab协议需要保证选举出来的Leader需要要满足以下条件:</p>
<p>(1)新选举出来的Leader不能包含未提交的Proposal。<strong>即新Leader必须都是已经提交了Proposal的Follower服务器节点。</strong></p>
<p>(2)新选举的Leader节点中含有最大的zxid。<strong>这样做的好处是可以近避免Leader服务器检查Proposal的提交和丢弃工作。</strong></p>
<p><strong>【数据恢复】</strong></p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211028153957554.png" class="" title="image-20211028153957554">
<p>Zab如何数据同步:</p>
<p>(1)完成Leader选举后，在正式开始工作之前(接收事务请求，然后提出新的Proposal)，Leader服务器会<strong>首先确认事务日志中的所有的Proposal 是否已经被集群中过半的服务器Commit。</strong></p>
<p>(2)**Leader服务器需要确保所有的Follower服务器能够接收到每条事务的Proposal，并且能将所有已经提交的事务Proposal，应用到内存数据中。**等到Follower将所有尚未同步的事务Proposal都在Leader服务器上同步过，并且应用到内存数据中以后，Leader才会把该Follower加入到真正可用的Follower列表中。</p>
<h2 id="7-4-CAP理论">7.4 CAP理论</h2>
<p>CAP理论告诉我们，一个分布式系统不可能同时满足以下三种</p>
<ul>
<li><strong>一致性(C:Consistency)</strong></li>
<li><strong>可用性(A:Available)</strong></li>
<li><strong>分区容错性(P:Partition Tolerance)</strong></li>
</ul>
<p>这三个基本需求，最多只能同时满足其中的两项，<strong>因为P是必须的，因此往往选择就在CP或者AP中。</strong></p>
<ol>
<li>一致性(C:Consistency)：在分布式环境中，<strong>一致性是指数据在多个副本之间是否能够保持数据一致的特性</strong>。在一致性的需求下，<strong>当一个系统在数据一致的状态下执行更新操作后，应该保证系统的数据仍然处于一致的状态。</strong></li>
<li>可用性(A:Available)：<strong>可用性是指系统提供的服务必须一直处于可用的状态</strong>，对于用户的每一个操作请求总是能够在有限的时间内返回结果。</li>
<li>分区容错性(P:Partition Tolerance)：<strong>分布式系统在遇到任何网络分区故障的时候，仍然需要能够保证对外提供满足一致性和可用性的服务</strong>，除非是整个网络环境都发生了故障。</li>
<li><strong>ZooKeeper保证的是CP</strong></li>
<li>ZooKeeper不能保证每次服务请求的可用性。(注:在极端环境下，ZooKeeper可能会丢弃一些请求，消费者程序需要<br>
重新请求才能获得结果)。所以说，ZooKeeper不能保证服务可用性。</li>
<li>进行Leader选举时集群都是不可用。</li>
</ol>
<h1>8. 源码详解</h1>
<h2 id="8-1-辅助源码">8.1 辅助源码</h2>
<h3 id="8-1-1-持久化源码">8.1.1 持久化源码</h3>
<p>Leader和follower的数据会在内存和磁盘各保存一份，所以需要将内存中的数据持久化到磁盘里</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211029094728816.png" class="" title="image-20211029094728816">
<p>（1）：SnapShot源码：快照的源码一般就是序列化和反序列化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">SnapShot</span> </span>&#123;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * deserialize a data tree from the last valid snapshot and </span><br><span class="hljs-comment">     * return the last zxid that was deserialized</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dt the datatree to be deserialized into</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> sessions the sessions to be deserialized into</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the last zxid that was deserialized from the snapshot</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     * 反序列化</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">long</span> <span class="hljs-title">deserialize</span><span class="hljs-params">(DataTree dt, Map&lt;Long, Integer&gt; sessions)</span> </span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> IOException</span>;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * persist the datatree and the sessions into a persistence storage</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dt the datatree to be serialized</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> sessions </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     * 序列化</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">serialize</span><span class="hljs-params">(DataTree dt, Map&lt;Long, Integer&gt; sessions, </span></span><br><span class="hljs-params"><span class="hljs-function">            File name)</span> </span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> IOException</span>;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * find the most recent snapshot file</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the most recent snapshot file</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     * 找到最近的快照</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function">File <span class="hljs-title">findMostRecentSnapshot</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * free resources from this snapshot immediately</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     * 关闭</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">close</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>&#125; <br><br></code></pre></td></tr></table></figure>
<p>（2）TxnLog 日志源码：一般就是对日志的增删改查或者一些定制化的功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">TxnLog</span> </span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Setter for ServerStats to monitor fsync threshold exceed</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> serverStats used to update fsyncThresholdExceedCount</span><br><span class="hljs-comment">     * 设置服务器的状态</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setServerStats</span><span class="hljs-params">(ServerStats serverStats)</span></span>;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * roll the current</span><br><span class="hljs-comment">     * log being appended to</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException </span><br><span class="hljs-comment">     * 回滚日志</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">rollLog</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Append a request to the transaction log</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> hdr the transaction header</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> r the transaction itself</span><br><span class="hljs-comment">     * returns true iff something appended, otw false </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     * 追加日志</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">append</span><span class="hljs-params">(TxnHeader hdr, Record r)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Start reading the transaction logs</span><br><span class="hljs-comment">     * from a given zxid</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> zxid</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> returns an iterator to read the </span><br><span class="hljs-comment">     * next transaction in the logs.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     * 根据对应的事务ID读取日志</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function">TxnIterator <span class="hljs-title">read</span><span class="hljs-params">(<span class="hljs-keyword">long</span> zxid)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * the last zxid of the logged transactions.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the last zxid of the logged transactions.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     * 得到最后一个日志事务ID</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">long</span> <span class="hljs-title">getLastLoggedZxid</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * truncate the log to get in sync with the </span><br><span class="hljs-comment">     * leader.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> zxid the zxid to truncate at.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException </span><br><span class="hljs-comment">     * 删除</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">truncate</span><span class="hljs-params">(<span class="hljs-keyword">long</span> zxid)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * the dbid for this transaction log. </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the dbid for this transaction log.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     * 获取BDID</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">long</span> <span class="hljs-title">getDbId</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * commit the transaction and make sure</span><br><span class="hljs-comment">     * they are persisted</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     * 提交</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">commit</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> transaction log&#x27;s elapsed sync time in milliseconds</span><br><span class="hljs-comment">     * 获取同步时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">long</span> <span class="hljs-title">getTxnLogSyncElapsedTime</span><span class="hljs-params">()</span></span>;<br>   <br>    <span class="hljs-comment">/** </span><br><span class="hljs-comment">     * close the transactions logs</span><br><span class="hljs-comment">     * 关闭</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">close</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * an iterating interface for reading </span><br><span class="hljs-comment">     * transaction logs. </span><br><span class="hljs-comment">     * 读取日志的接口</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">TxnIterator</span> </span>&#123;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * return the transaction header.</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@return</span> return the transaction header.</span><br><span class="hljs-comment">         * 获取头信息</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-function">TxnHeader <span class="hljs-title">getHeader</span><span class="hljs-params">()</span></span>;<br>        <br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * return the transaction record.</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@return</span> return the transaction record.</span><br><span class="hljs-comment">         * 获取传输的内容</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-function">Record <span class="hljs-title">getTxn</span><span class="hljs-params">()</span></span>;<br>     <br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * go to the next transaction record.</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">         * 下一条资源</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">next</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>        <br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * close files and release the </span><br><span class="hljs-comment">         * resources</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">         * 关闭</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">close</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>        <br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Get an estimated storage space used to store transaction records</span><br><span class="hljs-comment">         * that will return by this iterator</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">         * 获取存储的大小</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-function"><span class="hljs-keyword">long</span> <span class="hljs-title">getStorageSize</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>
<p>（3）处理持久化的核心类</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211029100817877.png" class="" title="image-20211029100817877">
<h3 id="8-1-2-序列化源码">8.1.2 序列化源码</h3>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211029100855921.png" class="" title="image-20211029100855921">
<p>（1）序列化和反序列化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Interface that is implemented by generated classes.</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@InterfaceAudience</span>.Public<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Record</span> </span>&#123;<br>  <span class="hljs-comment">// 序列化</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">serialize</span><span class="hljs-params">(OutputArchive archive, String tag)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> IOException</span>;<br>  <span class="hljs-comment">// 反序列化</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">deserialize</span><span class="hljs-params">(InputArchive archive, String tag)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> IOException</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>（2）迭代</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Interface that acts as an iterator for deserializing maps.</span><br><span class="hljs-comment"> * The deserializer returns an instance that the record uses to</span><br><span class="hljs-comment"> * read vectors and maps. An example of usage is as follows:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;code&gt;</span><br><span class="hljs-comment"> * Index idx = startVector(...);</span><br><span class="hljs-comment"> * while (!idx.done()) &#123;</span><br><span class="hljs-comment"> *   .... // read element of a vector</span><br><span class="hljs-comment"> *   idx.incr();</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> * &lt;/code&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Index</span> </span>&#123;<br>    <span class="hljs-comment">// 结束</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">done</span><span class="hljs-params">()</span></span>;<br>    <span class="hljs-comment">// 下一个</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">incr</span><span class="hljs-params">()</span></span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>(3) 序列化支持的数据类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Interface that alll the serializers have to implement.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">OutputArchive</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeByte</span><span class="hljs-params">(<span class="hljs-keyword">byte</span> b, String tag)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeBool</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> b, String tag)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeInt</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i, String tag)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeLong</span><span class="hljs-params">(<span class="hljs-keyword">long</span> l, String tag)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeFloat</span><span class="hljs-params">(<span class="hljs-keyword">float</span> f, String tag)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeDouble</span><span class="hljs-params">(<span class="hljs-keyword">double</span> d, String tag)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeString</span><span class="hljs-params">(String s, String tag)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeBuffer</span><span class="hljs-params">(<span class="hljs-keyword">byte</span> buf[], String tag)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeRecord</span><span class="hljs-params">(Record r, String tag)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">startRecord</span><span class="hljs-params">(Record r, String tag)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">endRecord</span><span class="hljs-params">(Record r, String tag)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">startVector</span><span class="hljs-params">(List&lt;?&gt; v, String tag)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">endVector</span><span class="hljs-params">(List&lt;?&gt; v, String tag)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">startMap</span><span class="hljs-params">(TreeMap&lt;?,?&gt; v, String tag)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">endMap</span><span class="hljs-params">(TreeMap&lt;?,?&gt; v, String tag)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>
<p>(4) 反序列化支持的数据类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Interface that all the Deserializers have to implement.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">InputArchive</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span> <span class="hljs-title">readByte</span><span class="hljs-params">(String tag)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">readBool</span><span class="hljs-params">(String tag)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">readInt</span><span class="hljs-params">(String tag)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">readLong</span><span class="hljs-params">(String tag)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">float</span> <span class="hljs-title">readFloat</span><span class="hljs-params">(String tag)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> <span class="hljs-title">readDouble</span><span class="hljs-params">(String tag)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">readString</span><span class="hljs-params">(String tag)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span>[] readBuffer(String tag) <span class="hljs-keyword">throws</span> IOException;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readRecord</span><span class="hljs-params">(Record r, String tag)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">startRecord</span><span class="hljs-params">(String tag)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">endRecord</span><span class="hljs-params">(String tag)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Index <span class="hljs-title">startVector</span><span class="hljs-params">(String tag)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">endVector</span><span class="hljs-params">(String tag)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Index <span class="hljs-title">startMap</span><span class="hljs-params">(String tag)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">endMap</span><span class="hljs-params">(String tag)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<h2 id="8-2-ZK-服务端初始化源码解析">8.2 ZK 服务端初始化源码解析</h2>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211029101916331.png" class="" title="image-20211029101916331">
<h3 id="8-2-1-ZK-服务端启动脚本分析">8.2.1 ZK 服务端启动脚本分析</h3>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211029102200208.png" class="" title="image-20211029102200208">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211029102302273.png" class="" title="image-20211029102302273">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211029102414373.png" class="" title="image-20211029102414373">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211029102508800.png" class="" title="image-20211029102508800">
<h3 id="8-2-2-ZK-服务端启动入口">8.2.2 ZK 服务端启动入口</h3>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211029103021012.png" class="" title="image-20211029103021012">
<ol>
<li>首先是创建了一个QuorumPeerMain实例对象，然后执行QuorumPeerMain.initializeAndRun()方法</li>
</ol>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211029103145824.png" class="" title="image-20211029103145824">
<ol start="2">
<li>其中initializeAndRun方法用来管理zk的配置信息</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initializeAndRun</span><span class="hljs-params">(String[] args)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> ConfigException, IOException, AdminServerException</span><br><span class="hljs-function">    </span>&#123;<br>  			<span class="hljs-comment">// 1. 新建一个配置对象</span><br>        QuorumPeerConfig config = <span class="hljs-keyword">new</span> QuorumPeerConfig();<br>        <span class="hljs-keyword">if</span> (args.length == <span class="hljs-number">1</span>) &#123;<br>          <span class="hljs-comment">// 解析参数，获取zoo.cfg myid</span><br>            config.parse(args[<span class="hljs-number">0</span>]);<br>        &#125;<br><br>        <span class="hljs-comment">//  2. 启动定时任务，对过期的快照，执行删除（默认该功能关闭）</span><br>        DatadirCleanupManager purgeMgr = <span class="hljs-keyword">new</span> DatadirCleanupManager(config<br>                .getDataDir(), config.getDataLogDir(), config<br>                .getSnapRetainCount(), config.getPurgeInterval());<br>        purgeMgr.start();<br>				<span class="hljs-comment">// 3  启动集群</span><br>        <span class="hljs-keyword">if</span> (args.length == <span class="hljs-number">1</span> &amp;&amp; config.isDistributed()) &#123;<br>            runFromConfig(config);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            LOG.warn(<span class="hljs-string">&quot;Either no config or no quorum defined in config, running &quot;</span><br>                    + <span class="hljs-string">&quot; in standalone mode&quot;</span>);<br>            <span class="hljs-comment">// there is only server in the quorum -- run as standalone</span><br>            ZooKeeperServerMain.main(args);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>
<h3 id="8-2-3-解析参数-zoo-cfg-和-myid">8.2.3 解析参数 zoo.cfg 和 myid</h3>
<ol>
<li>解析zoo.cfg 和 myid</li>
</ol>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211029103735304.png" class="" title="image-20211029103735304">
<ol start="4">
<li>根据路径解析zoo.cfg 然后将其转换为properties文件</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">parse</span><span class="hljs-params">(String path)</span> <span class="hljs-keyword">throws</span> ConfigException </span>&#123;<br>       LOG.info(<span class="hljs-string">&quot;Reading configuration from: &quot;</span> + path);<br>      <br>       <span class="hljs-keyword">try</span> &#123;<br>           File configFile = (<span class="hljs-keyword">new</span> VerifyingFileFactory.Builder(LOG)<br>               .warnForRelativePath()<br>               .failForNonExistingPath()<br>               .build()).create(path);<br>               <br>           Properties cfg = <span class="hljs-keyword">new</span> Properties();<br>           FileInputStream in = <span class="hljs-keyword">new</span> FileInputStream(configFile);<br>           <span class="hljs-keyword">try</span> &#123;<br>               cfg.load(in);<br>               configFileStr = path;<br>           &#125; <span class="hljs-keyword">finally</span> &#123;<br>               in.close();<br>           &#125;<br>           <span class="hljs-comment">// 构造成properties类型文件</span><br>           parseProperties(cfg);<br>       &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ConfigException(<span class="hljs-string">&quot;Error processing &quot;</span> + path, e);<br>       &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException e) &#123;<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ConfigException(<span class="hljs-string">&quot;Error processing &quot;</span> + path, e);<br>       &#125;   <br></code></pre></td></tr></table></figure>
<ol start="5">
<li>解析properties文件。<strong>zoo.cfg配置文件–&gt;properties文件–&gt;map集合</strong> 根据zoo.cfg配置文件对实例对象进行setter设置。完成初始化。</li>
</ol>

<ol start="6">
<li>设置myid和QuorumPeerConfig</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setupMyId</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        File myIdFile = <span class="hljs-keyword">new</span> File(dataDir, <span class="hljs-string">&quot;myid&quot;</span>);<br>        <span class="hljs-comment">// standalone server doesn&#x27;t need myid file.</span><br>        <span class="hljs-keyword">if</span> (!myIdFile.isFile()) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        BufferedReader br = <span class="hljs-keyword">new</span> BufferedReader(<span class="hljs-keyword">new</span> FileReader(myIdFile));<br>        String myIdString;<br>        <span class="hljs-keyword">try</span> &#123;<br>            myIdString = br.readLine();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            br.close();<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            serverId = Long.parseLong(myIdString);<br>            MDC.put(<span class="hljs-string">&quot;myid&quot;</span>, myIdString);<br>        &#125; <span class="hljs-keyword">catch</span> (NumberFormatException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;serverid &quot;</span> + myIdString<br>                    + <span class="hljs-string">&quot; is not a number&quot;</span>);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setupQuorumPeerConfig</span><span class="hljs-params">(Properties prop, <span class="hljs-keyword">boolean</span> configBackwardCompatibilityMode)</span></span><br><span class="hljs-function">            <span class="hljs-keyword">throws</span> IOException, ConfigException </span>&#123;<br>        quorumVerifier = parseDynamicConfig(prop, electionAlg, <span class="hljs-keyword">true</span>, configBackwardCompatibilityMode);<br>        setupMyId();<br>        setupClientPort();<br>        setupPeerType();<br>        checkValidity();<br>    &#125;<br></code></pre></td></tr></table></figure>
<ol start="7">
<li>小结
<ol>
<li>首先是创建了一个<strong>QuorumPeerMain</strong>实例对象，然后执行QuorumPeerMain.i**nitializeAndRun()**方法</li>
<li>其中initializeAndRun方法用来管理zk的配置信息</li>
<li>解析<strong>zoo.cfg</strong> 和 <strong>myid</strong></li>
<li>根据路径解析zoo.cfg 然后将其转换为properties文件</li>
<li>解析properties文件。<strong>zoo.cfg配置文件–&gt;properties文件–&gt;map集合</strong> 根据zoo.cfg配置文件对实例对象进行setter设置。完成初始化。</li>
<li>设置myid和QuorumPeerConfig</li>
</ol>
</li>
</ol>
<h3 id="8-2-4-过期快照删除">8.2.4  过期快照删除</h3>
<p>可以启动定时任务，对过期的快照，执行删除。默认该功能时关闭的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initializeAndRun</span><span class="hljs-params">(String[] args)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> ConfigException, IOException, AdminServerException</span><br><span class="hljs-function">    </span>&#123;<br>        QuorumPeerConfig config = <span class="hljs-keyword">new</span> QuorumPeerConfig();<br>        <span class="hljs-keyword">if</span> (args.length == <span class="hljs-number">1</span>) &#123;<br>            config.parse(args[<span class="hljs-number">0</span>]);<br>        &#125;<br><br>        <span class="hljs-comment">// 启动定时任务</span><br>        DatadirCleanupManager purgeMgr = <span class="hljs-keyword">new</span> DatadirCleanupManager(config<br>                .getDataDir(), config.getDataLogDir(), config<br>                .getSnapRetainCount(), config.getPurgeInterval());<br>        purgeMgr.start();<br><br>        <span class="hljs-keyword">if</span> (args.length == <span class="hljs-number">1</span> &amp;&amp; config.isDistributed()) &#123;<br>            runFromConfig(config);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            LOG.warn(<span class="hljs-string">&quot;Either no config or no quorum defined in config, running &quot;</span><br>                    + <span class="hljs-string">&quot; in standalone mode&quot;</span>);<br>            <span class="hljs-comment">// there is only server in the quorum -- run as standalone</span><br>            ZooKeeperServerMain.main(args);<br>        &#125;<br>    &#125;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> snapRetainCount = <span class="hljs-number">3</span>; <br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> purgeInterval = <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211029105415327.png" class="" title="image-20211029105415327">
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">start</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (PurgeTaskStatus.STARTED == purgeTaskStatus) &#123;<br>            LOG.warn(<span class="hljs-string">&quot;Purge task is already running.&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>   			<span class="hljs-comment">// //  默认情况  purgeInterval=0，该任务关闭，直接返回</span><br>        <span class="hljs-comment">// Don&#x27;t schedule the purge task with zero or negative purge interval.</span><br>        <span class="hljs-keyword">if</span> (purgeInterval &lt;= <span class="hljs-number">0</span>) &#123;<br>            LOG.info(<span class="hljs-string">&quot;Purge task is not scheduled.&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>				<span class="hljs-comment">//  创建一个定时器</span><br>        timer = <span class="hljs-keyword">new</span> Timer(<span class="hljs-string">&quot;PurgeTask&quot;</span>, <span class="hljs-keyword">true</span>);<br>   			<span class="hljs-comment">//  创建一个清理快照任务</span><br>        TimerTask task = <span class="hljs-keyword">new</span> PurgeTask(dataLogDir, snapDir, snapRetainCount);<br>   			<span class="hljs-comment">//  如果  purgeInterval 设置的值是 1，表示  1 小时检查一次，判断是否有过期快照， 有则删除</span><br>        timer.scheduleAtFixedRate(task, <span class="hljs-number">0</span>, TimeUnit.HOURS.toMillis(purgeInterval));<br><br>        purgeTaskStatus = PurgeTaskStatus.STARTED;<br>    &#125;<br><br> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PurgeTask</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TimerTask</span> </span>&#123;<br>        <span class="hljs-keyword">private</span> File logsDir;<br>        <span class="hljs-keyword">private</span> File snapsDir;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> snapRetainCount;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PurgeTask</span><span class="hljs-params">(File dataDir, File snapDir, <span class="hljs-keyword">int</span> count)</span> </span>&#123;<br>            logsDir = dataDir;<br>            snapsDir = snapDir;<br>            snapRetainCount = count;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>          	<span class="hljs-comment">//  清理过期的数据</span><br>            LOG.info(<span class="hljs-string">&quot;Purge task started.&quot;</span>);<br>            <span class="hljs-keyword">try</span> &#123;<br>                PurgeTxnLog.purge(logsDir, snapsDir, snapRetainCount);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                LOG.error(<span class="hljs-string">&quot;Error occurred while purging.&quot;</span>, e);<br>            &#125;<br>            LOG.info(<span class="hljs-string">&quot;Purge task completed.&quot;</span>);<br>        &#125;<br>    &#125;<br><br><span class="hljs-comment">//PurgeTxnLog类中的方法</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">purge</span><span class="hljs-params">(File dataDir, File snapDir, <span class="hljs-keyword">int</span> num)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        <span class="hljs-keyword">if</span> (num &lt; <span class="hljs-number">3</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(COUNT_ERR_MSG);<br>        &#125;<br><br>        FileTxnSnapLog txnLog = <span class="hljs-keyword">new</span> FileTxnSnapLog(dataDir, snapDir);<br><br>        List&lt;File&gt; snaps = txnLog.findNRecentSnapshots(num);<br>        <span class="hljs-keyword">int</span> numSnaps = snaps.size();<br>        <span class="hljs-keyword">if</span> (numSnaps &gt; <span class="hljs-number">0</span>) &#123;<br>            purgeOlderSnapshots(txnLog, snaps.get(numSnaps - <span class="hljs-number">1</span>));<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>
<h3 id="8-2-5-初始化通信组件">8.2.5  初始化通信组件</h3>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211029105918689.png" class="" title="image-20211029105918689">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211029105934464.png" class="" title="image-20211029105934464">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211029105954513.png" class="" title="image-20211029105954513">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211029110018034.png" class="" title="image-20211029110018034">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211029110033262.png" class="" title="image-20211029110033262">
<h2 id="8-3-ZK-服务端加载数据源码解析">8.3 ZK 服务端加载数据源码解析</h2>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030212621640.png" class="" title="image-20211030212621640">
<ol>
<li>zk 中的数据模型，是一棵树，DataTree，每个节点，叫做 DataNode</li>
<li>zk 集群中的 DataTree 时刻保持状态同步</li>
<li>Zookeeper 集群中每个 zk 节点中，数据在内存和磁盘中都有一份完整的数据。
<ol>
<li>内存数据：DataTree</li>
<li>磁盘数据：快照文件   + 编辑日志</li>
</ol>
</li>
</ol>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030212738023.png" class="" title="image-20211030212738023">
<h3 id="8-3-1-冷启动数据恢复快照数据">8.3.1 冷启动数据恢复快照数据</h3>
<p>（1） 启动集群</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030212915995.png" class="" title="image-20211030212915995">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030212935913.png" class="" title="image-20211030212935913">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030212958876.png" class="" title="image-20211030212958876">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030213013216.png" class="" title="image-20211030213013216">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030213026552.png" class="" title="image-20211030213026552">
<h3 id="8-3-2-冷启动恢复数据">8.3.2 冷启动恢复数据</h3>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030213100808.png" class="" title="image-20211030213100808">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030213138996.png" class="" title="image-20211030213138996">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030213227375.png" class="" title="image-20211030213227375">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030213244097.png" class="" title="image-20211030213244097">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030213258817.png" class="" title="image-20211030213258817">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030213342877.png" class="" title="image-20211030213342877">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030213357497.png" class="" title="image-20211030213357497">
<h3 id="8-3-3-冷启动数据恢复编辑日志">8.3.3  冷启动数据恢复编辑日志</h3>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030213731826.png" class="" title="image-20211030213731826">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030213748259.png" class="" title="image-20211030213748259">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030213803310.png" class="" title="image-20211030213803310">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030213907481.png" class="" title="image-20211030213907481">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030213920741.png" class="" title="image-20211030213920741">
<h2 id="8-4-ZK选举机制源码解析">8.4 ZK选举机制源码解析</h2>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030214158626.png" class="" title="image-20211030214158626">
<p>QuorumPeer类包含两个部分：1.快速选举选择部分。2.通信部分</p>
<ol>
<li>首先生成选举算法（生成 选票）</li>
<li>将选票放入到sendqueue中（发送选票缓冲池）</li>
<li>通过WorkerSender处理选票，将其发送给通信部分的recvQueue</li>
<li>当ZK2的sid比自己的sid大的时候
<ol>
<li>通过快速选举部分的WorkerReceiver将选票放入到recequeue中（处理投票缓冲池）</li>
<li>进行选票生成并通过通信部分的Listener（监听器）的handleConnection中的queueSendMap中选择发送给的对应sid的服务器。然后通过handleConnection中的SendWorkerMap进行选票的接收与发送。实现与其他节点进行通信。</li>
</ol>
</li>
</ol>
<h3 id="8-4-1-选举准备">8.4.1 选举准备</h3>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030214859394.png" class="" title="image-20211030214859394">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030214912240.png" class="" title="image-20211030214912240">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030214939573.png" class="" title="image-20211030214939573">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215014397.png" class="" title="image-20211030215014397">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215034395.png" class="" title="image-20211030215034395">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215046337.png" class="" title="image-20211030215046337">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215056946.png" class="" title="image-20211030215056946">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215107302.png" class="" title="image-20211030215107302">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215118265.png" class="" title="image-20211030215118265">
<h3 id="8-4-2-选举执行">8.4.2 选举执行</h3>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215249974.png" class="" title="image-20211030215249974">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215348106.png" class="" title="image-20211030215348106">
<p>1）执行 super.start();就相当于执行 QuorumPeer.java 类中的  run()方法</p>
<p>2）当 Zookeeper 启动后，首先都是 Looking 状态，通过选举，让其中一台服务器成为 Leader， 其他的服务器成为 Follower。</p>
<p>QuorumPeer.java类</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215429881.png" class="" title="image-20211030215429881">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215444136.png" class="" title="image-20211030215444136">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215459890.png" class="" title="image-20211030215459890">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215511802.png" class="" title="image-20211030215511802">
<p>2）ctrl+alt+b 点击 lookForLeader()的实现类 FastLeaderElection.java</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215529162.png" class="" title="image-20211030215529162">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215542587.png" class="" title="image-20211030215542587">
<p>3）点击 sendNotifications，广播选票，把自己的选票发给其他服务器</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215600689.png" class="" title="image-20211030215600689">
<p>4）在 FastLeaderElection.java 类中查找 WorkerSender 线程。</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215625746.png" class="" title="image-20211030215625746">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215638853.png" class="" title="image-20211030215638853">
<p>5）如果数据是发送给自己的，添加到自己的接收队列</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215654633.png" class="" title="image-20211030215654633">
<p>6）数据添加到发送队列</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215710145.png" class="" title="image-20211030215710145">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215722219.png" class="" title="image-20211030215722219">
<p>7）与要发送的服务器节点建立通信连接</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215741633.png" class="" title="image-20211030215741633">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215802592.png" class="" title="image-20211030215802592">
<p>8）创建并启动发送器线程和接收器线程</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215821268.png" class="" title="image-20211030215821268">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215833919.png" class="" title="image-20211030215833919">
<p>9）点击 SendWorker，并查找该类下的 run 方法</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215852138.png" class="" title="image-20211030215852138">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215902615.png" class="" title="image-20211030215902615">
<p>10）点击 RecvWorker，并查找该类下的 run 方法</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215920441.png" class="" title="image-20211030215920441">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215931808.png" class="" title="image-20211030215931808">
<p>11）在  FastLeaderElection.java 类中查找 WorkerReceiver 线程。</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215947280.png" class="" title="image-20211030215947280">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030215957762.png" class="" title="image-20211030215957762">
<h2 id="8-5-Follower-和-Leader-状态同步源码">8.5 Follower 和  Leader 状态同步源码</h2>
<p>当选举结束后，每个节点都需要根据自己的角色更新自己的状态。选举出的  Leader 更 新自己状态为 Leader，其他节点更新自己状态为  Follower。<br>
Leader 更新状态入口：leader.lead()<br>
Follower 更新状态入口：follower.followerLeader()</p>
<p>注意：</p>
<p>（1）follower 必须要让  leader 知道自己的状态：epoch、zxid、sid 必须要找出谁是 leader；<br>
发起请求连接 leader； 发送自己的信息给 leader；<br>
leader 接收到信息，必须要返回对应的信息给 follower。<br>
（2）当 leader得知 follower的状态了，就确定需要做何种方式的数据同步 DIFF、TRUNC、SNAP<br>
（3）执行数据同步<br>
（4）当  leader 接收到超过半数  follower 的  ack 之后，进入正常工作状态，集群启动完成了。</p>
<p>最终总结同步的方式：<br>
（1）DIFF 咱两一样，不需要做什么<br>
（2）TRUNC follower 的 zxid 比  leader 的  zxid 大，所以  Follower 要回滚<br>
（3）COMMIT leader 的 zxid 比  follower 的  zxid 大，发送  Proposal 给 foloower 提交执行<br>
（4）如果  follower 并没有任何数据，直接使用  SNAP 的方式来执行数据同步（直接把数据全部序列到 follower）</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030220245513.png" class="" title="image-20211030220245513">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030220257505.png" class="" title="image-20211030220257505">
<h3 id="8-5-1-Leader-lead-等待接收-follower-的状态同步申请">8.5.1 Leader.lead()等待接收 follower 的状态同步申请</h3>
<p>1）在 Leader.java 种查找  lead()方法</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030220621010.png" class="" title="image-20211030220621010">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030220645569.png" class="" title="image-20211030220645569">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030220658893.png" class="" title="image-20211030220658893">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030220709319.png" class="" title="image-20211030220709319">
<p>其中  ss 的初始化是在创建 Leader 对象时，创建的  socket</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030220731560.png" class="" title="image-20211030220731560">
<h3 id="8-5-2-Follower-lead-查找并连接-Leader">8.5.2 Follower.lead()查找并连接 Leader</h3>
<p>1）在 Follower.java 种查找  followLeader()方法</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030220802936.png" class="" title="image-20211030220802936">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030220816526.png" class="" title="image-20211030220816526">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030220828497.png" class="" title="image-20211030220828497">
<h3 id="8-5-3-Leader-lead-创建-LearnerHandler">8.5.3 Leader.lead()创建 LearnerHandler</h3>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030220853998.png" class="" title="image-20211030220853998">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030220904550.png" class="" title="image-20211030220904550">
<p>由于  public class LearnerHandler extends ZooKeeperThread{}，说明 LearnerHandler 是一 个线程。所以 fh.start()执行的是  LearnerHandler 中的  run()方法。</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030220921577.png" class="" title="image-20211030220921577">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030220933993.png" class="" title="image-20211030220933993">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030220945549.png" class="" title="image-20211030220945549">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030220956473.png" class="" title="image-20211030220956473">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030221007757.png" class="" title="image-20211030221007757">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030221018867.png" class="" title="image-20211030221018867">
<h3 id="8-5-4-Follower-lead-创建-registerWithLeader">8.5.4 Follower.lead()创建 registerWithLeader</h3>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030221045608.png" class="" title="image-20211030221045608">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030221057508.png" class="" title="image-20211030221057508">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030221109212.png" class="" title="image-20211030221109212">
<h3 id="8-5-5-Leader-lead-接收-Follwer-状态，根据同步方式发送同步消息">8.5.5 Leader.lead()接收 Follwer 状态，根据同步方式发送同步消息</h3>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030221133892.png" class="" title="image-20211030221133892">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030221147124.png" class="" title="image-20211030221147124">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030221200410.png" class="" title="image-20211030221200410">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030221213079.png" class="" title="image-20211030221213079">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030221224433.png" class="" title="image-20211030221224433">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030221235376.png" class="" title="image-20211030221235376">
<h3 id="8-5-6-Follower-lead-应答-Leader-同步结果">8.5.6 Follower.lead()应答 Leader 同步结果</h3>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030221302556.png" class="" title="image-20211030221302556">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030221313344.png" class="" title="image-20211030221313344">
<h3 id="8-5-7-Leader-lead-应答-Follower">8.5.7 Leader.lead()应答 Follower</h3>
<p>由于  public class LearnerHandler extends ZooKeeperThread{}，说明 LearnerHandler 是一个线程。所以 fh.start()执行的是  LearnerHandler 中的  run()方法。</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030221456812.png" class="" title="image-20211030221456812">
<h2 id="8-6-服务端-Leader-启动">8.6 服务端  Leader 启动</h2>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030221600403.png" class="" title="image-20211030221600403">
<p>Leader.java</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030221630700.png" class="" title="image-20211030221630700">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030221641139.png" class="" title="image-20211030221641139">
<p>LeaderZooKeeperServer.java</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030221716803.png" class="" title="image-20211030221716803">
<p>ZookeeperServer.java</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030221732734.png" class="" title="image-20211030221732734">
<p>点击  PrepRequestProcessor，并查找它的  run 方法</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030221755242.png" class="" title="image-20211030221755242">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030221814625.png" class="" title="image-20211030221814625">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030221826191.png" class="" title="image-20211030221826191">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030221840829.png" class="" title="image-20211030221840829">
<h2 id="8-7-服务端-Follower-启动">8.7 服务端  Follower 启动</h2>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030221913656.png" class="" title="image-20211030221913656">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030221935387.png" class="" title="image-20211030221935387">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030221950327.png" class="" title="image-20211030221950327">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030222000679.png" class="" title="image-20211030222000679">
<h2 id="8-8-客户端启动">8.8 客户端启动</h2>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030222020324.png" class="" title="image-20211030222020324">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030222208842.png" class="" title="image-20211030222208842">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030222224429.png" class="" title="image-20211030222224429">
<p>在 <a target="_blank" rel="noopener" href="http://ZkCli.sh">ZkCli.sh</a> 启动 Zookeeper 时，会调用 ZooKeeperMain.java Ctrl + n  查找 ZooKeeperMain，找到程序的入口 main()方法</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030222247705.png" class="" title="image-20211030222247705">
<h3 id="8-8-1-创建-ZookeeperMain">8.8.1  创建  ZookeeperMain</h3>
<p>连接  zk</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030222326239.png" class="" title="image-20211030222326239">
<p>创建 ZooKeeperAdmin 对象</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030222349163.png" class="" title="image-20211030222349163">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030222400599.png" class="" title="image-20211030222400599">
<h3 id="8-8-2-初始化监听器">8.8.2  初始化监听器</h3>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030222428088.png" class="" title="image-20211030222428088">
<h3 id="8-8-3-解析连接地址">8.8.3  解析连接地址</h3>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030222455728.png" class="" title="image-20211030222455728">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030222514022.png" class="" title="image-20211030222514022">
<h3 id="8-8-4-创建通信">8.8.4  创建通信</h3>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030222550649.png" class="" title="image-20211030222550649">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030222608264.png" class="" title="image-20211030222608264">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030222623896.png" class="" title="image-20211030222623896">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030222641142.png" class="" title="image-20211030222641142">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030222656757.png" class="" title="image-20211030222656757">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030222708109.png" class="" title="image-20211030222708109">
<p>ctrl + alt +B  查找  connect 实现类，ClientCnxnSocketNIO.java</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030222833428.png" class="" title="image-20211030222833428">
<p>ctrl + alt +B  查找  doTransport 实现类，ClientCnxnSocketNIO.java</p>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030222854939.png" class="" title="image-20211030222854939">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030222908968.png" class="" title="image-20211030222908968">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030222922391.png" class="" title="image-20211030222922391">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030222932871.png" class="" title="image-20211030222932871">
<h3 id="8-8-5-执行-run">8.8.5  执行  run()</h3>
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030223009732.png" class="" title="image-20211030223009732">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030223023920.png" class="" title="image-20211030223023920">
<img src="/dajiangdahe.github.io/2021/10/23/zookeeper%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/image-20211030223036400.png" class="" title="image-20211030223036400">
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/dajiangdahe.github.io/tags/Zookeeper/" rel="tag">Zookeeper</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-破解压缩包"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/dajiangdahe.github.io/2021/10/22/%E7%A0%B4%E8%A7%A3%E5%8E%8B%E7%BC%A9%E5%8C%85/"
    >python暴力破解压缩包</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/dajiangdahe.github.io/2021/10/22/%E7%A0%B4%E8%A7%A3%E5%8E%8B%E7%BC%A9%E5%8C%85/" class="article-date">
  <time datetime="2021-10-22T13:06:10.411Z" itemprop="datePublished">2021-10-22</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/dajiangdahe.github.io/categories/%E8%84%9A%E6%9C%AC/">脚本</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1>1.Mac破解zip压缩包</h1>
<h5 id="使用fcrackzip来破解zip类型压缩文件">使用fcrackzip来破解zip类型压缩文件</h5>
<p>fcrackzip是一款专门破解zip类型压缩文件密码的工具，工具破解速度还是可以的，能用字典和指定字符集破解，适用于Linux、Mac OS 系统。</p>
<h6 id="如果你的电脑没有安装brew，需要执行下面命令行"><strong>如果你的电脑没有安装brew，需要执行下面命令行</strong></h6>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">/usr/bin/ruby -e &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)&quot; <br></code></pre></td></tr></table></figure>
<h5 id="安装fcrackzip">安装fcrackzip</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">brew install fcrackzip<br></code></pre></td></tr></table></figure>
<h5 id="使用-fcrackzip-h来查看相关命令帮助">使用 <code>fcrackzip -h</code>来查看相关命令帮助</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs shell">fcrackzip version 1.0, a fast/free zip password cracker<br>written by Marc Lehmann &lt;pcg@goof.com&gt; You can find more info on<br>http://www.goof.com/pcg/marc/<br><br>USAGE: fcrackzip<br>          [-b|--brute-force]            use brute force algorithm<br>          [-D|--dictionary]             use a dictionary<br>          [-B|--benchmark]              execute a small benchmark<br>          [-c|--charset characterset]   use characters from charset<br>          [-h|--help]                   show this message<br>          [--version]                   show the version of this program<br>          [-V|--validate]               sanity-check the algortihm<br>          [-v|--verbose]                be more verbose<br>          [-p|--init-password string]   use string as initial password/file<br>          [-l|--length min-max]         check password with length min to max<br>          [-u|--use-unzip]              use unzip to weed out wrong passwords<br>          [-m|--method num]             use method number &quot;num&quot; (see below)<br>          [-2|--modulo r/m]             only calculcate 1/m of the password<br>          file...                    the zipfiles to crack<br><br>methods compiled in (* = default):<br><br> 0: cpmask<br> 1: zip1<br>*2: zip2, USE_MULT_TAB<br></code></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">c 指定字符集，字符集 格式是 -c &#x27;aA1!:&#x27;<br>表示小写字母 a-z<br>表示大写字母 A-Z<br>表示数字 0-9<br>感叹号表示特殊字符 !:$%&amp;/()=?&#123;&#125;[]+*~#<br>表示包含冒号之后的字符（不能为二进制的空字符）例如  a1:$%  表示 字符集包含小写字母、数字、$字符和%百分号<br></code></pre></td></tr></table></figure>
<h5 id="尝试破解">尝试破解</h5>
<p>有一个文件名叫<code>doubi.zip</code>，密码为doubi的弱密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">// 先要cd到文件所在文件夹位置<br>fcrackzip -b -c &#x27;aA1!&#x27; -l 1-10 -u doubi.zip<br>PASSWORD FOUND!!!!: pw == doubi<br>// 参数<br>-b 表示使用暴力破解的方式<br>-c &#x27;aA1!&#x27; 表示使用大小写字母加数字和符号的混合破解方式<br>-l 1-10 表示需要破解的密码长度1到10位<br>-u 表示只显示破解出来的密码，其他错误的密码不显示<br></code></pre></td></tr></table></figure>
<h5 id="可以使用字典破解">可以使用字典破解</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">fcrackzip -D -p pwd.txt -u doubi.zip<br>PASSWORD FOUND!!!!: pw == doubi<br>// 参数<br>-D 表示要使用字典破解<br>-p 表示要使用哪个字典破解<br></code></pre></td></tr></table></figure>
<h1>2.Mac破解rar压缩包</h1>
<p>找了半天没有找到好用的rar压缩包的破解软件以及破解方法，最后找到了一个亲测可行的暴力破解程序</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> rarfile<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> sys<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyIterator</span>():</span><br>    letters = <span class="hljs-string">&#x27;`1234567890-=/*-qwertyuiop[]\|asdfghjkl;zxcvbnm,.?&gt;&lt;&#123;&#125;:QERWTYUIOPLKJHGFDSAZXCVBNM!@#$%^&amp;*()+&#x27;</span>  <span class="hljs-comment"># 键盘上所有可能输入的字符</span><br>    min_digits = <span class="hljs-number">0</span><br>    max_digits = <span class="hljs-number">0</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, min_digits, max_digits</span>):</span><br>        <span class="hljs-keyword">if</span> min_digits &lt; max_digits:<br>            self.min_digits = min_digits<br>            self.max_digits = max_digits<br>        <span class="hljs-keyword">else</span>:<br>            self.min_digits = max_digits<br>            self.max_digits = min_digits<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__iter__</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-keyword">return</span> self<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__next__</span>(<span class="hljs-params">self</span>):</span><br>        rst = <span class="hljs-built_in">str</span>()<br>        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, random.randrange(self.min_digits, self.max_digits + <span class="hljs-number">1</span>)):<br>            rst += random.choice(MyIterator.letters)<br>        <span class="hljs-keyword">return</span> rst<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract</span>(<span class="hljs-params">path</span>):</span><br>    start_time = time.time()<br>    zfile = rarfile.RarFile(path)<br>    <span class="hljs-comment"># 解压文件地址</span><br><br>    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> MyIterator(<span class="hljs-number">4</span>, <span class="hljs-number">10</span>):  <span class="hljs-comment"># 4到10位密码</span><br>        <span class="hljs-keyword">try</span>:<br>            zfile.extractall(path=<span class="hljs-string">&quot;.&quot;</span>, pwd=<span class="hljs-built_in">str</span>(p).encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>))<br>            <span class="hljs-comment"># 文件地址这里用.代表上述zfile地址</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;the password is &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(p))<br>            now_time = time.time()<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;spend time is &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(now_time - start_time))<br>            sys.exit(<span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;error&#x27;</span>, p)<br>            <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    extract(<span class="hljs-string">&quot;/Users/guolonghang/Documents/kafka/kafka/软件文档/课程资料（1）.rar&quot;</span>)<br><br></code></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/dajiangdahe.github.io/tags/%E7%A0%B4%E8%A7%A3%E5%8E%8B%E7%BC%A9%E5%8C%85/" rel="tag">破解压缩包</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-校招高频算法"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/dajiangdahe.github.io/2021/10/22/%E6%A0%A1%E6%8B%9B%E9%AB%98%E9%A2%91%E7%AE%97%E6%B3%95/"
    >校招高频算法</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/dajiangdahe.github.io/2021/10/22/%E6%A0%A1%E6%8B%9B%E9%AB%98%E9%A2%91%E7%AE%97%E6%B3%95/" class="article-date">
  <time datetime="2021-10-22T07:21:45.228Z" itemprop="datePublished">2021-10-22</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/dajiangdahe.github.io/categories/JavaInterview/">JavaInterview</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <p>[TOC]</p>
<h1>1.二维数组中的查找</h1>
<p><a target="_blank" rel="noopener" href="https://www.nowcoder.com/practice/abc3fe2ce8e146608e868a70efebf62e?tpId=13&amp;&amp;tqId=11154&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking">https://www.nowcoder.com/practice/abc3fe2ce8e146608e868a70efebf62e?tpId=13&amp;&amp;tqId=11154&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//类似于二叉树的思想，从右上角开始进行查找,时间复杂度为o(n+n)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Solution</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">Find</span><span class="hljs-params">(<span class="hljs-keyword">int</span> target, <span class="hljs-keyword">int</span> [][] array)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(array.length==<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">int</span> j=array[<span class="hljs-number">0</span>].length-<span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">while</span>(i&lt;array.length&amp;&amp;j&gt;=<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">if</span>(array[i][j]&gt;target)&#123;<br>                j--;<br>            &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(array[i][j]&lt;target)&#123;<br>                i++;<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span>(i&gt;=array.length||j&lt;<span class="hljs-number">0</span>)&#123;<br>              <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;     <br>        <span class="hljs-keyword">if</span>(target==array[i][j])&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<br>        <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//在每一轮都用二分查找，时间复杂度为o(nlgn * n)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">Find2</span><span class="hljs-params">(<span class="hljs-keyword">int</span> target, <span class="hljs-keyword">int</span>[][] array)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (array.length==<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; array[<span class="hljs-number">0</span>].length; i++) &#123;<br>            <span class="hljs-keyword">if</span> (search(array[i],target,<span class="hljs-number">0</span>,array[<span class="hljs-number">0</span>].length-<span class="hljs-number">1</span>)==target)&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">search</span><span class="hljs-params">(<span class="hljs-keyword">int</span>[] nums,<span class="hljs-keyword">int</span> target,<span class="hljs-keyword">int</span> low,<span class="hljs-keyword">int</span> high)</span></span>&#123;<br>        <span class="hljs-keyword">int</span> left = low;<br>        <span class="hljs-keyword">int</span> right = high;<br>        <span class="hljs-keyword">while</span> (left&lt;=right)&#123;<br>            <span class="hljs-keyword">int</span> mid = (left+right);<br>            <span class="hljs-keyword">if</span> (nums[mid]&gt;target)&#123;<br>                right = mid-<span class="hljs-number">1</span>;<br>            &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nums[mid]&lt;target)&#123;<br>                left = mid+<span class="hljs-number">1</span>;<br>            &#125;<span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">return</span> mid;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> right;<br>    &#125;<br></code></pre></td></tr></table></figure>
<h1>2.替换空格</h1>
<p><a target="_blank" rel="noopener" href="https://www.nowcoder.com/practice/4060ac7e3e404ad1a894ef3e17650423?tpId=13&amp;&amp;tqId=11155&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking">https://www.nowcoder.com/practice/4060ac7e3e404ad1a894ef3e17650423?tpId=13&amp;&amp;tqId=11155&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Solution</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">replaceSpace</span><span class="hljs-params">(StringBuffer str)</span> </span>&#123;<br>    	<span class="hljs-keyword">return</span> str.toString().replace(<span class="hljs-string">&quot; &quot;</span>,<span class="hljs-string">&quot;%20&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h1>3.从尾到头打印链表</h1>
<p><a target="_blank" rel="noopener" href="https://www.nowcoder.com/practice/d0267f7f55b3412ba93bd35cfa8e8035?tpId=13&amp;&amp;tqId=11156&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking">https://www.nowcoder.com/practice/d0267f7f55b3412ba93bd35cfa8e8035?tpId=13&amp;&amp;tqId=11156&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> ArrayList&lt;Integer&gt; <span class="hljs-title">printListFromTailToHead</span><span class="hljs-params">(ListNode listNode)</span> </span>&#123;<br>       ArrayList&lt;Integer&gt; res = <span class="hljs-keyword">new</span> ArrayList&lt;Integer&gt;();<br>       ListNode temp = listNode;<br>       <span class="hljs-keyword">while</span> (temp != <span class="hljs-keyword">null</span>) &#123;<br>           res.add(temp.val);<br>           temp = temp.next;<br>       &#125;<br><br>       Collections.reverse(res);<br>       <span class="hljs-keyword">return</span> res;<br>   &#125;<br></code></pre></td></tr></table></figure>
<h1>4.根据前序遍历和中序遍历重建二叉树</h1>
<p><a target="_blank" rel="noopener" href="https://www.nowcoder.com/practice/8a19cbe657394eeaac2f6ea9b0f6fcf6?tpId=13&amp;&amp;tqId=11157&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking">https://www.nowcoder.com/practice/8a19cbe657394eeaac2f6ea9b0f6fcf6?tpId=13&amp;&amp;tqId=11157&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking</a></p>
<p>1、先序遍历的结果中第一个元素一定是根节点<br>
2、先序遍历结果= 根节点+左子树先序结构+右子树先序结果<br>
3、中序遍历结果= 左子树的中序结果+根节点+右子树的中序结果</p>
<img src="/dajiangdahe.github.io/2021/10/22/%E6%A0%A1%E6%8B%9B%E9%AB%98%E9%A2%91%E7%AE%97%E6%B3%95/20200427152711770.png" class="" title="重建二叉树">
<p><strong>根据上图，3为根节点，根据中序遍历9是3的左子树而且只有一个节点，先序中9后面的20就是3的右子树的根节点，然后再看中序遍历，15在20的左侧7在20右侧，得15是20的左子树7是20的右子树。最后构建出的树如下图：</strong></p>
<img src="/dajiangdahe.github.io/2021/10/22/%E6%A0%A1%E6%8B%9B%E9%AB%98%E9%A2%91%E7%AE%97%E6%B3%95/20200427153240659.png" class="">
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> TreeNode <span class="hljs-title">myBuildTree</span><span class="hljs-params">(<span class="hljs-keyword">int</span>[] preorder, <span class="hljs-keyword">int</span>[] inorder, <span class="hljs-keyword">int</span> preorder_left, <span class="hljs-keyword">int</span> preorder_right, <span class="hljs-keyword">int</span> inorder_left, <span class="hljs-keyword">int</span> inorder_right)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (preorder_left &gt; preorder_right) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>        <span class="hljs-comment">//前序遍历中第一个节点就是根节点</span><br>        <span class="hljs-keyword">int</span> preorder_root = preorder_left;<br>        <span class="hljs-comment">//在中序遍历里定位根节点</span><br>        <span class="hljs-keyword">int</span> inorder_root = indexMap.get(preorder[preorder_root]);<br>        <span class="hljs-comment">//创建根节点</span><br>        TreeNode root = <span class="hljs-keyword">new</span> TreeNode(preorder[preorder_root]);<br>        <span class="hljs-comment">//得到左子树的结点个数</span><br>        <span class="hljs-keyword">int</span> size_left_subTree = inorder_root - inorder_left;<br>        <span class="hljs-comment">// 递归地构造左子树，并连接到根节点</span><br>        <span class="hljs-comment">// 先序遍历中「从 左边界+1 开始的 size_left_subtree」个元素就对应了中序遍历中「从 左边界 开始到 根节点定位-1」的元素</span><br>        root.left = myBuildTree(preorder,inorder,preorder_left+<span class="hljs-number">1</span>,preorder_left+size_left_subTree,inorder_left,inorder_root-<span class="hljs-number">1</span>);<br>        <span class="hljs-comment">// 递归地构造右子树，并连接到根节点</span><br>        <span class="hljs-comment">// 先序遍历中「从 左边界+1+左子树节点数目 开始到 右边界」的元素就对应了中序遍历中「从 根节点定位+1 到 右边界」的元素</span><br>        root.right = myBuildTree(preorder,inorder,preorder_left+size_left_subTree+<span class="hljs-number">1</span>,preorder_right,inorder_root+<span class="hljs-number">1</span>,inorder_right);<br>        <span class="hljs-keyword">return</span> root;<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> TreeNode <span class="hljs-title">buildTree</span><span class="hljs-params">(<span class="hljs-keyword">int</span>[] preorder, <span class="hljs-keyword">int</span>[] inorder)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> n = preorder.length;<br>        <span class="hljs-comment">// 构造哈希映射，帮助我们快速定位根节点</span><br>        indexMap = <span class="hljs-keyword">new</span> HashMap&lt;Integer, Integer&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++) &#123;<br>            indexMap.put(inorder[i], i);<br>        &#125;<br>        <span class="hljs-keyword">return</span> myBuildTree(preorder, inorder, <span class="hljs-number">0</span>, n - <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, n - <span class="hljs-number">1</span>);<br>    &#125;<br></code></pre></td></tr></table></figure>
<h1>5.用两个栈实现队列</h1>
<p><a target="_blank" rel="noopener" href="https://www.nowcoder.com/practice/54275ddae22f475981afa2244dd448c6?tpId=13&amp;&amp;tqId=11158&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking">https://www.nowcoder.com/practice/54275ddae22f475981afa2244dd448c6?tpId=13&amp;&amp;tqId=11158&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Solution</span> </span>&#123;<br>    Stack&lt;Integer&gt; stack1 = <span class="hljs-keyword">new</span> Stack&lt;Integer&gt;();<br>    Stack&lt;Integer&gt; stack2 = <span class="hljs-keyword">new</span> Stack&lt;Integer&gt;();<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">push</span><span class="hljs-params">(<span class="hljs-keyword">int</span> node)</span> </span>&#123;<br>       stack1.push(node);<br>       <br>    &#125;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">pop</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(stack1.empty()&amp;&amp;stack2.empty())&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NoSuchElementException();<br>        &#125;<br>        <span class="hljs-keyword">if</span>(stack2.empty())&#123;<br>            <span class="hljs-keyword">while</span>(!stack1.empty())&#123;<br>               stack2.push(stack1.pop()); <br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> stack2.pop();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h1>6.旋转数组的最小值</h1>
<p><a target="_blank" rel="noopener" href="https://www.nowcoder.com/practice/9f3231a991af4f55b95579b44b7a01ba?tpId=13&amp;&amp;tqId=11159&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking">https://www.nowcoder.com/practice/9f3231a991af4f55b95579b44b7a01ba?tpId=13&amp;&amp;tqId=11159&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//流式运算</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">minNumberInRotateArray</span><span class="hljs-params">(<span class="hljs-keyword">int</span> [] array)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> Arrays.stream(array).min().getAsInt();<br>    &#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//二分变种思想，由于旋转后，必然在旋转点看来，前面有序，后面也有序，故可以二分。</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">minNumberInRotateArray</span><span class="hljs-params">(<span class="hljs-keyword">int</span> [] array)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(array.length==<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br>        <br>        <span class="hljs-keyword">int</span> low = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">int</span> high = array.length-<span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">while</span>(low+<span class="hljs-number">1</span>&lt;high)&#123;<br>            <span class="hljs-keyword">int</span> mid = low + (high - low)/<span class="hljs-number">2</span>; <span class="hljs-comment">//mid条件可以写成循环类型，防止出错。</span><br>            <span class="hljs-keyword">if</span>(array[mid]&lt;array[high])&#123;<br>                high = mid;<br>            &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(array[mid] == array[high])&#123;<br>                high = high-<span class="hljs-number">1</span>;<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>                low = mid;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> Math.min(array[low],array[high]);<br>    &#125;<br></code></pre></td></tr></table></figure>
<h1>7.斐波那契数列</h1>
<p><a target="_blank" rel="noopener" href="https://www.nowcoder.com/practice/c6c7742f5ba7442aada113136ddea0c3?tpId=13&amp;&amp;tqId=11160&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking">https://www.nowcoder.com/practice/c6c7742f5ba7442aada113136ddea0c3?tpId=13&amp;&amp;tqId=11160&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//方法一：递归思想</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">Fibonacci</span><span class="hljs-params">(<span class="hljs-keyword">int</span> n)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(n==<span class="hljs-number">0</span>||n==<span class="hljs-number">1</span>)<br>              <span class="hljs-keyword">return</span> n;<br>            <br>        <span class="hljs-keyword">return</span> Fibonacci(n-<span class="hljs-number">1</span>)+Fibonacci(n-<span class="hljs-number">2</span>);<br>        <br>    &#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//方法二：动态规划</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">Fibonacci</span><span class="hljs-params">(<span class="hljs-keyword">int</span> n)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(n==<span class="hljs-number">0</span>||n==<span class="hljs-number">1</span>)<br>              <span class="hljs-keyword">return</span> n;<br>        <span class="hljs-keyword">if</span>(n==<span class="hljs-number">2</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>        &#125;<br>       <span class="hljs-keyword">int</span> p = <span class="hljs-number">1</span>,q=<span class="hljs-number">1</span>,sum = <span class="hljs-number">0</span>;<br>       <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">2</span>;i&lt;n;i++)&#123;<br>           sum = p + q;<br>           p = q;<br>           q = sum;<br>       &#125;<br>        <span class="hljs-keyword">return</span> sum;<br>        <br>    &#125;<br></code></pre></td></tr></table></figure>
<h1>8.跳台阶</h1>
<p><a target="_blank" rel="noopener" href="https://www.nowcoder.com/practice/8c82a5b80378478f9484d87d1c5f12a4?tpId=13&amp;&amp;tqId=11161&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking">https://www.nowcoder.com/practice/8c82a5b80378478f9484d87d1c5f12a4?tpId=13&amp;&amp;tqId=11161&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//递归思想 </span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">jumpFloor</span><span class="hljs-params">(<span class="hljs-keyword">int</span> target)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(target==<span class="hljs-number">1</span>||target==<span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;       <br>        <span class="hljs-keyword">return</span> jumpFloor(target-<span class="hljs-number">1</span>)+jumpFloor(target-<span class="hljs-number">2</span>);<br>    &#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//动态规划</span><br> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">jumpFloor</span><span class="hljs-params">(<span class="hljs-keyword">int</span> target)</span> </span>&#123;<br>       <span class="hljs-keyword">if</span>(target==<span class="hljs-number">0</span>)&#123;<br>           <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>       &#125;<br>       <span class="hljs-keyword">int</span>[] dp = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[target+<span class="hljs-number">1</span>]; <br>       dp[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;<br>       dp[<span class="hljs-number">1</span>] = <span class="hljs-number">1</span>;<br>       <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i =<span class="hljs-number">2</span>;i&lt;dp.length;i++)&#123;<br>           dp[i] = dp[i-<span class="hljs-number">1</span>]+dp[i-<span class="hljs-number">2</span>];<br>       &#125;<br>        <span class="hljs-keyword">return</span> dp[target];<br>    &#125;<br></code></pre></td></tr></table></figure>
<h1>9.变态跳台阶</h1>
<p><a target="_blank" rel="noopener" href="https://www.nowcoder.com/practice/22243d016f6b47f2a6928b4313c85387?tpId=13&amp;&amp;tqId=11162&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking">https://www.nowcoder.com/practice/22243d016f6b47f2a6928b4313c85387?tpId=13&amp;&amp;tqId=11162&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//动态规划 </span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">jumpFloorII</span><span class="hljs-params">(<span class="hljs-keyword">int</span> target)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(target==<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">return</span> target;<br>        &#125;<br>        <span class="hljs-keyword">int</span>[] dp = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[target+<span class="hljs-number">1</span>];<br>        dp[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;<br>        dp[<span class="hljs-number">1</span>] = <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i =<span class="hljs-number">2</span>;i&lt;dp.length;i++)&#123;<br>            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> j=<span class="hljs-number">1</span>;j&lt;=i;j++)&#123;<br>                dp[i] += dp[i-j];<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> dp[target];<br>    &#125;<br></code></pre></td></tr></table></figure>
<h1>10.矩形覆盖</h1>
<p><a target="_blank" rel="noopener" href="https://www.nowcoder.com/practice/72a5a919508a4251859fb2cfb987a0e6?tpId=13&amp;&amp;tqId=11163&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking">https://www.nowcoder.com/practice/72a5a919508a4251859fb2cfb987a0e6?tpId=13&amp;&amp;tqId=11163&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//动态规划</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">rectCover</span><span class="hljs-params">(<span class="hljs-keyword">int</span> target)</span> </span>&#123;<br>        <br>        <span class="hljs-keyword">if</span>(target==<span class="hljs-number">0</span>||target==<span class="hljs-number">1</span>)&#123;<br>            <span class="hljs-keyword">return</span> target;<br>        &#125;<br>        <span class="hljs-keyword">int</span> p=<span class="hljs-number">1</span>,q=<span class="hljs-number">1</span>,sum=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">2</span>;i&lt;=target;i++)&#123;<br>            sum = p+q;<br>            p = q;<br>            q = sum;<br>        &#125;<br>       <span class="hljs-keyword">return</span> sum;<br>    &#125;<br></code></pre></td></tr></table></figure>
<h1>11.二进制中1的个数</h1>
<p><a target="_blank" rel="noopener" href="https://www.nowcoder.com/practice/8ee967e43c2c4ec193b040ea7fbb10b8?tpId=13&amp;&amp;tqId=11164&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking">https://www.nowcoder.com/practice/8ee967e43c2c4ec193b040ea7fbb10b8?tpId=13&amp;&amp;tqId=11164&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Inetger类</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">NumberOf1</span><span class="hljs-params">(<span class="hljs-keyword">int</span> n)</span> </span>&#123;<br>      <span class="hljs-keyword">return</span> Integer.bitCount(n);<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>举个例子</strong>：一个二进制数1100，从右边数起第三位是处于最右边的一个1。减去1后，第三位变成0，它后面的两位0变成了1，而前面的1保持不变，因此得到的结果是1011.我们发现减1的结果是把最右边的一个1开始的所有位都取反了。</p>
<p>这个时候如果我们再把原来的整数和减去1之后的结果做与运算，从原来整数最右边一个1那一位开始所有位都会变成0。如1100&amp;1011=1000.也就是说，把一个整数减去1，再和原整数做与运算，会把该整数最右边一个1变成0.那么一个整数的二进制有多少个1，就可以进行多少次这样的操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">NumberOf1</span><span class="hljs-params">(<span class="hljs-keyword">int</span> n)</span> </span>&#123;<br>       <span class="hljs-keyword">int</span> count = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span>(n != <span class="hljs-number">0</span>)&#123;<br>            count++;<br>            n = n &amp; (n-<span class="hljs-number">1</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> count;<br>    &#125;<br></code></pre></td></tr></table></figure>
<h1>12.整数的N次方</h1>
<p><a target="_blank" rel="noopener" href="https://www.nowcoder.com/practice/1a834e5e3e1a4b7ba251417554e07c00?tpId=13&amp;&amp;tqId=11165&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking">https://www.nowcoder.com/practice/1a834e5e3e1a4b7ba251417554e07c00?tpId=13&amp;&amp;tqId=11165&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> <span class="hljs-title">Power</span><span class="hljs-params">(<span class="hljs-keyword">double</span> base, <span class="hljs-keyword">int</span> exponent)</span> </span>&#123;<br>        <span class="hljs-keyword">double</span> res = base;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">1</span>;i&lt;Math.abs(exponent);i++)&#123;<br>            res = base*res;<br>        &#125;<br>        <span class="hljs-keyword">if</span>(exponent&gt;<span class="hljs-number">0</span>)&#123;<br>           <span class="hljs-keyword">return</span> res;<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(exponent&lt;<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1.0</span>/res;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1.0</span>;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p><strong>快速幂（二进制角度）</strong>：对于任何十进制正整数n，舎其二进制位“bm…b3 b2 b1”(bi为为进制某位置)：</p>
<ul>
<li>二进制转十进制：n = 1*b1 + 2*b2 + 4*b3 + … + 2^m-1*bm</li>
<li>幂的二进制展开：x^n = x ^  1*b1 + 2*b2 + 4*b3 + … + 2^m-1*bm</li>
<li>当bi=0时：x^bi*2^^^i-1^ = 1;</li>
<li>当bi =1时：x^bi*2^^^i-1^  = x^2^^^i-1^</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> <span class="hljs-title">myPow</span><span class="hljs-params">(<span class="hljs-keyword">double</span> x, <span class="hljs-keyword">int</span> n)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(x == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">long</span> b = n;<br>        <span class="hljs-keyword">double</span> res = <span class="hljs-number">1.0</span>;<br>        <span class="hljs-keyword">if</span>(b &lt; <span class="hljs-number">0</span>) &#123;<br>            x = <span class="hljs-number">1</span> / x;<br>            b = -b;<br>        &#125;<br>        <span class="hljs-keyword">while</span>(b &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">if</span>((b &amp; <span class="hljs-number">1</span>) == <span class="hljs-number">1</span>) res *= x;<br>            x *= x;<br>            b &gt;&gt;= <span class="hljs-number">1</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br><br></code></pre></td></tr></table></figure>
<h1>13.调整数组顺序使奇数位位于偶数位前面</h1>
<p><a target="_blank" rel="noopener" href="https://www.nowcoder.com/practice/beb5aa231adc45b2a5dcc5b62c93f593?tpId=13&amp;&amp;tqId=11166&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking">https://www.nowcoder.com/practice/beb5aa231adc45b2a5dcc5b62c93f593?tpId=13&amp;&amp;tqId=11166&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span>[] exchange(<span class="hljs-keyword">int</span>[] nums) &#123;<br>       <span class="hljs-keyword">if</span>(nums.length&lt;=<span class="hljs-number">1</span>)&#123;<br>           <span class="hljs-keyword">return</span> nums;<br>       &#125;<br>       <span class="hljs-keyword">int</span>[] res = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[nums.length];<br>       <span class="hljs-keyword">int</span> low = <span class="hljs-number">0</span>;<br>       <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i =<span class="hljs-number">0</span>;i&lt;nums.length;i++)&#123;<br>           <span class="hljs-keyword">if</span>(nums[i]%<span class="hljs-number">2</span>==<span class="hljs-number">1</span>)&#123;<br>               res[low++] = nums[i];<br>           &#125;<br>       &#125;<br>       <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i =<span class="hljs-number">0</span>;i&lt;nums.length;i++)&#123;<br>           <span class="hljs-keyword">if</span>(nums[i]%<span class="hljs-number">2</span>==<span class="hljs-number">0</span>)&#123;<br>               res[low++] = nums[i];<br>           &#125;<br>       &#125;<br>       nums = res;<br>       <span class="hljs-keyword">return</span> nums;<br>   &#125;<br></code></pre></td></tr></table></figure>
<h1>14.链表中倒数第K个结点</h1>
<p><a target="_blank" rel="noopener" href="https://www.nowcoder.com/practice/529d3ae5a407492994ad2a246518148a?tpId=13&amp;&amp;tqId=11167&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking">https://www.nowcoder.com/practice/529d3ae5a407492994ad2a246518148a?tpId=13&amp;&amp;tqId=11167&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> ListNode <span class="hljs-title">FindKthToTail</span><span class="hljs-params">(ListNode head,<span class="hljs-keyword">int</span> k)</span> </span>&#123;<br>        ListNode temp = head;<br>        <span class="hljs-keyword">int</span> len = <span class="hljs-number">0</span>; <br>        <span class="hljs-keyword">while</span>(temp!=<span class="hljs-keyword">null</span>)&#123;<br>            len++;<br>            temp = temp.next;<br>        &#125;<br>        temp = head;<br>        <span class="hljs-keyword">if</span>(k&gt;len||k&lt;=<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i =<span class="hljs-number">0</span>;i&lt;len - k;i++)&#123;<br>            temp = temp.next;<br>        &#125; <br>        <span class="hljs-keyword">return</span> temp;<br>    &#125;<br></code></pre></td></tr></table></figure>
<h1>15.反转链表</h1>
<p><a target="_blank" rel="noopener" href="https://www.nowcoder.com/practice/75e878df47f24fdc9dc3e400ec6058ca?tpId=13&amp;&amp;tqId=11168&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking">https://www.nowcoder.com/practice/75e878df47f24fdc9dc3e400ec6058ca?tpId=13&amp;&amp;tqId=11168&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> ListNode <span class="hljs-title">ReverseList</span><span class="hljs-params">(ListNode head)</span> </span>&#123;<br>        ListNode res = <span class="hljs-keyword">new</span> ListNode(<span class="hljs-number">0</span>);<br>        ListNode temp = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">while</span>(head!=<span class="hljs-keyword">null</span>)&#123;<br>            temp = head.next;<br>            head.next = res.next;<br>            res.next = head;<br>            head = temp;<br>        &#125;<br>        <span class="hljs-keyword">return</span> res.next;<br>    &#125;<br></code></pre></td></tr></table></figure>
<h1>16.合并两个有序链表</h1>
<p><a target="_blank" rel="noopener" href="https://www.nowcoder.com/practice/d8b6b4358f774294a89de2a6ac4d9337?tpId=13&amp;&amp;tqId=11169&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking">https://www.nowcoder.com/practice/d8b6b4358f774294a89de2a6ac4d9337?tpId=13&amp;&amp;tqId=11169&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> ListNode <span class="hljs-title">Merge</span><span class="hljs-params">(ListNode list1,ListNode list2)</span> </span>&#123;<br>       <span class="hljs-keyword">if</span>(list1==<span class="hljs-keyword">null</span>)&#123;<br>           <span class="hljs-keyword">return</span> list2;<br>       &#125;<br>        <span class="hljs-keyword">if</span>(list2==<span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> list1;<br>        &#125;<br>        ListNode res = <span class="hljs-keyword">new</span> ListNode(<span class="hljs-number">0</span>);<br>        ListNode temp  = res;<br>        <span class="hljs-keyword">while</span>(list1!=<span class="hljs-keyword">null</span>&amp;&amp;list2!=<span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">if</span>(list1.val&lt;list2.val)&#123;<br>                temp.next = list1;<br>                list1 = list1.next;<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>                temp.next = list2;<br>                list2 = list2.next;<br>            &#125;<br>            temp = temp.next;<br>        &#125;<br>        <span class="hljs-keyword">if</span>(list1!=<span class="hljs-keyword">null</span>)&#123;<br>            temp.next = list1;<br>        &#125;<br>        <br>        <span class="hljs-keyword">if</span>(list2!=<span class="hljs-keyword">null</span>)&#123;<br>            temp.next = list2;<br>        &#125;<br>        <span class="hljs-keyword">return</span> res.next; <br>    &#125;<br></code></pre></td></tr></table></figure>
<h1>17.树的 子结构</h1>
<p><a target="_blank" rel="noopener" href="https://www.nowcoder.com/practice/6e196c44c7004d15b1610b9afca8bd88?tpId=13&amp;&amp;tqId=11170&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking">https://www.nowcoder.com/practice/6e196c44c7004d15b1610b9afca8bd88?tpId=13&amp;&amp;tqId=11170&amp;rp=1&amp;ru=/ta/coding-interviews&amp;qru=/ta/coding-interviews/question-ranking</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isSubStructure</span><span class="hljs-params">(TreeNode A, TreeNode B)</span> </span>&#123;<br>       <span class="hljs-keyword">return</span> (A != <span class="hljs-keyword">null</span> &amp;&amp; B != <span class="hljs-keyword">null</span>) &amp;&amp; (isSame(A, B) || isSubStructure(A.left, B) || isSubStructure(A.right, B));<br>   &#125;<br><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span>  <span class="hljs-title">isSame</span><span class="hljs-params">(TreeNode A, TreeNode B)</span></span>&#123;<br>       <span class="hljs-keyword">if</span>(B == <span class="hljs-keyword">null</span>) <br>           <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>       <span class="hljs-keyword">if</span>(A == <span class="hljs-keyword">null</span> || A.val != B.val) <br>           <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>       <span class="hljs-keyword">return</span> isSame(A.left,B.left)&amp;&amp;isSame(A.right,B.right);<br>   &#125;<br></code></pre></td></tr></table></figure>
<h1>18.二叉树的镜像</h1>
<p><a target="_blank" rel="noopener" href="https://leetcode-cn.com/problems/er-cha-shu-de-jing-xiang-lcof/">https://leetcode-cn.com/problems/er-cha-shu-de-jing-xiang-lcof/</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> TreeNode <span class="hljs-title">mirrorTree</span><span class="hljs-params">(TreeNode root)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(root==<span class="hljs-keyword">null</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        TreeNode temp = root.left;<br>        root.left = root.right;<br>        root.right = temp;<br>        mirrorTree(root.left);<br>        mirrorTree(root.right);<br>        <span class="hljs-keyword">return</span> root;<br>    &#125;<br></code></pre></td></tr></table></figure>
<h1></h1>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/dajiangdahe.github.io/tags/%E6%A0%A1%E6%8B%9B/" rel="tag">校招</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-数据一致性"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/dajiangdahe.github.io/2021/10/22/%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7/"
    >数据一致性</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/dajiangdahe.github.io/2021/10/22/%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7/" class="article-date">
  <time datetime="2021-10-22T07:21:45.206Z" itemprop="datePublished">2021-10-22</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/dajiangdahe.github.io/categories/Mysql/">Mysql</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1>1.数据一致性</h1>
<p>​	在数据有多分副本的情况下，如果网络、服务器或者软件出现故障，会导致部分副本写入成功，部分副本写入失败。这就造成各个副本之间的数据不一致，数据内容冲突。 实践中，导致数据不一致的情况有很多种，表现样式也多种多样，比如数据更新返回操作失败，事实上数据在存储服务器已经更新成功。</p>
<h1>2.CAP理论</h1>
<p>CAP定理是2000年，由 Eric Brewer 提出来的。Brewer认为在分布式的环境下设计和部署系统时，有3个核心的需求，以一种特殊的关系存在。这里的分布式系统说的是在物理上分布的系统，比如我们常见的web系统。<br>
  这3个核心的需求是：Consistency，Availability和Partition Tolerance，赋予了该理论另外一个名字 － CAP。<br>
  <strong>Consistency</strong>：一致性，这个和数据库ACID的一致性类似，但这里关注的所有数据节点上的数据一致性和正确性，而数据库的ACID关注的是在在一个事务内，对数据的一些约束。系统在执行过某项操作后仍然处于一致的状态。在分布式系统中，更新操作执行成功后所有的用户都应该读取到最新值。<br>
  <strong>Availability</strong>：可用性，每一个操作总是能够在一定时间内返回结果。需要注意“一定时间”和“返回结果”。“一定时间”是指，系统结果必须在给定时间内返回。“返回结果”是指系统返回操作成功或失败的结果。<br>
  <strong>Partition Tolerance</strong>：分区容忍性，是否可以对数据进行分区。这是考虑到性能和可伸缩性。<br>
  CAP定理认为，一个提供数据服务的存储系统无法同事满足数据一致性、数据可用性、分区容忍性。<br>
  为什么不能完全保证这个三点了，个人觉得主要是因为一旦进行分区了，就说明了必须节点之间必须进行通信，涉及到通信，就无法确保在有限的时间内完成指定的行文，如果要求两个操作之间要完整的进行，因为涉及到通信，肯定存在某一个时刻只完成一部分的业务操作，在通信完成的这一段时间内，数据就是不一致性的。如果要求保证一致性，那么就必须在通信完成这一段时间内保护数据，使得任何访问这些数据的操作不可用。<br>
  如果想保证一致性和可用性，那么数据就不能够分区。一个简单的理解就是所有的数据就必须存放在一个数据库里面，不能进行数据库拆分。这个对于大数据量，高并发的互联网应用来说，是不可接受的。<br>
  在大型网站应用中，数据规模总是快速扩张的，因此可伸缩性即分区容忍性必不可少，规模变大以后，机器数量也会变得庞大，这是网络和服务器故障会频繁出现，要想保证应用可用，就必须保证分布式处理系统的高可用性。所以在大型网站中，通常会选择强化分布式存储系统的可用性(A)和伸缩性§，在某种程度上放弃一致性©。一般来说，数据不一致通常出现在系统高并发写操作或者集群状态不稳（故障恢复、集群扩容等）的情况下，应用系统需要对分布式数据处理系统的数据不一致性有所了解并进行某种意义上的补偿和纠错，以避免出现应用系统数据不正确。</p>
<h1>3.数据一致性模型</h1>
<p>一些分布式系统通过复制数据来提高系统的可靠性和容错性，并且将数据的不同的副本存放在不同的机器，由于维护数据副本的一致性代价高，因此许多系统采用弱一致性来提高性能，一些不同的一致性模型也相继被提出。</p>
<ul>
<li>强一致性： 要求无论更新操作实在哪一个副本执行，之后所有的读操作都要能获得最新的数据。</li>
<li>弱一致性：用户读到某一操作对系统特定数据的更新需要一段时间，我们称这段时间为“不一致性窗口”。</li>
<li>最终一致性：是弱一致性的一种特例，保证用户最终能够读取到某操作对系统特定数据的更新。</li>
</ul>
<h1>4.分布式事务的数据一致性问题（多用于单一数据库集群问题）</h1>
<p>分布式事务就是指事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于不同的分布式系统的不同节点之上。简单的说，就是一次大的操作由不同的小操作组成，这些小的操作分布在不同的服务器上，且属于不同的应用，分布式事务需要保证这些小操作要么全部成功，要么全部失败。本质上来说，分布式事务就是为了保证不同数据库的数据一致性。</p>
<h2 id="1-TC"><a target="_blank" rel="noopener" href="http://1.TC">1.TC</a></h2>
<img src="/dajiangdahe.github.io/2021/10/22/%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7/dist-tx-1.png" class="" title="img">
<img src="/dajiangdahe.github.io/2021/10/22/%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7/dist-yzx-1.png" class="" title="img">
<p>如上图，在XA协议中分为两阶段：</p>
<p>第一阶段：事务管理器要求每个涉及到事务的数据库预提交(precommit)此操作，并反映是否可以提交。</p>
<p>第二阶段：事务协调器要求每个数据库提交数据，或者回滚数据。</p>
<p>优点：</p>
<ul>
<li>尽量保证了数据的强一致，实现成本较低，在各大主流数据库都有自己实现，对于MySQL是从5.5开始支持。</li>
</ul>
<p>缺点：</p>
<ul>
<li>单点问题:事务管理器在整个流程中扮演的角色很关键，如果其宕机，比如在第一阶段已经完成，在第二阶段正准备提交的时候事务管理器宕机，资源管理器就会一直阻塞，导致数据库无法使用。</li>
<li>同步阻塞:在准备就绪之后，资源管理器中的资源一直处于阻塞，直到提交完成，释放资源。</li>
<li>数据不一致:两阶段提交协议虽然为分布式数据强一致性所设计，但仍然存在数据不一致性的可能，比如在第二阶段中，假设协调者发出了事务commit的通知，但是因为网络问题该通知仅被一部分参与者所收到并执行了commit操作，其余的参与者则因为没有收到通知一直处于阻塞状态，这时候就产生了数据的不一致性。</li>
</ul>
<p>总的来说，XA协议比较简单，成本较低，但是其单点问题，以及不能支持高并发依然是其最大的弱点。</p>
<h2 id="2-TCC">2.TCC</h2>
<p>关于TCC（Try-Confirm-Cancel）的概念，最早是由Pat Helland于2007年发表的一篇名为《Life beyond Distributed Transactions:an Apostate’s Opinion》的论文提出。 TCC事务机制相比于上面介绍的XA，解决了其几个缺点：</p>
<ol>
<li>
<p>解决了协调者单点，由主业务方发起并完成这个业务活动。业务活动管理器也变成多点，引入集群。</p>
</li>
<li>
<p>同步阻塞：引入超时，超时后进行补偿，并且不会锁定整个资源，将资源转换为业务逻辑形式，粒度变小。</p>
</li>
<li>
<p>数据一致性，有了补偿机制之后，由业务活动管理器控制一致性。</p>
<img src="/dajiangdahe.github.io/2021/10/22/%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7/dist-tx-2.png" class="" title="img">
</li>
</ol>
<img src="/dajiangdahe.github.io/2021/10/22/%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7/dist-yzx-2.png" class="" title="img">
<p>如上图，对于TCC的解释：</p>
<ul>
<li>Try阶段：尝试执行,完成所有业务检查（一致性），预留必须业务资源（准隔离性）。</li>
<li>Confirm阶段：确认执行真正执行业务，不作任何业务检查，只使用Try阶段预留的业务资源，Confirm操作满足幂等性。要求具备幂等设计，Confirm失败后需要进行重试。</li>
<li>Cancel阶段：取消执行，释放Try阶段预留的业务资源 Cancel操作满足幂等性Cancel阶段的异常和Confirm阶段异常处理方案基本上一致。</li>
</ul>
<p>举个简单的例子如果你用100元买了一瓶水，在Try阶段你需要向你的钱包检查是否够100元并锁住这100元，水也是一样的。如果有一个失败，则进行cancel(释放这100元和这一瓶水)，如果cancel失败不论什么失败都进行重试cancel，所以需要保持幂等。如果都成功，则进行confirm,确认这100元扣，和这一瓶水被卖，如果confirm失败无论什么失败则重试(会依靠活动日志进行重试)。</p>
<p>对于TCC来说适合以下场景：</p>
<ul>
<li>强隔离性，严格一致性要求的活动业务。</li>
<li>执行时间较短的业务。</li>
</ul>
<h1>5.Redis和MySQL的数据一致性问题</h1>
<h2 id="1-一致性问题">1.一致性问题</h2>
<p>读取缓存步骤一般没有什么问题，但是一旦涉及到数据更新：数据库和缓存更新，就容易出现缓存和数据库间的数据一致性问题。不管是先写数据库，再删除缓存；还是先删除缓存，再写库，都有可能出现数据不一致的情况。举个例子：</p>
<p>1.如果删除了缓存Redis，还没有来得及写库MySQL，另一个线程就来读取，发现缓存为空，则去数据库中读取数据写入缓存，此时缓存中为脏数据。</p>
<p>2.如果先写了库，在删除缓存前，写库的线程宕机了，没有删除掉缓存，则也会出现数据不一致情况。</p>
<p>因为写和读是并发的，没法保证顺序,就会出现缓存和数据库的数据不一致的问题。如何解决？这里给出两个解决方案，先易后难，结合业务和技术代价选择使用。</p>
<h2 id="2-解决方法-延迟双删">2.解决方法----延迟双删</h2>
<p><strong>一、 同步延时双删策略</strong></p>
<p>在写库前后都进行redis.del(key)操作，并且设定合理的超时时间。具体步骤是：</p>
<p>1）先删除缓存</p>
<p>2）再写数据库</p>
<p>3）休眠500毫秒（根据具体的业务时间来定）</p>
<p>4）再次删除缓存。</p>
<img src="/dajiangdahe.github.io/2021/10/22/%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7/1306964-20210526181836508-1439022605.png" class="" title="img">
<p>【<strong>休眠时间确定</strong>】</p>
<p>需要评估自己的项目的读数据<strong>业务逻辑的耗时</strong>。这么做的目的，就是确保读请求结束，写请求可以删除读请求造成的缓存脏数据。</p>
<p>当然，这种策略还要考虑 <strong>redis 和数据库主从同步的耗时</strong>。最后的写数据的休眠时间：则在读数据业务逻辑的耗时的基础上，加上几百ms即可。比如：休眠1秒。</p>
<p><strong>二、设置缓存的过期时间</strong></p>
<p>从理论上来说，给缓存设置过期时间，是保证最终一致性的解决方案。所有的写操作以数据库为准，只要到达缓存过期时间，则后面的读请求自然会从数据库中读取新值然后回填缓存</p>
<p>结合双删策略+缓存超时设置，这样最差的情况就是在超时时间内数据存在不一致，而且又增加了写请求的耗时。</p>
<p><strong>三、异步延迟双删策略，借用MQ</strong></p>
<p>上述的方案有一个缺点，那就是操作完数据库后，由于种种原因删除缓存失败，这时，可能就会出现数据不一致的情况。这里，我们需要提供一个保障重试的方案。</p>
<p><strong>1、方案一具体流程</strong></p>
<p>（1）更新数据库数据；</p>
<p>（2）缓存因为种种问题删除失败；</p>
<p>（3）将需要删除的key发送至<strong>消息队列；</strong></p>
<p>（4）自己消费消息，获得需要删除的key；</p>
<p>（5）继续重试删除操作，直到成功。</p>
<p>然而，该方案有一个缺点，对业务线代码造成大量的侵入。于是有了方案二，在方案二中，启动一个订阅程序去订阅数据库的binlog，获得需要操作的数据。在应用程序中，另起一段程序，获得这个订阅程序传来的信息，进行删除缓存操作。</p>
<p><strong>2、方案二具体流程</strong></p>
<p>（1）更新数据库数据；</p>
<p>（2）数据库会将操作信息写入binlog日志当中；</p>
<p>（3）订阅程序提取出所需要的数据以及key；</p>
<p>（4）另起一段非业务代码，获得该信息；</p>
<p>（5）尝试删除缓存操作，发现删除失败；</p>
<p>（6）将这些信息发送至消息队列；</p>
<p>（7）重新从消息队列中获得该数据，重试操作。</p>
<img src="/dajiangdahe.github.io/2021/10/22/%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7/1306964-20210526181839323-1134717675.png" class="" title="img">
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/dajiangdahe.github.io/tags/Mysql/" rel="tag">Mysql</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-布隆过滤器及其应用场景"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/dajiangdahe.github.io/2021/10/22/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF/"
    >布隆过滤器</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/dajiangdahe.github.io/2021/10/22/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF/" class="article-date">
  <time datetime="2021-10-22T07:21:45.189Z" itemprop="datePublished">2021-10-22</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/dajiangdahe.github.io/categories/Redis/">Redis</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1>1.布隆过滤器</h1>
<h2 id="场景">场景</h2>
<p>在项目开发中，我们经常会遇到去重问题：判断一个人有没有浏览过一篇文章，判断一个ip是否发过一个请求，判断一个人当天是否登陆过某个系统</p>
<p>常见的解决办法：</p>
<p>​	（1）：set。缺点：当数据量过大时，set会非常消耗内存，性能也不高。</p>
<p>​	（2）：bitmap。缺点：Bitmap可以提高性能，但是bitmap仍然比较消耗内存，尤其是在数据比较稀疏的情况下。</p>
<p>​	（3）：布隆过滤器。</p>
<h2 id="原理">原理</h2>
<p>布隆过滤器与BitMap类似，底层也是一个位数组。1表示有，0表示无。但布隆过滤器比BitMap需要更少的内存，它是怎么办到的呢？答案是多个hash。</p>
<p>我们知道hash算法，是把一个数从较大范围的值，映射到较小范围值。比如我们有一个10位的数组，使用某个hash算法及其数组上的表示：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">hash</span>(“xy”) = <span class="hljs-number">3</span>;<br><br><span class="hljs-attribute">hash</span>(“aa”) = <span class="hljs-number">5</span>;<br><br><span class="hljs-attribute">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>
<p>这样我们就可以快速的知道一个字符串是不是存在一个集合里面。</p>
<p>但是会出现hash冲突</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs abnf">hash(“xy”) = <span class="hljs-number">3</span><span class="hljs-comment">;</span><br><br>hash(“aa”) = <span class="hljs-number">3</span><span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>
<p>解决办法：1.再hash法</p>
<p>​				  2.链地址法</p>
<p>​				  3.开放定址法</p>
<p>但是在布隆过滤器中选择的是使用（1），采用多个hash算法。</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">h1</span>(“xy”) = <span class="hljs-number">3</span>, h<span class="hljs-number">2</span>(“xy”) = <span class="hljs-number">5</span>, h<span class="hljs-number">3</span>(“xy”) = <span class="hljs-number">7</span>;<br><br><span class="hljs-attribute">h1</span>(“aa”) = <span class="hljs-number">5</span>, h<span class="hljs-number">2</span>(“aa”) = <span class="hljs-number">6</span>, h<span class="hljs-number">3</span>(“aa”) = <span class="hljs-number">7</span>;<br><br><span class="hljs-attribute">h1</span>(“xy的aa”) = <span class="hljs-number">3</span>, h<span class="hljs-number">2</span>(“xy的aa”) = <span class="hljs-number">6</span>, h<span class="hljs-number">3</span>(“xy的aa”) = <span class="hljs-number">9</span>;<br></code></pre></td></tr></table></figure>
<p>最开始的时候 ，集合里没有元素，所有位都是0：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>
<p>然后，插入“xy”，利用多次hash，把每次hash的结果下标3, 5, 7都插入到相应的地方：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>
<p>然后，插入“aa”，利用多次hash，把每次hash的结果下标5, 6, 7都插入到相应的地方，已经是1的下标不变:</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>
<p>当我们判断“xy”是否在集合中，只需要使用同样的 3个hash算法，来计算出下标是3,5,7的位置上是否为1，如果为1，则证明“xy“在集合中。如果发现有下标为0，则说明string不在集合中。</p>
<h2 id="误差">误差</h2>
<p>由于是多个hash函数散列而来，必然会存在一些误差。有可能某个元素并没有在集合中，但是它对应位数组为1.这样就产生了误差。</p>
<p>以布隆过滤器不能删除，因为一旦删除（即将相应的位置为0），就很大可能会影响其他元素。</p>
<p>如果使用布隆过滤器判断一个函数是否存在于一个集合，如果它返回true，则代表可能存在。如果它返回false，则代表一定不存在。</p>
<p>由此可见，布隆过滤器适合于一些需要去重，但不一定要完全精确的场景。比如：</p>
<ul>
<li>判断一个用户访问了一篇文章</li>
<li>判断一个ip访问了本网站</li>
<li>判断一个key是否被访问过</li>
</ul>
<p>相应的，布隆过滤器不适合一些要求零误差的场景，比如：</p>
<ul>
<li>判断一个用户是否收藏了一篇文章</li>
<li>判断一个用户是否订购了一个课程</li>
</ul>
<h2 id="使用技巧">使用技巧</h2>
<p>如果空间越大，hash函数越多，结果就越精确，但是空间效率和查询效率就会越低。</p>
<img src="/dajiangdahe.github.io/2021/10/22/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9OTnNzMDMyRklTZzVvREY3eWtnVUxqSUhvZWQ5Vm1wZGlhbWtKVGdMTVhzTnRFTEhyVFF4MDYwc1k2bjdPN0NVaWNUd1VpYzlGMWdGRXQ1d2R4UUdpY05pYmd3LzY0MA" class="" title="img">
<p>后面4列中的数据就是发生误差的数量。可见，空间大小和集合大小不变的情况下，增加hash函数可以显著减小误差。但一旦集合大小达到空间大小的25%左右后，增加hash函数带来的提神效果并不明显。这个时候应该增加空间大小。</p>
<h2 id="Redis中的布隆过滤器">Redis中的布隆过滤器</h2>
<p>Redis的布隆过滤器不是原生自带的，而是要通过module加载进去。Redis在4.0的版本中加入了module功能。具体使用可以直接看RedisBloom github的README：<a target="_blank" rel="noopener" href="https://github.com/RedisBloom/RedisBloom%E3%80%82%E4%B8%8A%E9%9D%A2%E6%9C%89docker%E4%B8%80%E9%94%AE%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%BE%88%E6%96%B9%E4%BE%BF%E5%9C%B0%E5%AE%9E%E9%AA%8C%E3%80%82%E4%B9%9F%E6%9C%89%E5%87%A0%E7%A7%8D%E4%B8%BB%E6%B5%81%E8%AF%AD%E8%A8%80%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BA%93%E7%9A%84%E9%93%BE%E6%8E%A5%EF%BC%8C%E6%AF%94%E5%A6%82Java%E8%AF%AD%E8%A8%80%E7%9A%84JReBloom%E3%80%82%E6%9C%89%E5%85%B4%E8%B6%A3%E7%9A%84%E6%9C%8B%E5%8F%8B%E5%8F%AF%E4%BB%A5%E8%87%AA%E8%A1%8C%E4%BA%86%E8%A7%A3%E3%80%82">https://github.com/RedisBloom/RedisBloom。上面有docker一键启动命令，可以很方便地实验。也有几种主流语言的客户端库的链接，比如Java语言的JReBloom。有兴趣的朋友可以自行了解。</a></p>
<p>Redis的布隆过滤器主要有两个命令：</p>
<ul>
<li><code>bf.add</code> 添加元素到布隆过滤器中：<code>bf.add strs xy</code></li>
<li><code>bf.exists</code> 判断某个元素是否在过滤器中：<code>bf.exists strs xy</code></li>
</ul>
<p>Redis中有一个命令可以来设置布隆过滤器的准确率：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">bf</span>.reserve strs <span class="hljs-number">0</span>.<span class="hljs-number">01</span> <span class="hljs-number">100</span><br></code></pre></td></tr></table></figure>
<p>三个参数的含义：</p>
<ul>
<li>第一个值是过滤器的名字。</li>
<li>第二个值为<code>error_rate</code>的值：允许布隆过滤器的错误率。</li>
<li>第三个值为<code>initial_size</code>的值：初始化位数组的大小。</li>
</ul>
<h2 id="扩展学习">扩展学习</h2>
<h3 id="Java实现的布隆过滤器">Java实现的布隆过滤器</h3>
<p>如果你的项目没有使用Redis，那可以使用一些开源库，基于代码实现，直接存放在内存。比如Google的guava包中提供了<code>BloomFilter</code>类，有兴趣的读者可以去了解一下，研究研究源码和使用。</p>
<h3 id="布谷鸟过滤器">布谷鸟过滤器</h3>
<p>RedisBloom模块还实现了布谷鸟过滤器，它算是对布隆过滤器的增强版。解决了布隆过滤器的一些比较明显的缺点，比如：不能删除元素，不能计数等。除此之外，布谷鸟过滤器不用使用多个hash函数，所以查询性能更高。除此之外，在相同的误判率下，布谷鸟过滤器的空间利用率要明显高于布隆，空间上大概能节省40%多。</p>
<p>笔者个人觉得，对于大多数场景来说，布隆过滤器足以解决我们的问题。</p>
<p>掘金上有一篇深度分析布谷鸟过滤器的文章，有兴趣的读者可以去了解一下：<a target="_blank" rel="noopener" href="https://juejin.im/post/5cfb9c74e51d455d6d5357db%E3%80%82">https://juejin.im/post/5cfb9c74e51d455d6d5357db。</a></p>
<h2 id="面试题">面试题</h2>
<h3 id="1-给定a、b两个文件，各存放50亿个url，每个url各占64字节，内存限制是4G，让你找出a、b文件共同的url">1.给定a、b两个文件，各存放50亿个url，每个url各占64字节，内存限制是4G，让你找出a、b文件共同的url?</h3>
<p>1.采用布隆过滤器，假设布隆过滤器的错误率为0.01，则位数组大小m约为输入元素个数n的13倍，此时需要的哈希函数k约为8个。</p>
<p>元素个数：5G</p>
<p>位数组大小：m = 5g x 13 = 65G = 650亿bit</p>
<p>我们的内存是 4g x 8bit = 32G = 320亿bit。按此错误率大于0.01</p>
<p>2.采用分治的思想</p>
<img src="/dajiangdahe.github.io/2021/10/22/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF/20191023182333584.jpg" class="" title="img">
<p>Step1：遍历文件a，对每个url求取hash(url)%1000，然后根据所取得的值将url分别存储到1000个小文件(记为a0,a1,…,a999，每个小文件约300M);</p>
<p>Step2:遍历文件b，采取和a相同的方式将url分别存储到1000个小文件(记为b0,b1,…,b999);</p>
<p>巧妙之处：这样处理后，所有可能相同的url都被保存在对应的小文件(a0vsb0,a1vsb1,…,a999vsb999)中，不对应的小文件不可能有相同的url。然后我们只要求出这个1000对小文件中相同的url即可。</p>
<p>Step3：求每对小文件ai和bi中相同的url时，可以把ai的url存储到hash_set/hash_map中。然后遍历bi的每个url，看其是否在刚才构建的hash_set中，如果是，那么就是共同的url，存到文件里面就可以了。</p>
<h2 id="【补充】">【补充】</h2>
<h3 id="为什么使用hash？">为什么使用hash？</h3>
<p>是把任意长度的输入（又叫做预映射pre-image）通过散列算法变换成固定长度的输出，该输出就是散列值。这种转换是一种压缩映射，也就是，散列值的空间通常远小于输入的空间，不同的输入可能会散列成相同的输出，所以不可能从散列值来确定唯一的输入值。简单的说就是一种将任意长度的消息压缩到某一固定长度的消息摘要的函数。</p>
<h2 id="【注】">【注】</h2>
<p>1、Hash取模是一种等价映射，不会存在同一个元素分散到不同小文件中的情况，即这里采用的是mod1000算法，那么相同的url在hash取模后，只可能落在同一个文件中，不可能被分散的。因为如果两个url相等，那么经过Hash(url)之后的哈希值是相同的，将此哈希值取模（如模1000），必定仍然相等。</p>
<p>2、那到底什么是hash映射呢？简单来说，就是为了便于计算机在有限的内存中处理big数据，从而通过一种映射散列的方式让数据均匀分布在对应的内存位置(如大数据通过取余的方式映射成小树存放在内存中，或大文件映射成多个小文件)，而这个映射散列方式便是我们通常所说的hash函数，设计的好的hash函数能让数据均匀分布而减少冲突。尽管数据映射到了另外一些不同的位置，但数据还是原来的数据，只是代替和表示这些原始数据的形式发生了变化而已。</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/dajiangdahe.github.io/tags/Redis/" rel="tag">Redis</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-【经济】解读基金"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/dajiangdahe.github.io/2021/10/22/%E3%80%90%E7%BB%8F%E6%B5%8E%E3%80%91%E8%A7%A3%E8%AF%BB%E5%9F%BA%E9%87%91/"
    >解读基金</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/dajiangdahe.github.io/2021/10/22/%E3%80%90%E7%BB%8F%E6%B5%8E%E3%80%91%E8%A7%A3%E8%AF%BB%E5%9F%BA%E9%87%91/" class="article-date">
  <time datetime="2021-10-22T07:21:45.171Z" itemprop="datePublished">2021-10-22</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/dajiangdahe.github.io/categories/%E4%B9%A6%E7%B1%8D/">书籍</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1>解读基金（季凯帆）</h1>
<h2 id="1-投资的准备">1.投资的准备</h2>
<ol>
<li>投资周期的确定：这笔投资的目的是用来干什么的？长期投资？中期投资？短期投资？</li>
<li>投资本钱：这笔钱能够确保不会影响我的日常生活以及轻微事故发生。</li>
<li>基金如何盈利的模式以及部分基本概念等，如夏普比，回撤率，波动率等。</li>
<li>关于自己对于风险承担能力的评估</li>
</ol>
<h2 id="2-投资目标的确定">2.投资目标的确定</h2>
<ol>
<li>了解基金的风险和盈利能力</li>
<li>复利计算法则：72法则，115法则等等
<ol>
<li>本金番一倍和翻两倍的计算公式，除年化率即可（在不计算通货膨胀的情况下）</li>
</ol>
</li>
</ol>
<h2 id="3-基金品种的选择">3.基金品种的选择</h2>
<ol>
<li>基金评价网站：晨星。
<ol>
<li>通过选择一家好的基金公司和一个好的基金经理比选择一只好的基金更重要</li>
<li>在股市摸爬滚打了好多年的基金经理远比一个刚毕业的学生更会打理你的钱财</li>
</ol>
</li>
<li>资产配置比率
<ol>
<li>资产配置：股票和债券的配比，这是与你的投资周期是确定的，投资周期长，股票比例高，当接近投资周期的末期时，债券比例提升，股票比例下降。（基金的激进性）</li>
<li>资产配置：核心资产和非核心资产以及瘟鸡：1.核心资产跟随投资周期选定，一般设置债券或者波动较小的基金组合或者大盘，中盘，小盘，采用核心+卫星的方式2.卫星作为非核心资产可以选择单一指数产品，非混合型。3.瘟鸡则是具有发展潜力，但是目前仍未显现的。</li>
<li>资产配置：保证每只基金的独立性。这样能够避免板块论调的风险。</li>
</ol>
</li>
<li>调控高净值下的手段：通过基金拆开和分红来解决</li>
<li>新基金和老基金的抉择：老基金</li>
<li>FOF和“生命周期”基金</li>
<li>分散投资和再平衡。</li>
</ol>
<h2 id="4-操作方法的实施">4.操作方法的实施</h2>
<ol>
<li>分红方式的选择：红利再投资</li>
<li>基金A类和C类的区别：前端收费还是后端收费，大于3年，A类，小于3年，C类</li>
<li>不要进行波段操作和预测市场</li>
<li>一次性投资和定投技术和分步进场
<ol>
<li>一次性投资就是一次性在低点全部投资进去</li>
<li>定投就是每周或者每月寻求低点投入，或选择智能定投，可以平滑掉市场的短期波动</li>
<li>分步进场就是根据总金额，进行分层投资。一步步入场</li>
</ol>
</li>
<li>持有基金的最优策略就是长期持有</li>
<li>基金赎回
<ol>
<li>达到投资周期目标</li>
<li>基本面受到改变，如基金的持仓情况、基金经理人的变化等</li>
<li>当市场非常狂热的时候</li>
</ol>
</li>
</ol>
<h2 id="5-投资实践">5.投资实践</h2>
<ol>
<li>绝对不能使用杠杆投资，一定是闲钱</li>
<li>我们的目的是降低风险，获取回报，而不是追求最大利益
<ol>
<li>我们的目的是降低风险，获取回报，而不是追求最大利益</li>
</ol>
</li>
<li>坚持长期持有</li>
<li>绝对不能进行波段操作</li>
<li>股市不会创造投资，我们赚的钱是企业发展的钱，是时代的钱。</li>
<li>对短期的震荡不要太过在意，记住这是一件长期持有的事情</li>
<li>积极进攻和被动防御
<ol>
<li>对一组由股票、债券和基金构成的动态投资组合，进行不断的研究，筛选和调控</li>
<li>以某种自动的方式，创建一个恒久的投资组合，不再付出更多的努力</li>
</ol>
</li>
</ol>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/dajiangdahe.github.io/tags/%E7%BB%8F%E6%B5%8E/" rel="tag">经济</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-【经济】指数基金投资指南"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/dajiangdahe.github.io/2021/10/22/%E3%80%90%E7%BB%8F%E6%B5%8E%E3%80%91%E6%8C%87%E6%95%B0%E5%9F%BA%E9%87%91%E6%8A%95%E8%B5%84%E6%8C%87%E5%8D%97/"
    >指数基金投资指南</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/dajiangdahe.github.io/2021/10/22/%E3%80%90%E7%BB%8F%E6%B5%8E%E3%80%91%E6%8C%87%E6%95%B0%E5%9F%BA%E9%87%91%E6%8A%95%E8%B5%84%E6%8C%87%E5%8D%97/" class="article-date">
  <time datetime="2021-10-22T07:21:45.148Z" itemprop="datePublished">2021-10-22</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/dajiangdahe.github.io/categories/%E4%B9%A6%E7%B1%8D/">书籍</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1>指数基金投资指南（雪球）</h1>
<h2 id="1-初识指数基金">1.初识指数基金</h2>
<ol>
<li>指数基金定义：根据指数编制方案，选择相应的成分股。是一篮子股票。</li>
<li>指数基金分类：（1）场内和场外基金：区别：场内基金具备股票性质，T+0交易。场外基金T+1交易。（2）大中小盘股：按照市值划分。（3）宽窄基：跟踪标的覆盖范围。（4）指数增强型：按照复制程度。（5）A和C类：按照收费形式不同，分为前端收费和后端收费。（6）加权基金：按以某种策略对其市值因子进行加权。</li>
<li>指数基金优点：1.具备优胜劣汰的功能。2.永久存在，无需考虑公司退市或倒闭的风险。3.持仓透明，无惧基金经纪人的道德风险。4.无需担心基金经理的能力不足。5.成本和费率优势。</li>
<li>指数基金缺点：1.无法获得超额收益。2.弱市行情的抗风险能力不足。</li>
<li>历史：2002年，华安基金发行上证180指数增强型基金。</li>
</ol>
<h2 id="2-如何挑选指数基金">2.如何挑选指数基金</h2>
<ol>
<li>指数分类
<ol>
<li>综合指数：反映出某个市场的情况。表征市场作用，投资功能较弱。如上证综指，沪深综指</li>
<li>综合指数：反映出某个市场的情况。表征市场作用，投资功能较弱。如上证综指，沪深综指</li>
<li>行业指数：根据《XXX分类标准》进行划分，将营收&gt;50%的划入其中。分为一级二级三级四级行业。需要有非常专业的知识。如中证能源，中证材料。</li>
<li>主题指数：自上而下的投资方式（主动投资）。通过评估社会的形态结构，确认某些领域的变革趋势和驱动因素。投资时间长把握中长期趋势。是行业的集合体。如：新能源主题，先进制造主题。</li>
<li>风格指数：成长型和价值型风格和稳定性。通过市净率，市盈率划分。分为大中小盘股。稳定性用于衡量股价对市场环境变化的敏感度。如300成长，300价值。成长型更激进，价值型更稳健。</li>
<li>策略指数：通过人为的调整这个部分符合特征条件的银子，目的是获取超额收益。编制方式采取了非市值加权的方式。包括基本面加权、波动率加权等。受益方向可以做多，也可以做空。不是单边的。</li>
</ol>
</li>
<li>指数选择纵向
<ol>
<li>指数点位法：通过大盘的估值进行选择。（如上证综指3500为高，2000为低。）
<ol>
<li>优点：简单明了，适合小白。此点位代表股价，也代表估值。</li>
<li>缺点：成分股不断变化，业绩也不是一成不变。局限性大，可作为观察指标</li>
</ol>
</li>
<li>市盈率法：股价/每股收益。或者市值/净利润，本益比。代表这一阶段的盈利水平。适用于较为稳健的行业，短期业绩波动一般不大的。如消费行业，公用事业。周期较强的容易失真：汽车行业、钢铁煤炭行业。
<ol>
<li>优点：单只股票的异常波动影响较低。具有较好的参考性。</li>
<li>缺点：如果大批量成分股出现异常波动，就会失真。</li>
</ol>
</li>
<li>市净率法：所有成分股的市值之和/与净资产之和，是一种相对静态的估值方法。适用于一定资产规模的行业。不适合互联网广告、游戏、影视行业。
<ol>
<li>优点：更加稳定，不容易失真。</li>
</ol>
</li>
<li>相对估值百分位法：评估当前估值在历史上的水平。高估、低估区等。
<ol>
<li>优点：简单易懂，实用性强，直观。</li>
<li>缺点：对于成立时间较晚的指数，缺乏数据，容易失真。</li>
</ol>
</li>
<li>价格指数和全收益指数：现金分红和红利再投资的区别。长期来看选择红利再投资较好。论证过于复杂。类似于微定投。（现金分红调整，市值降低。）
<ol>
<li>我们可以得出的结论是，指数成份股股本量、股息率与全收益指数超额收益率呈正相关关系，股本越大、股息率越高，全收益指数相对价格指数的超额收益率越高。全收益指数收益率与指数波动率呈负相关关系，波动率越低的指数，其全收益指数相对价格指数的超额收益率越高。</li>
</ol>
</li>
</ol>
</li>
<li>指数选择横向
<ol>
<li>基金规模：小众基金5~20亿。热门基金百亿较好。</li>
<li>综合费率：分为前端收费和后端收费：大于3年选择A类，小于3年选择C类。</li>
<li>跟踪误差：指数基金净值收益率与标的之间收益率直接的偏差。指标：日均跟踪偏离度绝对值，年化跟踪误差。误差越小越好。</li>
<li>流动性：升贴水率往往是流动性的重要参考指标。佳哥便宜净值幅度越低，流动性越好。（交易价格高于净值，升水，反之贴水。）</li>
</ol>
</li>
<li>资金配置方案
<ol>
<li>时间等分法：投资金额/投资月数、年、周等。</li>
<li>二八分割法：投资金额/投资月数=A，M为每个月定投比例，1-M为备用金。 Y（计划）=AxM+Ax(1-M),增强型即为备用金用不上，就攒到下个月投。
<ol>
<li>优点：应对突发情况更强</li>
</ol>
</li>
</ol>
</li>
<li>定投买入策略
<ol>
<li>基金定投取得成功的关键在于制定合适的定投策略与纪律性地执行策略。</li>
<li>定期定额法
<ol>
<li>优点：简单省心，金额、期限可控。</li>
<li>缺点：出现大幅下跌时，不能更好的平摊成本。大幅上涨时，会拉高成本。</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="3-定投买入策略">3.定投买入策略</h2>
<ol>
<li>
<p>基金定投取得成功的关键在于制定合适的定投策略与纪律性地执行</p>
</li>
<li>
<p>本次策略上分为上涨市、下跌市、先涨后跌市、先跌后涨市。其中每个策略进行过模拟、和已存在的基金进行回测。</p>
</li>
<li>
<p>1.定期定额法</p>
<ol>
<li>根据资金划分n期，平均分到n期上。
<ol>
<li>优点：定期定额法的优点是省心、简单易懂、金额可控、期限可控、风险平滑。只要在系统里设置好定投周期和每期的定投金额，剩下的就交给时间。对工薪阶层而言，定期定额的金额可控，可以合理地安排每个月的开支。</li>
<li>缺点：当然，定期定额法也存在很大的缺陷。例如，当市场出现大幅下跌后，有较大的把握可以判断市场处于底部阶段，但定期定额法依旧只能买入相同的金额，此时摊低成本的效果较差。当市场出现上涨时，也会拉高投资者的持仓成本。</li>
<li>适用人群：任意</li>
<li>适用人群：任意</li>
</ol>
</li>
<li>目标点位系数法
<ol>
<li>核心逻辑为：低位多买、高位少买。投资者以标的指数的点位作为参照物，心中给定一个目标点位，这个目标点位是投资者认为市场进入高位还是低位的临界点。例如：上证指数3400为参照物，高于3400即为高位入市，低于为低位入市。</li>
<li>申购金额：（目标指数点/当前指数点位）^n x 基础金额。n的选择根据自己，用来控制指数涨跌的幅度。一般10即可
<ol>
<li>优点：（1）具有出色的成本控制能力，回本周期极短。（2）收益率始终跑赢普通定投。（3）非常适合下跌市和先跌后涨市。</li>
<li>缺点：（1）需要投资者对目标点位作出相对准确的评估，增加了投资难度。（2）指数的成份股是动态变化的，单纯看指数点位有刻舟求剑之意。（3）在单边上涨趋势中，过于追求收益率会使得总投入的绝对金额过低，导致总盈利绝对金额较少。（4）每期定投金额不可控，无法提前预知，对投资者的资金量要求极高。（5）幂次方n的取值决定了收益率的弹性，虽然取值越高，成本控制越好、收益率越高，但每期定投金额也会相应变大，后期市场一旦进入下跌趋势，定投金额会非常高</li>
<li>适用人群：有大量闲散资金的投资者，有足够意志力和忍耐力的投资者</li>
</ol>
</li>
</ol>
</li>
<li>阶梯点位系数法
<ol>
<li>核心逻辑：阶梯点位系数法是目标点位系数法的简化版，它同样以标的指数的点位作为参照物，不同之处在于，阶梯点位系数法以标的指数的点位区间作为决策依据。当指数点位处于某个区间内，其申购金额是固定的。只有当标的指数的点位脱离该区间并进入另外一个区间时，申购金额才会发生变化。例如3000点为参照物。3000-3100：系数为0.5。2900-3000：系数为1.5</li>
<li>申购金额：Mx基础金额。M为系数
<ol>
<li>优点：（1）与普通定投法相比，阶梯点位系数法具有强大的收益率优势，在任何时候收益均不低于普通定投法，亏损比例比普通定投法少。（2）与目标点位系数法相比，阶梯点位系数法的定投金额相对可控。在阶梯点位系数法下，投资者可根据自己的风险偏好和资金情况适当调整M系数来调整每期的申购金额，每期最大的投资金额与最小投资金额事先已经知道，可做到心中有底。</li>
<li>缺点：（1）在熊市阶段，随着指数点位的走低，每期投入的资金会逐渐加大，对投资者的现金流会构成较大压力。（2）如果在刚买入基金后出现持续性牛市，阶梯点位系数法M系数的取值会自动下降，导致每期投入金额减少，未来盈利的绝对额也较少。（3）系数M的取值取决于每个投资者对指数点位的把控，需要投资者有较强的市场敏感度，对专业性要求较高，适用人群相应变窄。（4）指数的成份股定期调仓，指数点位也会不断变化，单纯参考历史行情来判断点位的高低有刻舟求剑之意。</li>
<li>适用人群：一定资金量，适当变化定投金额的投资者。 较高风险偏好和忍受较大的亏损和长久的等待。 空闲时间多的投资者。</li>
</ol>
</li>
</ol>
</li>
<li>成本偏离法
<ol>
<li>核心逻辑：偏离定投法，是指投资者预先选定某个指数的均线，这条均线可以是短期均线or长期均线，作为参照物。当指数点位出狱该均线下方时，投资者增加定投金额，位于上方，则减少定投金额。例如：支付宝的智能定投，选用的是中证500均线。</li>
<li>申购金额：成本偏离度x基础金额。（上期末持仓单位成本/本期预估单位净值）^n x 基础金额。
<ol>
<li>优点：（1）成本偏离法与目标点位系数法、阶梯点位系数法一样，对持仓成本的控制能力相当出色，可以获得比普通定投法更高的收益率。（2）具有较短的回本周期。（3）特别适合下跌市和先跌后涨市，适合“牛短熊长”的市场。</li>
<li>缺点：（1）与目标点位系数法相似，成本偏离法无法提前预知下一期的定投金额。（2）在市场处于上涨阶段，特别是牛市初期时，成本偏离法会自动降低成本偏离度系数，最终令投资者投入金额较低，赚到的绝对金额较少。（3）在市场处于底部横盘震荡阶段，市场往往较为低迷，容易出现低波动的行情，此时持仓成本与基金净值之间的偏离幅度较小，使得投入金额较低，最终可能错过大行情。（4）幂次方n的取值决定了收益率的弹性，虽然取值越高，成本控制越好，收益率越高，但需要投资者不断测试合适的数值，操作较为麻烦且专业性要求较高。（5）下跌市场中投入金额会不断增大，而且呈几何式增长，当申购金额与基础金额偏离过大时，容易对投资者构成现金流压力，造成定投断供的局面发生。（6）没有考虑市场估值，可能存在买贵的现象。</li>
<li>适用人群：有大量闲钱的投资者。承受风险能力较高的投资者。专业能力较强的投资者。</li>
</ol>
</li>
</ol>
</li>
<li>估值百分位法
<ol>
<li>核心逻辑：基于估值贵贱程度。这种方法的核心逻辑是在市场估值低时多买，估值高时少买。估值百分位，顾名思义，即当期的估值占某个指标的分位数，通常是以当期的估值占历史估值数据样本的百分位。如果估值百分位为10%，即代表当期的估值分位数在历史所有估值数据中处于前10%的位置，或者可以理解为当前的估值比历史上90%的时候要高或低。估值指标可以根据投资者的喜好自行选择，如市盈率、市净率、市销率等</li>
<li>申购金额：（1/（1-心里临界值）+估值百分位）^n x 基础金额
<ol>
<li>优点：（1）估值百分位法在控制持仓成本方面有较强的优势。（2）考虑了基本面情况，可避免在过于昂贵时买入资产，为投资者提供一定的安全边际。（3）该方法以估值为锚，避免以刻板的指数点位作为参照依据，更加客观合理。</li>
<li>缺点：（1）估值百分位法并不适用于所有指数。指数成立时间过短、指数底层资产的估值逻辑过于复杂，都有可能导致该方法失效。（2）估值百分位法需要选取合适的估值指标，指标数据和百分位均需要手动进行统计，操作过于复杂。（3）该方法需要投资者预估合理的心理临界值和幂次方n，投资者的专业性要求较高。（4）该方法可能存在指数点位与估值指标不能同向波动的情况。比如指数点位越低，估值指标反而越高，此情况下可能存在严重的形势误判，导致高位买入较多，低位买入较少，容易出现亏损。（5）估值百分位法对投资者的现金流要求极高，如果没有足够的资金量和充足的心理准备，容易出现定投停止，断供则会使浮亏变成真实亏损，导致前功尽弃。</li>
<li>适用人群：大量闲散资金的投资者。风险能力承受较高。专业能力强。专注于基本面的投资。</li>
</ol>
</li>
</ol>
</li>
<li>6.改进价值平均策略
<ol>
<li>核心逻辑：价值平均策略则完全摒弃了本金，而以目标市值作为投资目标，当目标市值等于持仓市值时，该方法的目标便达成了。所谓目标市值，指的是随着时间的推移，投资者期望得到的资产市值，也有人将目标市值称为“目标价值”。例如，投资者期望股市里的持仓市值每月递增1 000元，定投10个月后，持仓市值只要达到10 000元即被视为完成目标。</li>
<li>申购金额：市值差额系数x基础金额。（本期目标市值/本期预估基金单位净值x上期持仓份额）x 基础金额。
<ol>
<li>优点：（1）弥补了传统价值平均策略由于高抛低吸导致的本金投入水平过低的缺陷。（2）与普通定投法相比，改进价值平均策略有着强大的成本控制能力，收益率优势显著。</li>
<li>缺点：（1）牛市阶段投入与产出的绝对值可能跑输普通定投法。（2）每期申购金额波动范围较大，对投资者的现金流构成较大压力。（3）需要人为设置目标市值及目标市值每期的递增金额，如果目标市值的设定过于离谱，容易对投资者的现金流构成较大压力。另外，操作也相对烦琐，需要定期审视目标市值与持仓市值的差额。（4）未考虑底层资产的估值与性价比。</li>
<li>适用人群：专业性极强</li>
</ol>
</li>
</ol>
</li>
<li>恒定亏损比例策略
<ol>
<li>核心逻辑：无论基金净值如何波动，投资者定投基金的最大亏损不能低于一个恒定的数值，该数值是投资者可以承受的最大亏损比例。当定投收益率低于该数值时，通过测算得出需要追加买入的资金量，令收益率回升至投资者可以承受的最大亏损幅度。</li>
<li>申购金额：每一期投入金额的时候，需保证当月收益维持在可以最大亏损幅度的底线。例如一直维持-10%
<ol>
<li>优点：（1）极强的成本控制能力。恒定亏损比例策略有着无与伦比的成本控制能力，在本书所有定投策略中，该策略对持仓成本的控制能力首屈一指。只要投资者的资金量足够充裕，并合理设定各项参数，该策略几乎可以帮助投资者将亏损幅度控制在自己想要的任何水平。（2）极短的回本周期。恒定亏损比例策略平抑波动的方式来自当期申购前总收益率R&lt;恒定亏损比例Y时，该策略的疯狂加码买入拉低了持仓成本；当R&gt;0时，恒定亏损比例策略停止买入压制住持仓成本的上行，因此持仓成本只会下降不会上涨，极大地缩短了回本周期。（3）天然适用于熊长牛短的市场。</li>
<li>缺点：（1）适用人群极其狭窄。由于在熊市阶段恒定亏损比例策略的定投金额会呈现几何级爆炸增长，对投资者的资金量要求非常苛刻，需要投资者有足够的资金储备。该策略适用人群极其狭窄，广大工薪阶层未必适合该策略。（2）该策略需要投资者具备钢铁般的意志与纪律性，特别是在熊市阶段，如果出现断供，中途退出导致的绝对损失将十分庞大。（3）该策略在牛市时收益率同样超越普通定投法，但投入本金的绝对值可能存在过低的风险。如果本金投入过低，为投资者赚取的绝对回报也将减少。（4）该策略需要投资者设定合理的恒定亏损比例参数、基础金额参数，以及挑选合适的进场时机，对投资者的专业性提出极高的要求，操作较为烦琐。</li>
<li>适用人群：极其专业人员。超大量资金人员</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>
<p>定投止盈策略</p>
<ol>
<li>卖出公式有三种：一次性止盈公式、等额分批止盈公式、非等额分批止盈公式。</li>
<li>也是依据在上涨市、下跌市、先跌后涨市、先涨后跌市下的模拟与回测。</li>
<li>目标收益率法：核心逻辑：<strong>达到心中的预计收益率卖出</strong>
<ol>
<li>优点：应用广泛、操作简单。</li>
<li>缺点：当行情波动较为复杂，实际收益率能够达到投资者预计的目标收益率存在较大的不确定性。一旦设定目标夸张，容易盈利回吐甚至亏损。</li>
<li>适用人群：任意</li>
</ol>
</li>
<li>目标估值法：核心逻辑：标的估值达到投资者预估的合理估值上限后进行止盈，与收益率无关。例如上证3700选择止盈。
<ol>
<li>优点：考虑到了底层资产的基本面情况。资产的跪着被纳入决策系统，更加客观、合理</li>
<li>缺点：操作略微复杂，标的指数的估值波动于标的的指数点位并非时时对应。适用于相对稳定的市场。（个人感觉美股/长期利好行业。）</li>
<li>适用人群：具备基本知识面投资和一定的专业能力</li>
</ol>
</li>
<li>均线止盈法：核心逻辑：党目标物跌破参照物时，触发止盈。这里的参照物是指投资者预估的某条均线。例如30日均线。60日均线等。
<ol>
<li>优点：直观、易懂。具备K线基础知识即可轻松驾驭。</li>
<li>缺点：市场是随机的波动的，历史不一定会重复。</li>
<li>适用人群：适用于大部分投资者和一定技术分析能力的投资者。</li>
</ol>
</li>
<li>回撤止盈法：核心逻辑：价格回落到均线位置，直至跌破该均线后认定市场已经击穿某一关键位置，此时便可止盈。例如击穿箱体的一刻。或者回撤率达到15%的时候选择止盈。
<ol>
<li>优点：具备基本K线知识即可掌握。</li>
<li>缺点：需要频繁盯盘，合理预估可承受最大回撤值。容易错过大行情or被套。个人建议10%-20%回撤。</li>
<li>适用人群：闲暇时间多者。</li>
</ol>
</li>
<li>可转债转股止盈法（了解）、斜率偏离法（通过判断通道来判断是否止盈，触及通道顶部止盈。）</li>
</ol>
</li>
</ol>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/dajiangdahe.github.io/tags/%E7%BB%8F%E6%B5%8E/" rel="tag">经济</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-【经济】共同基金"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/dajiangdahe.github.io/2021/10/22/%E3%80%90%E7%BB%8F%E6%B5%8E%E3%80%91%E5%85%B1%E5%90%8C%E5%9F%BA%E9%87%91/"
    >共同基金</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/dajiangdahe.github.io/2021/10/22/%E3%80%90%E7%BB%8F%E6%B5%8E%E3%80%91%E5%85%B1%E5%90%8C%E5%9F%BA%E9%87%91/" class="article-date">
  <time datetime="2021-10-22T07:21:45.138Z" itemprop="datePublished">2021-10-22</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/dajiangdahe.github.io/categories/%E4%B9%A6%E7%B1%8D/">书籍</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1>共同基金常识（投资圣经）</h1>
<h2 id="1-投资策略">1.投资策略</h2>
<h3 id="1-长期投资：强斯与花园">1.长期投资：强斯与花园</h3>
<ol>
<li>一个分散化的投资组合可将风险降低至股票和债券市场的平均水平，从而使持有单只证券的风险最小化。</li>
<li>当我们信心低迷时，市场估值很可能具有吸引力。我们完全可以称其为“投资的悖论”。
<ol>
<li>投资悖论出现的时候，正是价值投资布局的开始</li>
</ol>
</li>
<li>花园历经季节的循环变化，与经济和金融市场的周期类似。
<ol>
<li>我们中的很多人忘记了自然界与人类社会的相通之处。正如自然界一样，从长期来看，我们的经济体系保持着稳定和理性，这就是我们不必害怕自然规律的原因……我们坦然迎接不可避免的季节更替，却为经济的周期变动而烦恼，我们是多么愚蠢啊！”</li>
</ol>
</li>
<li>若想投资成功，你必须成为一个长期投资者。
<ol>
<li>时间越长，年平均回报率的波动越小。投资者不应该低估时间跨度。</li>
<li>风险不是短期的波动，因为长期投资者可以忽略短期波动。而且，并不存在任何预定的回报率，而仅仅可能是一个无法实现的期望回报率，风险是这样一种可能性。在长期，股票的回报可能很差。</li>
<li>我们的经济就像一个健康肥沃的花园，那么收获长期回报的最佳方式是：如同怀着期望播下增长的种子一样，投资于普通股。但是，你必须也要做好准备以应对不可预料的寒冬侵袭。那时，债券将扮演关键角色。</li>
<li>长期投资者应当将债券纳入其投资组合，将其作为针对股票短期波动的不足的弥补。这样的一种平衡投资策略将在第3章详细讨论。无论市场上涨或下跌，选择一个包括股票和债券的理性平衡组合，并坚定地持有它，你不仅可以积累收益并且可抵抗逆境。</li>
<li>如果长期投资的理想是构造一个在股票和债券间分散投资的合理平衡组合，无论市场如何变迁都始终持有它，并力争将成本保持在最低。这应该成为共同基金经理和投资者一致崇尚的原则。</li>
</ol>
</li>
<li>不管历史记录是多么牢靠，过去的经验仍然无法保证未来的成功。然而，对过去的探究，加之使人自律的常识，这依然是一个聪明投资者最可依靠的方法。</li>
<li>仔细关注我们可以控制的投资要素：风险、成本和时间，那么，一个长期的投资计划必将在未来获益。
<ol>
<li>比较有意思的是 三大要素里面没有收益，而像我这种小白最开始考虑的是 收益与风险。逐利性摆放在最前面就意味着遮挡了一些重要的信息 比如这里提出的风险 成本 时间。换句话说 只有当你控制好了以上三大要素 收益是自然而然就会到来的。</li>
<li>基金选择的关键不在于只关注未来的回报，因为这是投资者所不能控制的，而应关注风险、成本和时间这些投资者能够控制的因素</li>
</ol>
</li>
<li>我们不能仅依靠情感，更要依赖理智，去洞察具有创造力和创新性的美国经济在长期中如何增长。</li>
<li>黄金不像股票和债券，它不能产生内部价值；而股票可以通过盈利增长和股利分红产生内部价值；债券则可通过利息支付取得内部价值。</li>
<li>投资的目的在于积累实际财富，这表现为不断提高对商品和服务的购买能力，因而长期投资的最终目标一定是实际回报率而非名义回报率。</li>
<li>标准差：衡量年回报率范围的指标
<ol>
<li>从学术角度看，标准差是一个公认的测度变异性的指标。在给定的时间范围内，它指出了投资回报的变动范围。例如，如果某项投资的平均年回报率为10%，且年回报率有2/3可能会处在–5%～+25%的范围以内（在上下任何一个方向上都有15%的变化），则年回报率的标准差为15%。而两倍标准差将涵盖95%的年回报率的变动范围。</li>
</ol>
</li>
<li>馅饼理论：面对市场这个馅饼，你赚取超过平均值的回报率就是较不成功的人的回报率与平均值的差额。（不计算成本）这就是较成功的投资者。
<ol>
<li>如果将这个回报率视作一个扁平的圆形平面，比如一张馅饼，根据定义，11%就是那张全部市场参与者能够分配的馅饼。如果我们汇总所有表现较好的投资者的回报率，其回报率一定会被所有表现较差的投资者的总回报率所抵消。准确地讲，抵消的幅度相等。这就是那张扣减成本前的总馅饼。</li>
</ol>
</li>
<li>在任何逐月甚至逐年的短期基础上，市场完全不可预测。我们既不应当指望它变得可预测，也不应当根据传统观念所引发的冲动做出投资决策。无论这些号召来自权威刊物的头条，还是来自我们日常的希望和恐惧，它们通常会让我们关注短期，模糊我们对长期的认识。</li>
<li>除去我所引用的一些“表现最佳”的共同基金（那些遵从相对稳定的低换手率策略者），共同基金业现在正走向一条只能创造更少价值的道路。
<ol>
<li>我们需要去寻找稳定的低换手率策略者所持有的优秀基金，并且坚定的相信他。</li>
<li>绝大多数基金只要仅仅在年初持有其投资组合不变，并在随后的12个月中不采取任何操作，都能获得更高的回报率。</li>
<li>市场择时只是失败的策略之一；投资组合的高换手率亦是最无效的。无论是对基金还是基金投资者而言，换手率不断提高所导致的高成本和高税收，注定将使情况更糟糕。
<ol>
<li>不能盲目择时</li>
<li>投资的组合不能高换手率</li>
</ol>
</li>
<li>无论市场潮起潮落，都持有一个股票和债券保持合理均衡的投资组合，并达到合理的平衡。
<ol>
<li>给予你的投资组合足够的时间，让它受益于复利的魔力，并使你的成本最低。</li>
</ol>
</li>
</ol>
</li>
<li>巴菲特先生描绘其不同寻常的有效投资方法为：保持“我们所主要持有的大多数股票，不管其价格相对于其（当前的）内在价值是多少……至死不渝……我们一直在找寻确信在未来一二十年仍有巨大潜力的企业。作为投资者，对于动荡的行业，我们应像对待太空探险一样，为努力而喝彩，但我们宁愿置身其外”。</li>
<li>市场上投机行为的强势地位，来自投资者持有股票数量的不断增长，而这些投资者“毫无专业投资知识……而传统的股票定价方法，是基于大量无知个体的群体心理”。专业投资者及证券行业专家的意见将不能抵消群体的观点，于是他们将试图去预测公众对股票估值的变化。</li>
<li>生存法则
<ol>
<li>你必须投资</li>
<li>时间是你的朋友</li>
<li>冲动是你的敌人</li>
<li>掌握基本的算术</li>
<li>坚持简单化并且坚持到底</li>
</ol>
</li>
</ol>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/dajiangdahe.github.io/tags/%E7%BB%8F%E6%B5%8E/" rel="tag">经济</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-【散文】奶牛的秘密生活"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/dajiangdahe.github.io/2021/10/22/%E3%80%90%E6%95%A3%E6%96%87%E3%80%91%E5%A5%B6%E7%89%9B%E7%9A%84%E7%A7%98%E5%AF%86%E7%94%9F%E6%B4%BB/"
    >奶牛的秘密生活</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/dajiangdahe.github.io/2021/10/22/%E3%80%90%E6%95%A3%E6%96%87%E3%80%91%E5%A5%B6%E7%89%9B%E7%9A%84%E7%A7%98%E5%AF%86%E7%94%9F%E6%B4%BB/" class="article-date">
  <time datetime="2021-10-22T07:21:45.115Z" itemprop="datePublished">2021-10-22</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/dajiangdahe.github.io/categories/%E4%B9%A6%E7%B1%8D/">书籍</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1><strong>《奶牛的秘密生活》（罗莎曼德 扬）</strong></h1>
<p>这本书最值的思考的一个地方就是，如果我们爱他（无论是友情、爱情、亲情）我们都应该积极的参与他们的生活，观察他们的喜好。这不仅仅是我们表达爱意的一种方式，更是一种我可以换位思考，处在对方的角度去思考问题的理解。</p>
<p>令：这本散文书并不没有全部的看完，实际上随着年龄和阅读理解的增长，看这种类型的书，一部分就能够明白作者要讲述什么内容，也就没有全部看完的必要。（主要是对散文实在不感冒，就像村上春树的《大萝卜和难挑的鳄梨》，或者陈平原《神神鬼鬼》、或者钱理群《说东道西》）倒是觉得这种散文类型的书像是厕所读书，他只应该呆在厕所的架子上，陪伴自己度过“美妙”的一段时间。</p>
<p>摘1：合适的食物是健康的起点和终点。</p>
<p>今日2021.3.21，体重138，最近一周并没有管住自己的口腹之欲，导致为期一周的200min+时长浪费了。自律果然是最难的，以后要分成一周一周去管理时间（事实上也很难），管理饮食，这样就躲避了连续几个月想象不到的痛苦和折磨（吃的时候其实并没有那么折磨，这减肥路上的绊脚石是真滴多）（好吃的也太多了）</p>
<p>摘2：关于奶牛你应该知道的二十件事（懒的打出来了，截图吧）</p>
<img src="/dajiangdahe.github.io/2021/10/22/%E3%80%90%E6%95%A3%E6%96%87%E3%80%91%E5%A5%B6%E7%89%9B%E7%9A%84%E7%A7%98%E5%AF%86%E7%94%9F%E6%B4%BB/clipboard.png" class="" title="img">
<p>摘3：关于绵羊你应该知道的二十件事</p>
<img src="/dajiangdahe.github.io/2021/10/22/%E3%80%90%E6%95%A3%E6%96%87%E3%80%91%E5%A5%B6%E7%89%9B%E7%9A%84%E7%A7%98%E5%AF%86%E7%94%9F%E6%B4%BB/clipboard-1631537089379.png" class="" title="img">
<p>摘4：关于母鸡你应该知道的二十件事</p>
<img src="/dajiangdahe.github.io/2021/10/22/%E3%80%90%E6%95%A3%E6%96%87%E3%80%91%E5%A5%B6%E7%89%9B%E7%9A%84%E7%A7%98%E5%AF%86%E7%94%9F%E6%B4%BB/clipboard-1631537104447.png" class="" title="img">
<p>摘5：关于猪你应该知道的二十件事</p>
<img src="/dajiangdahe.github.io/2021/10/22/%E3%80%90%E6%95%A3%E6%96%87%E3%80%91%E5%A5%B6%E7%89%9B%E7%9A%84%E7%A7%98%E5%AF%86%E7%94%9F%E6%B4%BB/clipboard-1631537118561.png" class="" title="img">
<p>令2：关于我自己的二十件你必须知道的事情</p>
<p>1.你必须知道我好看</p>
<p>2.你必须知道我有趣</p>
<p>3.你必须知道我喜欢吃好吃的</p>
<p>4.你必须承认我有魅力</p>
<p>5.虽然很不爱卫生，但是出门前一定收拾的很利索</p>
<p>6.我每天早上都会对着镜子笑一笑</p>
<p>7.吃饭的时候必须看武林外传</p>
<p>8.喜欢浅色系衣服</p>
<p>9.喜欢时而可爱，时而躁动的美女，你不美可以，但得漂亮</p>
<p>10.我不高兴的时候就只想躺在床上</p>
<p>11.我喜欢出去玩，一个人也很喜欢</p>
<p>12.我承认自己有时候很废柴</p>
<p>13.我非常暴躁，但是我能有一群可爱的朋友</p>
<p>14.如果引起了争辩，我会拿出十二分精神来，请不要说这是“开玩笑”…</p>
<p>15.你必须直接用你的专业素养击败我。</p>
<p>16.我会承认比我强的人，我也不会嫉妒他们，会学着打败他们</p>
<p>17.我每天都需要睡午觉，这是脾气最差的时候</p>
<p>18.很讨厌不明确某个“概念”的人对我进行指导，因为我这就是这样的人</p>
<p>19.我会关心人</p>
<p>20.看完的人可以给我介绍女朋友了</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/dajiangdahe.github.io/tags/%E6%95%A3%E6%96%87/" rel="tag">散文</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-【ZZ】论ZY"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/dajiangdahe.github.io/2021/10/22/%E3%80%90ZZ%E3%80%91%E8%AE%BAZY/"
    >论ZY</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/dajiangdahe.github.io/2021/10/22/%E3%80%90ZZ%E3%80%91%E8%AE%BAZY/" class="article-date">
  <time datetime="2021-10-22T07:21:45.098Z" itemprop="datePublished">2021-10-22</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/dajiangdahe.github.io/categories/%E4%B9%A6%E7%B1%8D/">书籍</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1>论ZY（约翰·穆勒）</h1>
<h2 id="1-导读">1.导读</h2>
<img src="/dajiangdahe.github.io/2021/10/22/%E3%80%90ZZ%E3%80%91%E8%AE%BAZY/image-20211226230618684.png" class="" title="image-20211226230618684">
<h2 id="2-引论">2.引论</h2>
<img src="/dajiangdahe.github.io/2021/10/22/%E3%80%90ZZ%E3%80%91%E8%AE%BAZY/image-20211226230641574.png" class="" title="image-20211226230641574">
<img src="/dajiangdahe.github.io/2021/10/22/%E3%80%90ZZ%E3%80%91%E8%AE%BAZY/image-20211226230652998.png" class="" title="image-20211226230652998">
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/dajiangdahe.github.io/tags/zz/" rel="tag">zz</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
  </article>
  

  
  <nav class="page-nav">
    
    <a class="extend prev" rel="prev" href="/dajiangdahe.github.io/">上一页</a><a class="page-number" href="/dajiangdahe.github.io/">1</a><span class="page-number current">2</span><a class="page-number" href="/dajiangdahe.github.io/page/3/">3</a><a class="page-number" href="/dajiangdahe.github.io/page/4/">4</a><a class="extend next" rel="next" href="/dajiangdahe.github.io/page/3/">下一页</a>
  </nav>
  
</section>
</div>

      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2021
        <i class="ri-heart-fill heart_icon"></i> kengkeng
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/dajiangdahe.github.io/"><img src="/images/ayer-side.svg" alt="kengkeng&#39;s life"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/dajiangdahe.github.io/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/dajiangdahe.github.io/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/dajiangdahe.github.io/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/dajiangdahe.github.io/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/dajiangdahe.github.io/tags/%E6%97%85%E8%A1%8C/">旅行</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" target="_blank" rel="noopener" href="http://shenyu-vip.lofter.com">摄影</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/dajiangdahe.github.io/friends">友链</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/dajiangdahe.github.io/2019/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/dajiangdahe.github.io/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/dajiangdahe.github.io/js/jquery-3.6.0.min.js"></script>
 
<script src="/dajiangdahe.github.io/js/lazyload.min.js"></script>

<!-- Tocbot -->

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>

<script src="/dajiangdahe.github.io/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/dajiangdahe.github.io/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/dajiangdahe.github.io/css/clipboard.css">
 <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div>
</body>

</html>