<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
        
      <meta name="description" content="Hello,here is kengkeng&#39;s blog." />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>Redis内存策略 |  kengkeng&#39;s life</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dajiangdahe.github.io/dist/main.css">

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css"
      />
      
<link rel="stylesheet" href="/dajiangdahe.github.io/css/custom.css">
 
      <script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    </head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-Redis内存策略"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  Redis内存策略
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/dajiangdahe.github.io/2021/10/22/Redis%E5%86%85%E5%AD%98%E7%AD%96%E7%95%A5/" class="article-date">
  <time datetime="2021-10-22T07:21:45.013Z" itemprop="datePublished">2021-10-22</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/dajiangdahe.github.io/categories/Redis/">Redis</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">4.6k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">17 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <h1>Redis内存淘汰策略</h1>
<p>当 redis 的内存空间（maxmemory 参数配置）已经用满时，redis 将根据配置的驱逐策略（maxmemory-policy 参数配置），进行相应的动作。在redis4.0之后，增加了两种基于LFU算法实现的内存淘汰策略</p>
<ul>
<li><strong>noeviction</strong>：默认策略，不淘汰任何 key，直接返回错误</li>
<li><strong>allkeys</strong>-<strong>lru</strong>：在所有的 key 中，使用 LRU 算法淘汰部分 key</li>
<li><strong>allkeys</strong>-<strong>lfu</strong>：在所有的 key 中，使用 LFU 算法淘汰部分 key，该算法于 Redis 4.0 新增</li>
<li><strong>allkeys</strong>-<strong>random</strong>：在所有的 key 中，随机淘汰部分 key</li>
<li><strong>volatile</strong>-<strong>lru</strong>：在设置了过期时间的 key 中，使用 LRU 算法淘汰部分 key</li>
<li><strong>volatile</strong>-<strong>lfu</strong>：在设置了过期时间的 key 中，使用 LFU 算法淘汰部分 key，该算法于 Redis 4.0 新增</li>
<li><strong>volatile</strong>-<strong>random</strong>：在设置了过期时间的 key 中，随机淘汰部分 key</li>
<li><strong>volatile</strong>-<strong>ttl</strong>：在设置了过期时间的 key 中，挑选 TTL（time to live，剩余时间）短的 key 淘汰</li>
</ul>
<h3 id="LRU算法">LRU算法</h3>
<p>在操作系统中<strong>LRU</strong>算法淘汰的<strong>不是内存中的对象</strong>，而是页,当内存中数据不足时，通过LRU算法，选择<strong>一页</strong>(一般是4KB)将其交换到虚拟内存区(<strong>Swap</strong>区)。</p>
<p>默认情况下，Redis随机挑选5个键，并且从中选取一个最近最久未使用的key进行淘汰，在配置文件中可以通过maxmemory-samples的值来设置redis需要检查key的个数,但是栓查的越多，耗费的时间也就越久,但是结构越精确</p>
<p>详解：<a target="_blank" rel="noopener" href="https://blog.csdn.net/kuizhu7142/article/details/81115750">https://blog.csdn.net/kuizhu7142/article/details/81115750</a></p>
<p>【<strong>命中率</strong>】</p>
<p>当存在热点数据时，LRU的效率很好，但偶发性的、周期性的批量操作会导致LRU命中率急剧下降，缓存污染情况比较严重。</p>
<p>【<strong>复杂度</strong>】</p>
<p>实现简单。</p>
<p>【<strong>代价</strong>】</p>
<p>命中时需要遍历链表，找到命中的数据块索引，然后需要将数据移到头部。</p>
<img src="/dajiangdahe.github.io/2021/10/22/Redis%E5%86%85%E5%AD%98%E7%AD%96%E7%95%A5/aHR0cDovL2ltYWdlcy5jbml0YmxvZy5jb20vYmxvZzIwMTUvNDcxNTMyLzIwMTUwMy8yNTE5NTQzNDk3NDIyMjAucG5n" class="" title="在这里插入图片描述">
<ul>
<li>最开始时，内存空间是空的，因此依次进入A、B、C是没有问题的。</li>
<li>当加入D时，就出现了问题，内存空间不够了，因此根据LRU算法，内存空间中A待的时间最为久远，选择A,将其淘汰。</li>
<li>当再次引用B时，内存空间中的B又处于活跃状态，而C则变成了内存空间中，近段时间最久未使用的。</li>
<li>当再次向内存空间加入E时，这时内存空间又不足了，选择在内存空间中待的最久的C将其淘汰出内存，这时的内存空间存放的对象就是E-&gt;B-&gt;D。</li>
</ul>
<h4 id="实现原理">实现原理</h4>
<p>传统意义的LRU算法是为每一个Cache对象设置一个计数器，每次Cache命中则给计数器+1，而Cache用完，需要淘汰旧内容，放置新内容时，就查看所有的计数器，并将最少使用的内容替换掉。</p>
<p>它的弊端很明显，如果Cache的数量少，问题不会很大， 但是如果Cache的空间过大，达到10W或者100W以上，一旦需要淘汰，则需要遍历所有计算器，其性能与资源消耗是巨大的，效率也就非常的慢了。</p>
<p>它的原理： 将Cache的所有位置都用双连表连接起来，当一个位置被命中之后，就将通过调整链表的指向，将该位置调整到链表头的位置，新加入的Cache直接加到链表头中。</p>
<p>这样，在多次进行Cache操作后，最近被命中的，就会被向链表头方向移动，而没有命中的，而想链表后面移动，链表尾则表示最近最少使用的Cache。</p>
<p>当需要替换内容时候，链表的最后位置就是最少被命中的位置，我们只需要淘汰链表最后的部分即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LRUCache</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">LinkedHashMap</span>&lt;<span class="hljs-title">Integer</span>, <span class="hljs-title">Integer</span>&gt;</span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> capacity;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">LRUCache</span><span class="hljs-params">(<span class="hljs-keyword">int</span> capacity)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>(capacity, <span class="hljs-number">0.75F</span>, <span class="hljs-keyword">true</span>);<br>        <span class="hljs-keyword">this</span>.capacity = capacity;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">get</span><span class="hljs-params">(<span class="hljs-keyword">int</span> key)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.getOrDefault(key, -<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">put</span><span class="hljs-params">(<span class="hljs-keyword">int</span> key, <span class="hljs-keyword">int</span> value)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>.put(key, value);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">removeEldestEntry</span><span class="hljs-params">(Map.Entry&lt;Integer, Integer&gt; eldest)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> size() &gt; capacity; <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LRUCache</span> </span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DLinkedNode</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> key;<br>        <span class="hljs-keyword">int</span> value;<br>        DLinkedNode prev;<br>        DLinkedNode next;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DLinkedNode</span><span class="hljs-params">()</span> </span>&#123;&#125;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DLinkedNode</span><span class="hljs-params">(<span class="hljs-keyword">int</span> _key, <span class="hljs-keyword">int</span> _value)</span> </span>&#123;key = _key; value = _value;&#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> Map&lt;Integer, DLinkedNode&gt; cache = <span class="hljs-keyword">new</span> HashMap&lt;Integer, DLinkedNode&gt;();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> size;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> capacity;<br>    <span class="hljs-keyword">private</span> DLinkedNode head, tail;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">LRUCache</span><span class="hljs-params">(<span class="hljs-keyword">int</span> capacity)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.size = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">this</span>.capacity = capacity;<br>        <span class="hljs-comment">// 使用伪头部和伪尾部节点</span><br>        head = <span class="hljs-keyword">new</span> DLinkedNode();<br>        tail = <span class="hljs-keyword">new</span> DLinkedNode();<br>        head.next = tail;<br>        tail.prev = head;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">get</span><span class="hljs-params">(<span class="hljs-keyword">int</span> key)</span> </span>&#123;<br>        DLinkedNode node = cache.get(key);<br>        <span class="hljs-keyword">if</span> (node == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<br>        &#125;<br>        <span class="hljs-comment">// 如果 key 存在，先通过哈希表定位，再移到头部</span><br>        moveToHead(node);<br>        <span class="hljs-keyword">return</span> node.value;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">put</span><span class="hljs-params">(<span class="hljs-keyword">int</span> key, <span class="hljs-keyword">int</span> value)</span> </span>&#123;<br>        DLinkedNode node = cache.get(key);<br>        <span class="hljs-keyword">if</span> (node == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-comment">// 如果 key 不存在，创建一个新的节点</span><br>            DLinkedNode newNode = <span class="hljs-keyword">new</span> DLinkedNode(key, value);<br>            <span class="hljs-comment">// 添加进哈希表</span><br>            cache.put(key, newNode);<br>            <span class="hljs-comment">// 添加至双向链表的头部</span><br>            addToHead(newNode);<br>            ++size;<br>            <span class="hljs-keyword">if</span> (size &gt; capacity) &#123;<br>                <span class="hljs-comment">// 如果超出容量，删除双向链表的尾部节点</span><br>                DLinkedNode tail = removeTail();<br>                <span class="hljs-comment">// 删除哈希表中对应的项</span><br>                cache.remove(tail.key);<br>                --size;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 如果 key 存在，先通过哈希表定位，再修改 value，并移到头部</span><br>            node.value = value;<br>            moveToHead(node);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addToHead</span><span class="hljs-params">(DLinkedNode node)</span> </span>&#123;<br>        node.prev = head;<br>        node.next = head.next;<br>        head.next.prev = node;<br>        head.next = node;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">removeNode</span><span class="hljs-params">(DLinkedNode node)</span> </span>&#123;<br>        node.prev.next = node.next;<br>        node.next.prev = node.prev;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">moveToHead</span><span class="hljs-params">(DLinkedNode node)</span> </span>&#123;<br>        removeNode(node);<br>        addToHead(node);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> DLinkedNode <span class="hljs-title">removeTail</span><span class="hljs-params">()</span> </span>&#123;<br>        DLinkedNode res = tail.prev;<br>        removeNode(res);<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="LFU算法">LFU算法</h2>
<p>LFU（Least Frequently Used）算法，即最少访问算法，根据访问缓存的历史频率来淘汰数据，核心思想是“如果数据在过去一段时间被访问的次数很少，那么将来被访问的概率也会很低”。如果两个元素的访问频率相同，则淘汰最久没被访问的元素。也就是说LFU淘汰的时候会选择两个维度，先比较频率，选择访问频率最小的元素；如果频率相同，则按时间维度淘汰掉最久远的那个元素。</p>
<p>一般会维护两个数据结构：</p>
<ul>
<li>
<p>哈希：用来提供对外部的访问，查询效率更高；</p>
</li>
<li>
<p>双向链表或队列：维护了对元素访问次数的排序</p>
<p>缓存操作导致的链表变化：</p>
</li>
<li>
<p>添加新元素：新元素访问次数为1，放到队尾；</p>
</li>
<li>
<p>缓存淘汰：从队尾开始淘汰，因为队尾元素的访问次数最少；</p>
</li>
<li>
<p>访问缓存：访问缓存会增加元素的访问次数，所以元素在队列或双向链表中的位置会重新排序</p>
</li>
</ul>
<img src="/dajiangdahe.github.io/2021/10/22/Redis%E5%86%85%E5%AD%98%E7%AD%96%E7%95%A5/93e8e91e143ea01757667be4b54e4a10.png" class="" title="img">
<p>这里的key就是输入的key，没什么特别的。<strong>关键是value</strong>，它的value不是一个简单的value，而是一个节点对象。节点对象<strong>Node</strong>包含了<strong>key，value，以及频率</strong>，这个Node又会出现在第二个哈希表的value中(等会我们再说)。至于为什么Node中又重复包含了key，因为某些情况下我们不是通过k-v哈希表拿到Node的，而是通过其他方式获得了Node，之后需要用Node中的key反向去k-v哈希表中做一些操作，所以Node中包含了一些冗余信息。</p>
<img src="/dajiangdahe.github.io/2021/10/22/Redis%E5%86%85%E5%AD%98%E7%AD%96%E7%95%A5/23d1c0e3501b4b82b5eca0b9a631dc18.png" class="" title="img">
<p>这张<strong>哈希表中的key是频率</strong>，也就是元素被访问的频率(被访问了1次，被访问了两次等等)，<strong>它的value是一个双向链表刚才说的Node对象，现在又出现了，这里的Node其实是双向链表中的一个节点</strong>。第一张图中我们说了Node中包含了一个冗余的key，其实它还包含了一个冗余的频率值，因为某些情况下，我们需要通过Node中的频率值，反向去频率哈希表中做查找，所以也需要一个冗余的频率值。</p>
<img src="/dajiangdahe.github.io/2021/10/22/Redis%E5%86%85%E5%AD%98%E7%AD%96%E7%95%A5/c5bf76ee14075961a202f8dbf6dcb6b2.png" class="" title="img">
<ul>
<li>优点 ：一般情况下，LFU效率要优于LRU，能够避免周期性或者偶发性的操作导致缓存命中率下降的问题。</li>
<li>缺点：<strong>复杂度较高</strong>：需要额外维护一个队列或双向链表，复杂度较高。
<ul>
<li><strong>对新缓存不友好</strong>：新加入的缓存容易被清理掉，即使可能会被经常访问</li>
<li><strong>缓存污染</strong>：一旦缓存的访问模式发生变化，访问记录的历史存量，会导致缓存污染；</li>
<li><strong>内存开销</strong>：需要对每一项缓存数据维护一个访问次数，内存成本较大；</li>
<li><strong>处理器开销</strong>：需要对访问次数排序，会增加一定的处理器开销</li>
</ul>
</li>
</ul>
<h3 id="算法实现">算法实现</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LFUCache</span> </span>&#123;<br>    <span class="hljs-keyword">int</span> minfreq, capacity;<br>    Map&lt;Integer, Node&gt; key_table;<br>    Map&lt;Integer, LinkedList&lt;Node&gt;&gt; freq_table;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">LFUCache</span><span class="hljs-params">(<span class="hljs-keyword">int</span> capacity)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.minfreq = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">this</span>.capacity = capacity;<br>        key_table = <span class="hljs-keyword">new</span> HashMap&lt;Integer, Node&gt;();;<br>        freq_table = <span class="hljs-keyword">new</span> HashMap&lt;Integer, LinkedList&lt;Node&gt;&gt;();<br>    &#125;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">get</span><span class="hljs-params">(<span class="hljs-keyword">int</span> key)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (capacity == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!key_table.containsKey(key)) &#123;<br>            <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<br>        &#125;<br>        Node node = key_table.get(key);<br>        <span class="hljs-keyword">int</span> val = node.val, freq = node.freq;<br>        freq_table.get(freq).remove(node);<br>        <span class="hljs-comment">// 如果当前链表为空，我们需要在哈希表中删除，且更新minFreq</span><br>        <span class="hljs-keyword">if</span> (freq_table.get(freq).size() == <span class="hljs-number">0</span>) &#123;<br>            freq_table.remove(freq);<br>            <span class="hljs-keyword">if</span> (minfreq == freq) &#123;<br>                minfreq += <span class="hljs-number">1</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// 插入到 freq + 1 中</span><br>        LinkedList&lt;Node&gt; list = freq_table.getOrDefault(freq + <span class="hljs-number">1</span>, <span class="hljs-keyword">new</span> LinkedList&lt;Node&gt;());<br>        list.offerFirst(<span class="hljs-keyword">new</span> Node(key, val, freq + <span class="hljs-number">1</span>));<br>        freq_table.put(freq + <span class="hljs-number">1</span>, list);<br>        key_table.put(key, freq_table.get(freq + <span class="hljs-number">1</span>).peekFirst());<br>        <span class="hljs-keyword">return</span> val;<br>    &#125;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">put</span><span class="hljs-params">(<span class="hljs-keyword">int</span> key, <span class="hljs-keyword">int</span> value)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (capacity == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!key_table.containsKey(key)) &#123;<br>            <span class="hljs-comment">// 缓存已满，需要进行删除操作</span><br>            <span class="hljs-keyword">if</span> (key_table.size() == capacity) &#123;<br>                <span class="hljs-comment">// 通过 minFreq 拿到 freq_table[minFreq] 链表的末尾节点</span><br>                Node node = freq_table.get(minfreq).peekLast();<br>                key_table.remove(node.key);<br>                freq_table.get(minfreq).pollLast();<br>                <span class="hljs-keyword">if</span> (freq_table.get(minfreq).size() == <span class="hljs-number">0</span>) &#123;<br>                    freq_table.remove(minfreq);<br>                &#125;<br>            &#125;<br>            LinkedList&lt;Node&gt; list = freq_table.getOrDefault(<span class="hljs-number">1</span>, <span class="hljs-keyword">new</span> LinkedList&lt;Node&gt;());<br>            list.offerFirst(<span class="hljs-keyword">new</span> Node(key, value, <span class="hljs-number">1</span>));<br>            freq_table.put(<span class="hljs-number">1</span>, list);<br>            key_table.put(key, freq_table.get(<span class="hljs-number">1</span>).peekFirst());<br>            minfreq = <span class="hljs-number">1</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 与 get 操作基本一致，除了需要更新缓存的值</span><br>            Node node = key_table.get(key);<br>            <span class="hljs-keyword">int</span> freq = node.freq;<br>            freq_table.get(freq).remove(node);<br>            <span class="hljs-keyword">if</span> (freq_table.get(freq).size() == <span class="hljs-number">0</span>) &#123;<br>                freq_table.remove(freq);<br>                <span class="hljs-keyword">if</span> (minfreq == freq) &#123;<br>                    minfreq += <span class="hljs-number">1</span>;<br>                &#125;<br>            &#125;<br>            LinkedList&lt;Node&gt; list = freq_table.getOrDefault(freq + <span class="hljs-number">1</span>, <span class="hljs-keyword">new</span> LinkedList&lt;Node&gt;());<br>            list.offerFirst(<span class="hljs-keyword">new</span> Node(key, value, freq + <span class="hljs-number">1</span>));<br>            freq_table.put(freq + <span class="hljs-number">1</span>, list);<br>            key_table.put(key, freq_table.get(freq + <span class="hljs-number">1</span>).peekFirst());<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Node</span> </span>&#123;<br>    <span class="hljs-keyword">int</span> key, val, freq;<br><br>    Node(<span class="hljs-keyword">int</span> key, <span class="hljs-keyword">int</span> val, <span class="hljs-keyword">int</span> freq) &#123;<br>        <span class="hljs-keyword">this</span>.key = key;<br>        <span class="hljs-keyword">this</span>.val = val;<br>        <span class="hljs-keyword">this</span>.freq = freq;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h1>Redis过期键删除策略</h1>
<p><strong>Redis中带有过期时间的key是保存在一个字典中（这个字典叫做==过期字典==），以后会定时遍历这个字典，删除过期的key。</strong></p>
<p><strong>检查过期时间：ttl key</strong></p>
<ol>
<li>
<p>查看过期时间 ttl key( 返回值   -1:当前key没有过期时间   &gt;0:当前key的剩余存活时间  -2:当前key不存在)</p>
</li>
<li>
<p>删除过期时间 persist key   把带有过期时间的key变为永久不过期（返回值   1代表删除过期时间成功     0代表当前key没过期时间 or key不存在）</p>

</li>
</ol>
<h2 id="1-定时删除">1.定时删除</h2>
<p>在设置键的过期时间的同时，创建一个定时器（timer），让定时器在键的过期时间来临时，立即执行对键的删除操作。</p>
<ul>
<li><strong>优点</strong>：对内存是最友好的：通过使用定时器，定时删除策略可以保证过期键会尽 可能快地被删除，并释放过期键所占用的内存</li>
<li><strong>缺点</strong>：它对CPU时间是最不友好的：在过期键比较多的情况下，删除过期键这一行为可能会占用相当一部分CPU时间，在内存不紧张但是CPU时间非常紧张的情况下，将CPU时间用在删除和当前任务无关的过期键上，无疑会对服务器的响应时间和吞吐量造成影响创建一个定时器需要用到Redis服务器中的时间事件，而当前时间事件的实现方式——无序链表，查找一个事件的时间复杂度为O(N)——并不能高效地处理大量时间 事件</li>
</ul>
<h2 id="2-惰性删除">2.惰性删除</h2>
<p><strong>每次从键空间获取键时，都检查是否过期，过期则删除，未过期，则返回该键</strong></p>
<p>只有取出键时才对其进行过期检查，不会删除其他键，不会花费CPU太多时间。若一个键早已过期，但一直未被取到，它便会一直占用内存。若有大量的未被访问的键，而服务器又不会主动释放，就会造成大量的内存浪费。</p>

<ul>
<li><strong>优点</strong>：对CPU时间来说是最友好的：程序只会在取出键时才对键进行过期检查，<br>
这可以保证删除过期键的操作只会在非做不可的情况下进行，并且删除的目标仅限于当前处理的键，这个策略不会在删除其他无关的过期键上花费任何CPU时间</li>
<li><strong>缺点</strong>：它对内存是最不友好的：如果一个键已经过期，而这个键又仍 然保留在数据库中，那么只要这个过期键不被删除，它所占用的内存就不会释放。<br>
例如：在使用惰性删除策略时，如果数据库中有非常多的过期键，而这些过期键又恰好没有被访问到的话，那么它们也许永远也不会被删除（除非用户手动执行FLUSHDB），我们甚至可以将这种情况看作是一种内存泄漏——无用的垃圾数据占用了大量的内存，而服务器却不 会自己去释放它们，这对于运行状态非常依赖于内存的Redis服务器来说，肯定不是一个好消息</li>
</ul>
<h3 id="实现原理（expireIfNeeded函数）">实现原理（expireIfNeeded函数）</h3>
<p><strong>expireIfNeeded</strong>函数就像一个<strong>过滤器</strong>，它可以==在命令真正执行之前，过滤掉过期的输入键，从而避免命令接触到过期键== 。惰性删除策略由db.c/expireIfNeeded函数实现，所有读写数据库的Redis命令在执行之前都会调用<strong>expireIfNeeded</strong>函数对输入键进行检查：</p>
<ul>
<li>
<p>如果输入键已经过期，那么expireIfNeeded函数将输入键从数据库中删除</p>
<img src="/dajiangdahe.github.io/2021/10/22/Redis%E5%86%85%E5%AD%98%E7%AD%96%E7%95%A5/20201204131000785.png" class="" title="在这里插入图片描述">
</li>
<li>
<p>如果输入键未过期，那么expireIfNeeded函数不做动作。因为每个被访问的键都可能因为过期而被expireIfNeeded函数删除，所以每个命令的实现函数<strong>都必须能同时处理键存在以及键不存在这两种情况</strong>：</p>
</li>
<li>
<p>当键存在时，命令按照键存在的情况执行</p>
</li>
<li>
<p>当键不存在或者键因为过期而被expireIfNeeded函数删除时，命令按照键不存在的情况执行</p>
</li>
</ul>
<p><strong>举个例子，下图展示了GET命令的执行过程，在这个执行过程中，命令需要判断键是否存在以及键是否过期，然后根据判断来执行合适的动作</strong></p>
<img src="/dajiangdahe.github.io/2021/10/22/Redis%E5%86%85%E5%AD%98%E7%AD%96%E7%95%A5/20201204131056907.png" class="" title="在这里插入图片描述">
<h2 id="3-定期删除">3.定期删除</h2>
<p><strong>每隔一段时间删除里面的过期键</strong></p>
<p>Redis默认会1秒进行10次过期扫描，过期扫描不会遍历字典中所有的key，而是采用一种贪心的策略。</p>
<ol>
<li>从字典中随机选出20个key。</li>
<li>删除这20个key中过期的key。</li>
<li>如果过期的key比例超过1/4，那就在进行步骤1.</li>
<li>同时，为了保证扫描不会出现循环过度，导致线程卡死的现象，算法会设置扫描时间的上限，默认为25ms。</li>
</ol>
<ul>
<li>
<p><strong>优点</strong>：定期删除策略每隔一段时间执行一次删除过期键操作，并通过限制删除操作执行的时长 和频率来减少删除操作对CPU时间的影响。通过定期删除过期键，定期删除策略有效地减少了因为过期键而带来的内存浪费。</p>
</li>
<li>
<p><strong>缺点</strong>：如果删除操作执行得太频繁，或者执行的时间太长，定期删除策略就会退化成定时删除策略，以至于将CPU时间过多地消耗在删除过期键上面。如果删除操作执行得太少，或者执行的时间太短，定期删除策略又会和惰性删除策略一 样，出现浪费内存的情况。</p>
</li>
</ul>
<h3 id="实现原理（activeExpireCycle函数）">实现原理（activeExpireCycle函数）</h3>
<p>过期键的定期删除策略由redis.c/activeExpireCycle函数实现，每当Redis的服务器周期性操作redis.c/serverCron函数执行时，activeExpireCycle函数就会被调用，它在规定的时间内，分多次遍历服务器中的各个数据库，从数据库的expires字典中随机检查一部分键的过期时间，并删除其中的过期键。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#默认每次检查的数据库数量</span><br>DEFAULT_DB_NUMBERS = <span class="hljs-number">16</span><br> <br><span class="hljs-comment">#默认每个数据库检查的键数量</span><br>DEFAULT_KEY_NUMBERS = <span class="hljs-number">20</span><br> <br><span class="hljs-comment">#全局变量，记录检查进度</span><br>current_db = <span class="hljs-number">0</span><br> <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">activeExpireCycle</span>():</span><br>    <span class="hljs-comment"># 初始化要检查的数据库数量</span><br>    <span class="hljs-comment"># 如果服务器的数据库数量比 DEFAULT_DB_NUMBERS 要小</span><br>    <span class="hljs-comment"># 那么以服务器的数据库数量为准</span><br>    <span class="hljs-keyword">if</span> server.dbnum &lt; DEFAULT_DB_NUMBERS:<br>        db_numbers = server.dbnum<br>    <span class="hljs-keyword">else</span>:<br>        db_numbers = DEFAULT_DB_NUMBERS<br> <br>    <span class="hljs-comment"># 遍历各个数据库</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(db_numbers):<br>        <span class="hljs-comment"># 如果current_db 的值等于服务器的数据库数量</span><br>        <span class="hljs-comment"># 这表示检查程序已经遍历了服务器的所有数据库一次</span><br>        <span class="hljs-comment"># 将current_db 重置为0 ，开始新的一轮遍历</span><br>        <span class="hljs-keyword">if</span> current_db == server.dbnum:<br>            current_db = <span class="hljs-number">0</span><br>       <br>        <span class="hljs-comment"># 获取当前要处理的数据库</span><br>        redisDb = server.db[current_db]<br> <br>        <span class="hljs-comment"># 将数据库索引增1 ，指向下一个要处理的数据库</span><br>        current_db += <span class="hljs-number">1</span><br> <br>        <span class="hljs-comment"># 检查数据库键</span><br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(DEFAULT_KEY_NUMBERS):<br>            <span class="hljs-comment"># 如果数据库中没有一个键带有过期时间，那么跳过这个数据库</span><br>            <span class="hljs-keyword">if</span> redisDb.expires.size() == <span class="hljs-number">0</span>: <span class="hljs-keyword">break</span><br>                <span class="hljs-comment">#随机获取一个带有过期时间的键</span><br>                key_with_ttl = redisDb.expires.get_random_key()<br>    <br>                <span class="hljs-comment"># 检查键是否过期，如果过期就删除它</span><br>                <span class="hljs-keyword">if</span> is_expired(key_with_ttl):<br>                    delete_key(key_with_ttl)<br>                <span class="hljs-comment"># 已达到时间上限，停止处理</span><br>                <span class="hljs-keyword">if</span> reach_time_limit(): <span class="hljs-keyword">return</span><br><br></code></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python">DB_NUMBER = <span class="hljs-number">16</span> <span class="hljs-comment"># 数据库数量，默认16（0-15），可以通过配置无限增加</span><br>KEY_NUMBERS = <span class="hljs-number">20</span> <span class="hljs-comment"># 每次检查key的数量</span><br><br>current_db = <span class="hljs-number">0</span> <span class="hljs-comment"># 记录当前检查到哪个库</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">activeExpireCycle</span>():</span><br>  <br>  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(DB_NUMBERS):<br>  <br>    <span class="hljs-keyword">if</span> current_db == DB_BUMBERS:<br>      current_db = <span class="hljs-number">0</span><br><br>    <span class="hljs-comment"># 获取当前数据库</span><br>    redisDB = server.db[current_db]<br>    first_start = <span class="hljs-literal">True</span><br>    del_key_num = <span class="hljs-number">0</span><br>    current_db += <span class="hljs-number">1</span><br><br>    <span class="hljs-keyword">while</span>(first_start <span class="hljs-keyword">or</span> del_key_num &gt; KEY_NUMBERS/<span class="hljs-number">4</span>):<br>      first_start = <span class="hljs-literal">False</span><br>      <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(KEY_NUMBERS):<br>        <br>        _key = redisDB.randomExpireKey()<br>        <span class="hljs-keyword">if</span> is_expire(_key):<br>          <span class="hljs-comment"># 过期 则直接删除</span><br>          delete_key(_key)<br>          del_key_num += <span class="hljs-number">1</span><br><br>        <span class="hljs-keyword">if</span> time_is_limit():<br>          <span class="hljs-comment"># 若执行时间太长，则停止，默认25毫秒</span><br>          <span class="hljs-keyword">return</span><br></code></pre></td></tr></table></figure>
 
      <!-- reward -->
      
      <div id="reword-out">
        <div id="reward-btn">
          打赏
        </div>
      </div>
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>版权声明： </strong>
          
          本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://kengkengya.github.io/dajiangdahe.github.io/2021/10/22/Redis%E5%86%85%E5%AD%98%E7%AD%96%E7%95%A5/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/dajiangdahe.github.io/tags/Redis/" rel="tag">Redis</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/dajiangdahe.github.io/2021/10/22/Redis%E6%8C%81%E4%B9%85%E5%8C%96/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            Redis持久化
          
        </div>
      </a>
    
    
      <a href="/dajiangdahe.github.io/2021/10/22/Redis%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">Redis内存模型</div>
      </a>
    
  </nav>

   
<!-- valine评论 -->
<div id="vcomments-box">
  <div id="vcomments"></div>
</div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script>
<script>
  new Valine({
    el: "#vcomments",
    app_id: "",
    app_key: "",
    path: window.location.pathname,
    avatar: "monsterid",
    placeholder: "给我的文章加点评论吧~",
    recordIP: true,
  });
  const infoEle = document.querySelector("#vcomments .info");
  if (infoEle && infoEle.childNodes && infoEle.childNodes.length > 0) {
    infoEle.childNodes.forEach(function (item) {
      item.parentNode.removeChild(item);
    });
  }
</script>
<style>
  #vcomments-box {
    padding: 5px 30px;
  }

  @media screen and (max-width: 800px) {
    #vcomments-box {
      padding: 5px 0px;
    }
  }

  #vcomments-box #vcomments {
    background-color: #fff;
  }

  .v .vlist .vcard .vh {
    padding-right: 20px;
  }

  .v .vlist .vcard {
    padding-left: 10px;
  }
</style>

 
   
     
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2021
        <i class="ri-heart-fill heart_icon"></i> kengkeng
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/dajiangdahe.github.io/"><img src="/images/ayer-side.svg" alt="kengkeng&#39;s life"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/dajiangdahe.github.io/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/dajiangdahe.github.io/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/dajiangdahe.github.io/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/dajiangdahe.github.io/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/dajiangdahe.github.io/tags/%E6%97%85%E8%A1%8C/">旅行</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" target="_blank" rel="noopener" href="http://shenyu-vip.lofter.com">摄影</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/dajiangdahe.github.io/friends">友链</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/dajiangdahe.github.io/2019/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/dajiangdahe.github.io/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/dajiangdahe.github.io/js/jquery-3.6.0.min.js"></script>
 
<script src="/dajiangdahe.github.io/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/dajiangdahe.github.io/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>

<script src="/dajiangdahe.github.io/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/dajiangdahe.github.io/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/dajiangdahe.github.io/css/clipboard.css">
 <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div>
</body>

</html>